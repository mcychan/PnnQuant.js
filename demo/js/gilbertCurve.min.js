!function(){"use strict";function l(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}Math.clamp||(Math.clamp=function(t,i,s){return this.max(i,this.min(s,t))});const i=t=>(t+1>>>1)-1,s=t=>1+(t<<1),h=t=>t+1<<1;class e{#comparator;#stack=[];constructor(t=null){this.#comparator=t}get(t){return this.#stack[t]}size(){return this.#stack.length}isEmpty(){return 0==this.size()}peek(){return this.#stack[0]}push(...t){return t.forEach(t=>{this.#stack.push(t),null!=this.#comparator&&this.#shiftUp()}),this.size()}shift(){var t,i;if(null!=this.#comparator)return t=this.peek(),0<(i=this.size()-1)&&this.#swap(0,i),this.#stack.pop(),this.#shiftDown(),t;this.#stack.shift()}#greater(t,i){return this.#comparator(this.#stack[t],this.#stack[i])}#swap(t,i){[this.#stack[t],this.#stack[i]]=[this.#stack[i],this.#stack[t]]}#shiftUp(){let t=this.size()-1;for(;0<t&&this.#greater(t,i(t));)this.#swap(t,i(t)),t=i(t)}#shiftDown(){let t=0;for(;s(t)<this.size()&&this.#greater(s(t),t)||h(t)<this.size()&&this.#greater(h(t),t);){var i=(h(t)<this.size()&&this.#greater(h(t),s(t))?h:s)(t);this.#swap(t,i),t=i}}}class A{#width;#height;#weight;#pixels;#palette;#saliencies;#nMaxColors;#beta=1;#qPixels;#qPixel32s;#errorq=[];#weights=[];#BLOCK_SIZE=343;#DITHER_MAX=9;#ditherMax;#dither;#hasAlpha;#sortedByYDiff;#margin;#thresold;constructor(t,i){this.opts=t,this.args=i,this.getColorIndex=this.args.getColorIndex,this.#width=this.opts.width,this.#height=this.opts.height,this.#pixels=this.opts.pixels,this.#palette=new Uint32Array(this.args.pal8),this.ditherFn=this.args.ditherFn,this.#hasAlpha=this.args.weight<0,this.#saliencies=this.args.saliencies,this.#dither=this.opts.dithering,this.#weight=Math.abs(this.args.weight),this.#margin=this.#weight<.0025?12:this.#weight<.004?8:6,this.#nMaxColors=this.#palette.length,this.#sortedByYDiff=128<this.#nMaxColors&&.02<=this.#weight&&(!this.#hasAlpha||this.#weight<.18),this.#errorq=this.#sortedByYDiff?new e((t,i)=>Math.sign(i.yDiff-t.yDiff)):new e;var t=4<this.#nMaxColors?.6-.00625*this.#nMaxColors:1,i=(4<this.#nMaxColors?(i=.005-625e-7*this.#nMaxColors,t=Math.fround(this.#weight>i?.25:Math.min(1.5,t+this.#nMaxColors*this.#weight)),16<this.#nMaxColors&&this.#nMaxColors<=32&&this.#weight<.003?t+=.075:(this.#weight<.0015||32<this.#nMaxColors&&this.#nMaxColors<256)&&(t+=.1),64<=this.#nMaxColors&&.012<this.#weight&&this.#weight<.0125||.025<this.#weight&&this.#weight<.03?t+=.05:32<this.#nMaxColors&&this.#nMaxColors<64&&this.#weight<.015&&(t=.55)):t*=.95,(64<this.#nMaxColors||4<this.#nMaxColors&&.02<this.#weight)&&(t*=.4),64<this.#nMaxColors&&this.#weight<.02&&(t=.18),this.#beta=t,this.#DITHER_MAX=this.#weight<.015?.0025<this.#weight?25:16:9,.99<this.#weight&&(this.#beta=this.#weight,this.#DITHER_MAX=25),this.#hasAlpha?1:Math.exp(this.#weight)-.25),t=!this.#hasAlpha&&.002<this.#weight?-.25:1,t=this.#hasAlpha||9<this.#DITHER_MAX?Math.pow(Math.sqrt(this.#DITHER_MAX)+i*t,2):this.#DITHER_MAX*(null!=this.#saliencies?2:Math.E),s=16<this.#nMaxColors?3200:1500;(5e3<this.#nMaxColors/this.#weight&&(.045<this.#weight||.01<this.#weight&&this.#nMaxColors<64)||this.#weight<.03&&this.#palette.length/this.#weight<s&&16<=this.#nMaxColors&&this.#nMaxColors<256)&&(t=Math.pow(5+i,2)),this.#ditherMax=0|t,this.#thresold=9<this.#DITHER_MAX?-112:-64}#Y_Diff(t,i,s,h,e,a){function r(t,i,s){return.2126*l(t)+.7152*l(i)+.0722*l(s)}t=r(t,i,s),i=r(h,e,a);return 100*Math.abs(i-t)}#U_Diff(t,i,s,h,e,a){function r(t,i,s){return-.09991*t-.33609*i+.436*s}t=r(t,i,s),i=r(h,e,a);return Math.abs(i-t)}static ErrorBox=class{constructor(t){var i=255&t,s=t>>>8&255,h=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[i,s,h,t]}};#normalDistribution(t,i){var t=-Math.pow(t-.5,2)/(2*Math.pow(.1,2)),t=1/(.1*Math.sqrt(2*Math.PI))*Math.exp(t),s=1/(.1*Math.sqrt(2*Math.PI));return Math.fround(Math.max(0,Math.min(i,t/s*i)))}#ditherPixel(t,i,s,h){var e,a,r=this.ditherFn,l=t+i*this.#width,n=this.#pixels[l],o=255&n,f=n>>>8&255,g=n>>>16&255,p=255&s,M=s>>>8&255,x=s>>>16&255,w=s>>>24&255,d=this.#palette[this.#qPixels[l]],u=Math.max(2,this.#nMaxColors-this.#margin),c=(this.#nMaxColors<=4&&.2<this.#saliencies[l]&&this.#saliencies[l]<.25?s=new BlueNoise(null,{weightB:2*h/this.#saliencies[l]}).diffuse(n,d,1/3,t,i):(this.#nMaxColors<=4||this.#Y_Diff(o,f,g,p,M,x)<2*u)&&((this.#nMaxColors<=128||0<BlueNoise.TELL_BLUE_NOISE[4095&l])&&(e=this.#saliencies[l]<.6?.15*h/this.#saliencies[l]:.4*h/this.#saliencies[l],s=new BlueNoise(null,{weightB:e}).diffuse(n,d,1/3,t,i)),c=255&(s=this.#U_Diff(o,f,g,c=255&s,D=s>>>8&255,C=s>>>16&255)>this.#margin*u?new BlueNoise(null,{weightB:h/this.#saliencies[l]}).diffuse(n,d,1/3,t,i):s),D=s>>>8&255,C=s>>>16&255),255&s),D=s>>>8&255,C=s>>>16&255;return 6<this.#margin||this.#nMaxColors<=32&&this.#weight<.01&&.007<this.#weight?4<this.#nMaxColors&&this.#Y_Diff(o,f,g,c,D,C)>h*u&&(e=this.#saliencies[l]<.4?.4*h*this.#saliencies[l]:.4*h/this.#saliencies[l],a=w<<24|x<<16|M<<8|p,32<this.#nMaxColors&&this.#saliencies[l]<.9?e=h*this.#normalDistribution(h,2)*this.#saliencies[l]:(.0015<=this.#weight&&this.#saliencies[l]<.6&&(a=n),this.#saliencies[l]<.6?e=h*this.#normalDistribution(h,this.#weight<8e-4?2.5:1.75)*this.#saliencies[l]:(32<=this.#nMaxColors||this.#Y_Diff(p,M,x,c,D,C)>h*Math.PI*u)&&(e=this.#saliencies[l]<.9?h*(!this.#sortedByYDiff&&this.#weight<.0025?.55:.5)/this.#saliencies[l]:h*this.#normalDistribution(h,!this.#sortedByYDiff&&this.#weight<.0025?.55:.5)/this.#saliencies[l])),c=255&(s=new BlueNoise(null,{weightB:e}).diffuse(a,d,1/3,t,i)),D=s>>>8&255,C=s>>>16&255,0):4<this.#nMaxColors&&(this.#Y_Diff(o,f,g,c,D,C)>h*u||this.#U_Diff(o,f,g,c,D,C)>u)&&(c=255&(s=h<.4&&(this.#nMaxColors<=32||this.#saliencies[l]<h)?new BlueNoise(null,{weightB:.4*h*this.#saliencies[l]}).diffuse(s,d,1/3,t,i):w<<24|x<<16|M<<8|p),D=s>>>8&255,C=s>>>16&255,0),this.#DITHER_MAX<16&&4<this.#nMaxColors&&this.#saliencies[l]<.6&&this.#Y_Diff(o,f,g,c,D,C)>this.#margin-1&&(s=w<<24|x<<16|M<<8|p,c=p,D=M,C=x,0),1<h&&this.#Y_Diff(o,f,g,c,D,C)>this.#DITHER_MAX&&(s=w<<24|x<<16|M<<8|p),r(this.#palette,s,l)}#diffusePixel(t,i){for(var s=this.ditherFn,h=t+i*this.#width,e=this.#pixels[h],a=new A.ErrorBox(e),r=this.#DITHER_MAX-1,l=this.#sortedByYDiff?this.#weights.length-1:0,n=0;n<this.#errorq.size();++n){var o=this.#errorq.get(n);if(l<0||l>=this.#weights.length)break;for(var f=0;f<o.p.length;++f)a.p[f]+=o.p[f]*this.#weights[l],a.p[f]>r&&(r=a.p[f]);l+=this.#sortedByYDiff?-1:1}for(var g,p=0|Math.clamp(a.p[0],0,255),M=0|Math.clamp(a.p[1],0,255),x=0|Math.clamp(a.p[2],0,255),w=0|Math.clamp(a.p[3],0,255),d=255&e,u=e>>>8&255,c=e>>>16&255,D=w<<24|x<<16|M<<8|p,C=(null!=this.#saliencies&&this.#dither&&!this.#sortedByYDiff&&(!this.#hasAlpha||(e>>>24&255)<w)?32<this.#nMaxColors&&.99<this.#saliencies[h]?this.#qPixels[h]=s(this.#palette,D,h):this.#qPixels[h]=this.#ditherPixel(t,i,D,this.#beta):this.#nMaxColors<=32&&240<w?(this.#qPixels[h]=s(this.#palette,D,h),C=Math.max(2,this.#nMaxColors-this.#margin),null!=this.#saliencies&&(this.#Y_Diff(d,u,c,p,M,x)>C||this.#U_Diff(d,u,c,p,M,x)>2*C)&&(g=1/3,D=new BlueNoise(null,{weightB:1/this.#saliencies[h]}).diffuse(e,this.#palette[this.#qPixels[h]],g,t,i),this.#qPixels[h]=s(this.#palette,D,h))):this.#qPixels[h]=s(this.#palette,D,h),this.#errorq.size()>=this.#DITHER_MAX?this.#errorq.shift():this.#errorq.isEmpty()||this.#initWeights(this.#errorq.size()),255&(D=this.#palette[this.#qPixels[h]])),B=D>>>8&255,m=D>>>16&255,_=D>>>24&255,w=(a.p[0]=p-C,a.p[1]=M-B,a.p[2]=x-m,a.p[3]=w-_,2<this.#palette.length),q=BlueNoise.TELL_BLUE_NOISE[4095&h]>this.#thresold,P=(a.yDiff=this.#sortedByYDiff?this.#Y_Diff(d,u,c,C,B,m):1,!q&&BlueNoise.TELL_BLUE_NOISE[4095&(4096*a.yDiff|0)]>this.#thresold),E=!1,y=w?a.p.length-1:0,f=0;f<y;++f)Math.abs(a.p[f])>=this.#ditherMax&&(this.#sortedByYDiff&&null!=this.#saliencies&&(E=!0),q?a.p[f]=Math.fround(Math.tanh(a.p[f]/r*20))*(this.#ditherMax-1):P?a.p[f]=Math.fround(a.p[f]/r*a.yDiff)*(this.#ditherMax-1):a.p[f]/=Math.fround(1+Math.sqrt(this.#ditherMax))),this.#sortedByYDiff&&null==this.#saliencies&&Math.abs(a.p[f])>=this.#DITHER_MAX&&(E=!0);E&&(null!=this.#saliencies?this.#qPixels[h]=this.#ditherPixel(t,i,D,this.#beta):3<this.#Y_Diff(d,u,c,p,M,x)&&3<this.#U_Diff(d,u,c,p,M,x)&&(g=1/3,D=new BlueNoise(null,{weightB:g}).diffuse(e,this.#palette[this.#qPixels[h]],g,t,i),this.#qPixels[h]=s(this.#palette,D,h))),this.#errorq.push(a),this.#qPixel32s[h]=this.#palette[this.#qPixels[h]]}#generate2d(t,i,s,h,e,a){var r=Math.abs(s+h),l=Math.abs(e+a),n=Math.sign(s),o=Math.sign(h),f=Math.sign(e),g=Math.sign(a);if(1==l)for(var p=0;p<r;++p)this.#diffusePixel(t,i),t+=n,i+=o;else if(1==r)for(p=0;p<l;++p)this.#diffusePixel(t,i),t+=f,i+=g;else{var M=s>>1,x=h>>1,w=e>>1,d=a>>1,u=Math.abs(M+x),c=Math.abs(w+d);3*l<2*r?(u%2!=0&&2<r&&(M+=n,x+=o),this.#generate2d(t,i,M,x,e,a),this.#generate2d(t+M,i+x,s-M,h-x,e,a)):(c%2!=0&&2<l&&(w+=f,d+=g),this.#generate2d(t,i,w,d,M,x),this.#generate2d(t+w,i+d,s,h,e-w,a-d),this.#generate2d(t+(s-n)+(w-f),i+(h-o)+(d-g),-w,-d,-(s-M),-(h-x)))}}#initWeights(t){var i=Math.fround(Math.pow(this.#BLOCK_SIZE+1,1/(t-1))),s=1,h=0;this.#weights=new Array(t);for(var e=0;e<t;++e)this.#errorq.push(new A.ErrorBox(0)),h+=this.#weights[t-e-1]=s,s/=i;for(s=0,e=0;e<t;++e)this.#weights[e]=Math.fround(this.#weights[e]/h),s+=this.#weights[e];this.#weights[0]+=Math.fround(1-s)}dither(){return this.#qPixels=new(256<this.#nMaxColors?Uint16Array:Uint8Array)(this.#pixels.length),this.#qPixel32s=new Uint32Array(this.#qPixels.length),this.#sortedByYDiff||this.#initWeights(this.#DITHER_MAX),this.#width>=this.#height?this.#generate2d(0,0,this.#width,0,0,this.#height):this.#generate2d(0,0,0,this.#height,this.#width,0),this.opts.dithering||this.opts.colors<=32?this.#qPixel32s:this.#qPixels}getIndexedPixels(){return this.#qPixels}getResult(){var s=this;return new Promise(function(t,i){s.opts.dithering||s.opts.colors<=32?t({img8:s.dither(),indexedPixels:s.getIndexedPixels(),pal8:s.args.pal8,transparent:s.args.transparent,type:s.args.type}):t({indexedPixels:s.dither(),pal8:s.args.pal8,transparent:s.args.transparent,type:s.args.type})})}}this.GilbertCurve=A,"undefined"!=typeof module&&module.exports&&(module.exports=A)}.call(this);