!function(){"use strict";function l(i){i/=255;return i<.04045?i/12.92:Math.pow((.055+i)/1.055,2.4)}Math.clamp||(Math.clamp=function(i,t,s){return this.max(t,this.min(s,i))});class I{#width;#height;#weight;#pixels;#palette;#saliencies;#nMaxColors;#beta=1;#qPixels;#qPixel32s;#errorq=[];#weights=[];#lookup;#BLOCK_SIZE=343;#DITHER_MAX=9;#ditherMax;#dither;#hasAlpha;#sortedByYDiff;#margin;#thresold;constructor(i,t){this.opts=i,this.args=t,this.ditherFn=this.args.ditherFn,this.getColorIndex=this.args.getColorIndex,this.#width=this.opts.width,this.#height=this.opts.height,this.#pixels=this.opts.pixels,this.#palette=new Uint32Array(this.args.pal8),this.#saliencies=this.args.saliencies,this.#dither=this.opts.dithering,this.#nMaxColors=this.#palette.length,this.#hasAlpha=this.args.weight<0,this.#weight=Math.abs(this.args.weight),this.#margin=this.#weight<.0025?12:this.#weight<.004?8:6,this.#sortedByYDiff=128<=this.#nMaxColors&&.02<=this.#weight&&(!this.#hasAlpha||this.#weight<.18),this.#ditherMax=this.#DITHER_MAX=this.#weight<.015?.0025<this.#weight?25:16:9,this.#thresold=9<this.#DITHER_MAX?-112:-64,this.#lookup=new Uint16Array(65536)}#Y_Diff(i,t,s,h,e,a){function r(i,t,s){return.2126*l(i)+.7152*l(t)+.0722*l(s)}i=r(i,t,s),t=r(h,e,a);return 100*Math.abs(t-i)}#U_Diff(i,t,s,h,e,a){function r(i,t,s){return-.09991*i-.33609*t+.436*s}i=r(i,t,s),t=r(h,e,a);return Math.abs(t-i)}static ErrorBox=class{constructor(i){var t=255&i,s=i>>>8&255,h=i>>>16&255,i=i>>>24&255;this.yDiff=0,this.p=[t,s,h,i]}};#normalDistribution(i,t){var i=-Math.pow(i-.5,2)/(2*Math.pow(.1,2)),i=1/(.1*Math.sqrt(2*Math.PI))*Math.exp(i),s=1/(.1*Math.sqrt(2*Math.PI));return Math.fround(Math.max(0,Math.min(t,i/s*t)))}#ditherPixel(i,t,s,h){var e,a,{ditherFn:r,getColorIndex:l}=this,n=i+t*this.#width,o=this.#pixels[n],f=255&o,g=o>>>8&255,M=o>>>16&255,x=255&s,p=s>>>8&255,d=s>>>16&255,u=s>>>24&255,w=this.#palette[this.#qPixels[n]],c=Math.max(2,this.#nMaxColors-this.#margin),D=(this.#nMaxColors<=4&&.2<this.#saliencies[n]&&this.#saliencies[n]<.25?s=new BlueNoise(null,{weightB:2*h/this.#saliencies[n]}).diffuse(o,w,1/3,i,t):(this.#nMaxColors<=4||this.#Y_Diff(f,g,M,x,p,d)<2*c)&&(D=255&(s=this.#nMaxColors<=128||0<BlueNoise.TELL_BLUE_NOISE[4095&n]?new BlueNoise(null,{weightB:.5*h/this.#saliencies[n]}).diffuse(o,w,1/3,i,t):s),D=255&(s=this.#U_Diff(f,g,M,D,C=s>>>8&255,B=s>>>16&255)>this.#margin*c?new BlueNoise(null,{weightB:h/this.#saliencies[n]}).diffuse(o,w,1/3,i,t):s),C=s>>>8&255,B=s>>>16&255),255&s),C=s>>>8&255,B=s>>>16&255,q=s>>>24&255,o=(6<this.#margin||this.#nMaxColors<=32&&.007<this.#weight?4<this.#nMaxColors&&this.#Y_Diff(f,g,M,D,C,B)>h*c&&(e=this.#saliencies[n]<.4?.4*h*this.#saliencies[n]:.4*h/this.#saliencies[n],a=u<<24|d<<16|p<<8|x,32<this.#nMaxColors&&this.#saliencies[n]<.9?e=h*this.#normalDistribution(h,2)*this.#saliencies[n]:(.0015<=this.#weight&&this.#saliencies[n]<.6&&(a=o),this.#saliencies[n]<.6?e=h*this.#normalDistribution(h,this.#weight<8e-4?2.5:1.75)*this.#saliencies[n]:(32<=this.#nMaxColors||this.#Y_Diff(x,p,d,D,C,B)>h*Math.PI*c)&&(e=this.#saliencies[n]<.9?h*(!this.#sortedByYDiff&&this.#weight<.0025?.55:.5)/this.#saliencies[n]:h*this.#normalDistribution(h,!this.#sortedByYDiff&&this.#weight<.0025?.55:.5)/this.#saliencies[n])),D=255&(s=new BlueNoise(null,{weightB:e}).diffuse(a,w,1/3,i,t)),C=s>>>8&255,B=s>>>16&255,q=s>>>24&255):4<this.#nMaxColors&&(this.#Y_Diff(f,g,M,D,C,B)>h*c||this.#U_Diff(f,g,M,D,C,B)>c)&&(D=255&(s=h<.4&&(this.#nMaxColors<=32||this.#saliencies[n]<h)?new BlueNoise(null,{weightB:.4*h*this.#saliencies[n]}).diffuse(s,w,1/3,i,t):u<<24|d<<16|p<<8|x),C=s>>>8&255,B=s>>>16&255,q=s>>>24&255),this.#DITHER_MAX<16&&4<this.#nMaxColors&&this.#saliencies[n]<.6&&this.#Y_Diff(f,g,M,D,C,B)>this.#margin-1&&(s=u<<24|d<<16|p<<8|x,D=x,C=p,B=d,q=u),1<h&&this.#Y_Diff(f,g,M,D,C,B)>this.#DITHER_MAX&&(s=u<<24|d<<16|p<<8|x,D=x,C=p,B=d,q=u),l(q,D,C,B));return 0==this.#lookup[o]&&(this.#lookup[o]=r(this.#palette,s,n)+1),this.#lookup[o]-1}#diffusePixel(i,t){for(var{ditherFn:s,getColorIndex:h}=this,e=i+t*this.#width,a=this.#pixels[e],r=new I.ErrorBox(a),l=this.#sortedByYDiff?this.#weights.length-1:0,n=this.#DITHER_MAX-1,o=0;o<this.#errorq.length;++o){var f=this.#errorq[o];if(l<0||l>=this.#weights.length)break;for(var g=0;g<f.p.length;++g)r.p[g]+=f.p[g]*this.#weights[l],r.p[g]>n&&(n=r.p[g]);l+=this.#sortedByYDiff?-1:1}for(var M,x=0|Math.clamp(r.p[0],0,255),p=0|Math.clamp(r.p[1],0,255),d=0|Math.clamp(r.p[2],0,255),u=0|Math.clamp(r.p[3],0,255),w=255&a,c=a>>>8&255,D=a>>>16&255,C=u<<24|d<<16|p<<8|x,h=(null!=this.#saliencies&&this.#dither&&!this.#sortedByYDiff&&(!this.#hasAlpha||(a>>>24&255)<u)?32<this.#nMaxColors&&.99<this.#saliencies[e]?this.#qPixels[e]=s(this.#palette,C,e):this.#qPixels[e]=this.#ditherPixel(i,t,C,this.#beta):this.#nMaxColors<=32&&240<u?(h=h(u,x,p,d),0==this.#lookup[h]&&(this.#lookup[h]=s(this.#palette,C,e)+1),this.#qPixels[e]=this.#lookup[h]-1,h=Math.max(2,this.#nMaxColors-this.#margin),null!=this.#saliencies&&(this.#Y_Diff(w,c,D,x,p,d)>h||this.#U_Diff(w,c,D,x,p,d)>2*h)&&(M=1/3,C=new BlueNoise(null,{weightB:1/this.#saliencies[e]}).diffuse(a,this.#palette[this.#qPixels[e]],M,i,t),this.#qPixels[e]=s(this.#palette,C,e))):this.#qPixels[e]=s(this.#palette,C,e),this.#errorq.length>=this.#DITHER_MAX?this.#errorq.shift():0<this.#errorq.length&&this.#initWeights(this.#errorq.length),255&(C=this.#palette[this.#qPixels[e]])),B=C>>>8&255,q=C>>>16&255,P=C>>>24&255,u=(r.p[0]=x-h,r.p[1]=p-B,r.p[2]=d-q,r.p[3]=u-P,2<this.#palette.length),_=BlueNoise.TELL_BLUE_NOISE[4095&e]>this.#thresold,y=(r.yDiff=this.#sortedByYDiff?this.#Y_Diff(w,c,D,h,B,q):1,!_&&BlueNoise.TELL_BLUE_NOISE[4095&(4096*r.yDiff|0)]>this.#thresold),m=!1,E=u?r.p.length-1:0,g=0;g<E;++g)Math.abs(r.p[g])>=this.#ditherMax&&(this.#sortedByYDiff&&null!=this.#saliencies&&(m=!0),_?r.p[g]=Math.fround(Math.tanh(r.p[g]/n*20))*(this.#ditherMax-1):y?r.p[g]=Math.fround(r.p[g]/n*r.yDiff)*(this.#ditherMax-1):r.p[g]/=Math.fround(1+Math.sqrt(this.#ditherMax))),this.#sortedByYDiff&&null==this.#saliencies&&Math.abs(r.p[g])>=this.#DITHER_MAX&&(m=!0);m&&(null!=this.#saliencies?this.#qPixels[e]=this.#ditherPixel(i,t,C,1.25):3<this.#Y_Diff(w,c,D,x,p,d)&&3<this.#U_Diff(w,c,D,x,p,d)&&(M=1/3,C=new BlueNoise(null,{weightB:M}).diffuse(a,this.#palette[this.#qPixels[e]],M,i,t),this.#qPixels[e]=s(this.#palette,C,e))),this.#errorq.push(r),this.#sortedByYDiff&&this.#errorq.sort(function(i,t){return t.yDiff<i.yDiff?-1:i.yDiff<t.yDiff?1:0}),this.#qPixel32s[e]=this.#palette[this.#qPixels[e]]}#generate2d(i,t,s,h,e,a){var r=Math.abs(s+h),l=Math.abs(e+a),n=Math.sign(s),o=Math.sign(h),f=Math.sign(e),g=Math.sign(a);if(1==l)for(var M=0;M<r;++M)this.#diffusePixel(i,t),i+=n,t+=o;else if(1==r)for(M=0;M<l;++M)this.#diffusePixel(i,t),i+=f,t+=g;else{var x=s>>1,p=h>>1,d=e>>1,u=a>>1,w=Math.abs(x+p),c=Math.abs(d+u);3*l<2*r?(w%2!=0&&2<r&&(x+=n,p+=o),this.#generate2d(i,t,x,p,e,a),this.#generate2d(i+x,t+p,s-x,h-p,e,a)):(c%2!=0&&2<l&&(d+=f,u+=g),this.#generate2d(i,t,d,u,x,p),this.#generate2d(i+d,t+u,s,h,e-d,a-u),this.#generate2d(i+(s-n)+(d-f),t+(h-o)+(u-g),-d,-u,-(s-x),-(h-p)))}}#initWeights(i){var t=Math.fround(Math.pow(this.#BLOCK_SIZE+1,1/(i-1))),s=1,h=0;this.#weights=new Array(i);for(var e=0;e<i;++e)this.#errorq.push(new I.ErrorBox(0)),h+=this.#weights[i-e-1]=s,s/=t;for(s=0,e=0;e<i;++e)this.#weights[e]=Math.fround(this.#weights[e]/h),s+=this.#weights[e];this.#weights[0]+=Math.fround(1-s)}dither(){var i=this.#hasAlpha?1:Math.exp(this.#weight)-.25,t=!this.#hasAlpha&&.002<this.#weight?-.25:1,t=this.#hasAlpha||9<this.#DITHER_MAX?Math.pow(Math.sqrt(this.#DITHER_MAX)+i*t,2):this.#DITHER_MAX*(null!=this.#saliencies?2:Math.E),s=16<this.#nMaxColors?3200:1500,s=((5e3<this.#nMaxColors/this.#weight&&(.045<this.#weight||.01<this.#weight&&this.#nMaxColors<64)||this.#weight<.03&&this.#palette.length/this.#weight<s&&16<=this.#nMaxColors&&this.#nMaxColors<256)&&(t=Math.pow(5+i,2)),this.#ditherMax=0|t,4<this.#nMaxColors?.6-.00625*this.#nMaxColors:1);return 4<this.#nMaxColors?(i=.005-625e-7*this.#nMaxColors,s=Math.fround(this.#weight>i?.25:Math.min(1.5,s+this.#nMaxColors*this.#weight)),16<this.#nMaxColors&&this.#nMaxColors<=32&&this.#weight<.003?s+=.075:(this.#weight<.0015||32<this.#nMaxColors&&this.#nMaxColors<256)&&(s+=.1),64<=this.#nMaxColors&&.012<this.#weight&&this.#weight<.0125||.025<this.#weight&&this.#weight<.03?s*=2:32<this.#nMaxColors&&this.#nMaxColors<64&&this.#weight<.015&&(s=.55)):s*=.95,(64<this.#nMaxColors||4<this.#nMaxColors&&.02<this.#weight)&&(s*=.4),64<this.#nMaxColors&&this.#weight<.02&&(s=.2),this.#beta=s,this.#qPixels=new(256<this.#nMaxColors?Uint16Array:Uint8Array)(this.#pixels.length),this.#qPixel32s=new Uint32Array(this.#qPixels.length),this.#sortedByYDiff||this.#initWeights(this.#DITHER_MAX),this.#width>=this.#height?this.#generate2d(0,0,this.#width,0,0,this.#height):this.#generate2d(0,0,0,this.#height,this.#width,0),this.opts.dithering||this.opts.colors<=32?this.#qPixel32s:this.#qPixels}getIndexedPixels(){return this.#qPixels}getResult(){var s=this;return new Promise(function(i,t){s.opts.dithering||s.opts.colors<=32?i({img8:s.dither(),indexedPixels:s.getIndexedPixels(),pal8:s.args.pal8,transparent:s.args.transparent,type:s.args.type}):i({indexedPixels:s.dither(),pal8:s.args.pal8,transparent:s.args.transparent,type:s.args.type})})}}this.GilbertCurve=I,"undefined"!=typeof module&&module.exports&&(module.exports=I)}.call(this);