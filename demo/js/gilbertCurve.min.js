!function(){"use strict";function t(t,e){this.opts=t,this.args=e}function s(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function L(t,e,n,a,r,i){function h(t,e,n){return.2126*s(t)+.7152*s(e)+.0722*s(n)}t=h(t,e,n),e=h(a,r,i);return 100*Math.abs(e-t)}function D(t,e,n,a,r,i){function h(t,e,n){return-.09991*t-.33609*e+.436*n}t=h(t,e,n),e=h(a,r,i);return Math.abs(e-t)}function P(t){var e=255&t,n=t>>>8&255,a=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,n,a,t]}Math.tanh||(Math.tanh=function(t){var e=Math.exp(+t),t=Math.exp(-t);return e==1/0?1:t==1/0?-1:(e-t)/(e+t)});var U,A,_,r,B,q,O,S,T,C,k,F,G,R,j,z,H,J,K=[],Q=[],V=9,i=343;function m(t,e){var t=-Math.pow(t-.5,2)/(2*Math.pow(.1,2)),t=1/(.1*Math.sqrt(2*Math.PI))*Math.exp(t),n=1/(.1*Math.sqrt(2*Math.PI));return Math.fround(Math.max(0,Math.min(e,t/n*e)))}function W(t,e,n,a){var r,i,h=t+e*_,s=q[h],u=255&s,o=s>>>8&255,l=s>>>16&255,f=255&n,p=n>>>8&255,M=n>>>16&255,g=n>>>24&255,d=O[k[h]],w=Math.max(2,T-H),c=(T<=4&&.2<S[h]&&S[h]<.25?n=new BlueNoise(null,{weightB:2*a/S[h]}).diffuse(s,d,1/3,t,e):(T<=4||L(u,o,l,f,p,M)<2*w)&&(c=255&(n=D(u,o,l,c=255&(n=T<=128||0<TELL_BLUE_NOISE[4095&h]?new BlueNoise(null,{weightB:.5*a/S[h]}).diffuse(s,d,1/3,t,e):n),y=n>>>8&255,x=n>>>16&255)>H*w?new BlueNoise(null,{weightB:a/S[h]}).diffuse(s,d,1/3,t,e):n),y=n>>>8&255,x=n>>>16&255),255&n),y=n>>>8&255,x=n>>>16&255,v=n>>>24&255,s=(T<3||6<H?4<T&&L(u,o,l,c,y,x)>a*w&&(r=S[h]<.4?.4*a*S[h]:.4*a/S[h],i=g<<24|M<<16|p<<8|f,32<T?r=a*m(a,2)*S[h]:(.0015<=B&&S[h]<.6&&(i=s),S[h]<.6?r=a*m(a,1.75)*S[h]:L(f,p,M,c,y,x)>a*Math.PI*w&&(r=a*(!z&&B<.0025?.55:.5)/S[h])),c=255&(n=new BlueNoise(null,{weightB:r}).diffuse(i,d,1/3,t,e)),y=n>>>8&255,x=n>>>16&255,v=n>>>24&255):4<T&&(L(u,o,l,c,y,x)>a*w||D(u,o,l,c,y,x)>w)&&(c=255&(n=a<.4&&(T<=32||S[h]<a)?new BlueNoise(null,{weightB:.4*a*S[h]}).diffuse(n,d,1/3,t,e):g<<24|M<<16|p<<8|f),y=n>>>8&255,x=n>>>16&255,v=n>>>24&255),V<16&&4<T&&S[h]<.6&&L(u,o,l,c,y,x)>H-1&&(n=g<<24|M<<16|p<<8|f,c=f,y=p,x=M,v=g),1<a&&L(u,o,l,c,y,x)>V&&(n=g<<24|M<<16|p<<8|f,c=f,y=p,x=M,v=g),A(v,c,y,x));return 0==F[s]&&(F[s]=U(O,n,h)+1),F[s]-1}function x(t,e){for(var n=t+e*_,a=q[n],r=new P(a),i=z?Q.length-1:0,h=V-1,s=0;s<K.length;++s){var u=K[s];if(i<0||i>=Q.length)break;for(var o=0;o<u.p.length;++o)r.p[o]+=u.p[o]*Q[i],r.p[o]>h&&(h=r.p[o]);i+=z?-1:1}for(var l,f=0|Math.clamp(r.p[0],0,255),p=0|Math.clamp(r.p[1],0,255),M=0|Math.clamp(r.p[2],0,255),g=0|Math.clamp(r.p[3],0,255),d=255&a,w=a>>>8&255,c=a>>>16&255,y=g<<24|M<<16|p<<8|f,x=(null!=S&&R&&!z&&(!j||(a>>>24&255)<g)?32<T&&.99<S[n]?k[n]=U(O,y,n):k[n]=W(t,e,y,C):T<=32&&240<g?(x=A(g,f,p,M),0==F[x]&&(F[x]=U(O,y,n)+1),k[n]=F[x]-1,x=Math.max(2,T-H),null!=S&&(L(d,w,c,f,p,M)>x||D(d,w,c,f,p,M)>2*x)&&(l=1/3,y=new BlueNoise(null,{weightB:1/S[n]}).diffuse(a,O[k[n]],l,t,e),k[n]=U(O,y,n))):k[n]=U(O,y,n),K.length>=V?K.shift():0<K.length&&X(K.length),255&(y=O[k[n]])),v=y>>>8&255,B=y>>>16&255,m=y>>>24&255,g=(r.p[0]=f-x,r.p[1]=p-v,r.p[2]=M-B,r.p[3]=g-m,2<O.length),b=TELL_BLUE_NOISE[4095&n]>J,E=(r.yDiff=z?L(d,w,c,x,v,B):1,!b&&TELL_BLUE_NOISE[4095&(4096*r.yDiff|0)]>J),N=!1,I=g?r.p.length-1:0,o=0;o<I;++o)Math.abs(r.p[o])>=G&&(z&&null!=S&&(N=!0),b?r.p[o]=Math.fround(Math.tanh(r.p[o]/h*20))*(G-1):E?r.p[o]=Math.fround(r.p[o]/h*r.yDiff)*(G-1):r.p[o]/=Math.fround(1+Math.sqrt(G))),z&&null==S&&Math.abs(r.p[o])>=V&&(N=!0);N&&(null!=S?k[n]=W(t,e,y,1.25):3<L(d,w,c,f,p,M)&&3<D(d,w,c,f,p,M)&&(l=1/3,y=new BlueNoise(null,{weightB:l}).diffuse(a,O[k[n]],l,t,e),k[n]=U(O,y,n))),K.push(r),z&&K.sort(function(t,e){return e.yDiff<t.yDiff?-1:t.yDiff<e.yDiff?1:0})}function v(t,e,n,a,r,i){var h=Math.abs(n+a),s=Math.abs(r+i),u=Math.sign(n),o=Math.sign(a),l=Math.sign(r),f=Math.sign(i);if(1==s)for(var p=0;p<h;++p)x(t,e),t+=u,e+=o;else if(1==h)for(p=0;p<s;++p)x(t,e),t+=l,e+=f;else{var M=n>>1,g=a>>1,d=r>>1,w=i>>1,c=Math.abs(M+g),y=Math.abs(d+w);3*s<2*h?(c%2!=0&&2<h&&(M+=u,g+=o),v(t,e,M,g,r,i),v(t+M,e+g,n-M,a-g,r,i)):(y%2!=0&&2<s&&(d+=l,w+=f),v(t,e,d,w,M,g),v(t+d,e+w,n,a,r-d,i-w),v(t+(n-u)+(d-l),e+(a-o)+(w-f),-d,-w,-(n-M),-(a-g)))}}function X(t){var e=Math.fround(Math.pow(i+1,1/(t-1))),n=1,a=0;Q=new Array(t);for(var r=0;r<t;++r)K.push(new P(0)),a+=Q[t-r-1]=n,n/=e;for(n=0,r=0;r<t;++r)Q[r]=Math.fround(Q[r]/a),n+=Q[r];Q[0]+=Math.fround(1-n)}t.prototype.dither=function(){U=this.args.ditherFn,A=this.args.getColorIndex,_=this.opts.width,r=this.opts.height,q=this.opts.pixels,O=new Uint32Array(this.args.pal8),S=this.args.saliencies,R=this.opts.dithering,T=O.length,K=[],j=this.args.weight<0,B=Math.abs(this.args.weight),H=B<.0025?12:B<.004?8:6,z=128<=T&&.02<=B&&(!j||B<.18),V=B<.015?.0025<B?25:16:9;var t=j?1:Math.exp(B)-.25,e=!j&&.002<B?-.25:1,e=(G=j||9<V?Math.pow(Math.sqrt(V)+t*e,2):V*(null!=S?2:Math.E),16<T?3200:1500);if((5e3<T/B&&(.045<B||.01<B&&T<64)||B<.03&&O.length/B<e&&16<=T&&T<256)&&(G=Math.pow(5+t,2)),G|=0,J=9<V?-112:-64,Q=[],F=new Uint16Array(65536),C=4<T?.6-.00625*T:1,4<T?(e=.005-625e-7*T,C=Math.fround(e<B?.25:Math.min(1.5,C+T*B)),16<T&&T<=32&&B<.003?C+=.075:(B<.0015||32<T&&T<256)&&(C+=.1),(64<=T&&.012<B&&B<.0125||.025<B&&B<.03)&&(C*=2)):C*=.95,(64<T||4<T&&.02<B)&&(C*=.4),64<T&&B<.02&&(C=.2),k=new(256<T?Uint16Array:Uint8Array)(q.length),z||X(V),r<=_?v(0,0,_,0,0,r):v(0,0,0,r,_,0),this.opts.dithering){for(var n=new Uint32Array(k.length),a=0;a<k.length;++a)n[a]=O[k[a]];return n}return k},t.prototype.getIndexedPixels=function(){return k},t.prototype.getResult=function(){var n=this;return new Promise(function(t,e){n.opts.dithering||n.opts.colors<=32?t({img8:n.dither(),indexedPixels:n.getIndexedPixels(),pal8:n.args.pal8,transparent:n.args.transparent,type:n.args.type}):t({indexedPixels:n.dither(),pal8:n.args.pal8,transparent:n.args.transparent,type:n.args.type})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);