!function(){"use strict";function l(i){i/=255;return i<.04045?i/12.92:Math.pow((.055+i)/1.055,2.4)}Math.clamp||(Math.clamp=function(i,t,s){return this.max(t,this.min(s,i))});class A{#width;#height;#weight;#pixels;#palette;#saliencies;#nMaxColors;#beta=1;#qPixels;#qPixel32s;#errorq=[];#weights=[];#BLOCK_SIZE=343;#DITHER_MAX=9;#ditherMax;#dither;#hasAlpha;#sortedByYDiff;#margin;#thresold;constructor(i,t){this.opts=i,this.args=t,this.getColorIndex=this.args.getColorIndex,this.#width=this.opts.width,this.#height=this.opts.height,this.#pixels=this.opts.pixels,this.#palette=new Uint32Array(this.args.pal8),this.ditherFn=this.args.ditherFn,this.#hasAlpha=this.args.weight<0,this.#saliencies=this.args.saliencies,this.#dither=this.opts.dithering,this.#weight=Math.abs(this.args.weight),this.#margin=this.#weight<.0025?12:this.#weight<.004?8:6,this.#nMaxColors=this.#palette.length,this.#sortedByYDiff=128<this.#nMaxColors&&.02<=this.#weight&&(!this.#hasAlpha||this.#weight<.18);var i=4<this.#nMaxColors?.6-.00625*this.#nMaxColors:1,t=(4<this.#nMaxColors?(t=.005-625e-7*this.#nMaxColors,i=Math.fround(this.#weight>t?.25:Math.min(1.5,i+this.#nMaxColors*this.#weight)),16<this.#nMaxColors&&this.#nMaxColors<=32&&this.#weight<.003?i+=.075:(this.#weight<.0015||32<this.#nMaxColors&&this.#nMaxColors<256)&&(i+=.1),64<=this.#nMaxColors&&.012<this.#weight&&this.#weight<.0125||.025<this.#weight&&this.#weight<.03?i+=.05:32<this.#nMaxColors&&this.#nMaxColors<64&&this.#weight<.015&&(i=.55)):i*=.95,(64<this.#nMaxColors||4<this.#nMaxColors&&.02<this.#weight)&&(i*=.4),64<this.#nMaxColors&&this.#weight<.02&&(i=.2),this.#beta=i,this.#DITHER_MAX=this.#weight<.015?.0025<this.#weight?25:16:9,this.#hasAlpha?1:Math.exp(this.#weight)-.25),i=!this.#hasAlpha&&.002<this.#weight?-.25:1,i=this.#hasAlpha||9<this.#DITHER_MAX?Math.pow(Math.sqrt(this.#DITHER_MAX)+t*i,2):this.#DITHER_MAX*(null!=this.#saliencies?2:Math.E),s=16<this.#nMaxColors?3200:1500;(5e3<this.#nMaxColors/this.#weight&&(.045<this.#weight||.01<this.#weight&&this.#nMaxColors<64)||this.#weight<.03&&this.#palette.length/this.#weight<s&&16<=this.#nMaxColors&&this.#nMaxColors<256)&&(i=Math.pow(5+t,2)),this.#ditherMax=0|i,this.#thresold=9<this.#DITHER_MAX?-112:-64}#Y_Diff(i,t,s,h,e,a){function r(i,t,s){return.2126*l(i)+.7152*l(t)+.0722*l(s)}i=r(i,t,s),t=r(h,e,a);return 100*Math.abs(t-i)}#U_Diff(i,t,s,h,e,a){function r(i,t,s){return-.09991*i-.33609*t+.436*s}i=r(i,t,s),t=r(h,e,a);return Math.abs(t-i)}static ErrorBox=class{constructor(i){var t=255&i,s=i>>>8&255,h=i>>>16&255,i=i>>>24&255;this.yDiff=0,this.p=[t,s,h,i]}};#normalDistribution(i,t){var i=-Math.pow(i-.5,2)/(2*Math.pow(.1,2)),i=1/(.1*Math.sqrt(2*Math.PI))*Math.exp(i),s=1/(.1*Math.sqrt(2*Math.PI));return Math.fround(Math.max(0,Math.min(t,i/s*t)))}#ditherPixel(i,t,s,h){var e,a,r=this.ditherFn,l=i+t*this.#width,n=this.#pixels[l],o=255&n,g=n>>>8&255,f=n>>>16&255,M=255&s,x=s>>>8&255,p=s>>>16&255,d=s>>>24&255,w=this.#palette[this.#qPixels[l]],u=Math.max(2,this.#nMaxColors-this.#margin),c=(this.#nMaxColors<=4&&.2<this.#saliencies[l]&&this.#saliencies[l]<.25?s=new BlueNoise(null,{weightB:2*h/this.#saliencies[l]}).diffuse(n,w,1/3,i,t):(this.#nMaxColors<=4||this.#Y_Diff(o,g,f,M,x,p)<2*u)&&(c=255&(s=this.#nMaxColors<=128||0<BlueNoise.TELL_BLUE_NOISE[4095&l]?new BlueNoise(null,{weightB:.5*h/this.#saliencies[l]}).diffuse(n,w,1/3,i,t):s),c=255&(s=this.#U_Diff(o,g,f,c,D=s>>>8&255,C=s>>>16&255)>this.#margin*u?new BlueNoise(null,{weightB:h/this.#saliencies[l]}).diffuse(n,w,1/3,i,t):s),D=s>>>8&255,C=s>>>16&255),255&s),D=s>>>8&255,C=s>>>16&255;return 6<this.#margin||this.#nMaxColors<=32&&this.#weight<.01&&.007<this.#weight?4<this.#nMaxColors&&this.#Y_Diff(o,g,f,c,D,C)>h*u&&(e=this.#saliencies[l]<.4?.4*h*this.#saliencies[l]:.4*h/this.#saliencies[l],a=d<<24|p<<16|x<<8|M,32<this.#nMaxColors&&this.#saliencies[l]<.9?e=h*this.#normalDistribution(h,2)*this.#saliencies[l]:(.0015<=this.#weight&&this.#saliencies[l]<.6&&(a=n),this.#saliencies[l]<.6?e=h*this.#normalDistribution(h,this.#weight<8e-4?2.5:1.75)*this.#saliencies[l]:(32<=this.#nMaxColors||this.#Y_Diff(M,x,p,c,D,C)>h*Math.PI*u)&&(e=this.#saliencies[l]<.9?h*(!this.#sortedByYDiff&&this.#weight<.0025?.55:.5)/this.#saliencies[l]:h*this.#normalDistribution(h,!this.#sortedByYDiff&&this.#weight<.0025?.55:.5)/this.#saliencies[l])),c=255&(s=new BlueNoise(null,{weightB:e}).diffuse(a,w,1/3,i,t)),D=s>>>8&255,C=s>>>16&255,0):4<this.#nMaxColors&&(this.#Y_Diff(o,g,f,c,D,C)>h*u||this.#U_Diff(o,g,f,c,D,C)>u)&&(c=255&(s=h<.4&&(this.#nMaxColors<=32||this.#saliencies[l]<h)?new BlueNoise(null,{weightB:.4*h*this.#saliencies[l]}).diffuse(s,w,1/3,i,t):d<<24|p<<16|x<<8|M),D=s>>>8&255,C=s>>>16&255,0),this.#DITHER_MAX<16&&4<this.#nMaxColors&&this.#saliencies[l]<.6&&this.#Y_Diff(o,g,f,c,D,C)>this.#margin-1&&(s=d<<24|p<<16|x<<8|M,c=M,D=x,C=p,0),1<h&&this.#Y_Diff(o,g,f,c,D,C)>this.#DITHER_MAX&&(s=d<<24|p<<16|x<<8|M),r(this.#palette,s,l)}#diffusePixel(i,t){for(var s=this.ditherFn,h=i+t*this.#width,e=this.#pixels[h],a=new A.ErrorBox(e),r=this.#DITHER_MAX-1,l=this.#sortedByYDiff?this.#weights.length-1:0,n=0;n<this.#errorq.length;++n){var o=this.#errorq[n];if(l<0||l>=this.#weights.length)break;for(var g=0;g<o.p.length;++g)a.p[g]+=o.p[g]*this.#weights[l],a.p[g]>r&&(r=a.p[g]);l+=this.#sortedByYDiff?-1:1}for(var f,M=0|Math.clamp(a.p[0],0,255),x=0|Math.clamp(a.p[1],0,255),p=0|Math.clamp(a.p[2],0,255),d=0|Math.clamp(a.p[3],0,255),w=255&e,u=e>>>8&255,c=e>>>16&255,D=d<<24|p<<16|x<<8|M,C=(null!=this.#saliencies&&this.#dither&&!this.#sortedByYDiff&&(!this.#hasAlpha||(e>>>24&255)<d)?32<this.#nMaxColors&&.99<this.#saliencies[h]?this.#qPixels[h]=s(this.#palette,D,h):this.#qPixels[h]=this.#ditherPixel(i,t,D,this.#beta):this.#nMaxColors<=32&&240<d?(this.#qPixels[h]=s(this.#palette,D,h),C=Math.max(2,this.#nMaxColors-this.#margin),null!=this.#saliencies&&(this.#Y_Diff(w,u,c,M,x,p)>C||this.#U_Diff(w,u,c,M,x,p)>2*C)&&(f=1/3,D=new BlueNoise(null,{weightB:1/this.#saliencies[h]}).diffuse(e,this.#palette[this.#qPixels[h]],f,i,t),this.#qPixels[h]=s(this.#palette,D,h))):this.#qPixels[h]=s(this.#palette,D,h),this.#errorq.length>=this.#DITHER_MAX?this.#errorq.shift():0<this.#errorq.length&&this.#initWeights(this.#errorq.length),255&(D=this.#palette[this.#qPixels[h]])),B=D>>>8&255,q=D>>>16&255,P=D>>>24&255,d=(a.p[0]=M-C,a.p[1]=x-B,a.p[2]=p-q,a.p[3]=d-P,2<this.#palette.length),_=BlueNoise.TELL_BLUE_NOISE[4095&h]>this.#thresold,m=(a.yDiff=this.#sortedByYDiff?this.#Y_Diff(w,u,c,C,B,q):1,!_&&BlueNoise.TELL_BLUE_NOISE[4095&(4096*a.yDiff|0)]>this.#thresold),y=!1,E=d?a.p.length-1:0,g=0;g<E;++g)Math.abs(a.p[g])>=this.#ditherMax&&(this.#sortedByYDiff&&null!=this.#saliencies&&(y=!0),_?a.p[g]=Math.fround(Math.tanh(a.p[g]/r*20))*(this.#ditherMax-1):m?a.p[g]=Math.fround(a.p[g]/r*a.yDiff)*(this.#ditherMax-1):a.p[g]/=Math.fround(1+Math.sqrt(this.#ditherMax))),this.#sortedByYDiff&&null==this.#saliencies&&Math.abs(a.p[g])>=this.#DITHER_MAX&&(y=!0);y&&(null!=this.#saliencies?this.#qPixels[h]=this.#ditherPixel(i,t,D,this.#beta):3<this.#Y_Diff(w,u,c,M,x,p)&&3<this.#U_Diff(w,u,c,M,x,p)&&(f=1/3,D=new BlueNoise(null,{weightB:f}).diffuse(e,this.#palette[this.#qPixels[h]],f,i,t),this.#qPixels[h]=s(this.#palette,D,h))),this.#errorq.push(a),this.#sortedByYDiff&&this.#errorq.sort((i,t)=>Math.sign(t.yDiff-i.yDiff)),this.#qPixel32s[h]=this.#palette[this.#qPixels[h]]}#generate2d(i,t,s,h,e,a){var r=Math.abs(s+h),l=Math.abs(e+a),n=Math.sign(s),o=Math.sign(h),g=Math.sign(e),f=Math.sign(a);if(1==l)for(var M=0;M<r;++M)this.#diffusePixel(i,t),i+=n,t+=o;else if(1==r)for(M=0;M<l;++M)this.#diffusePixel(i,t),i+=g,t+=f;else{var x=s>>1,p=h>>1,d=e>>1,w=a>>1,u=Math.abs(x+p),c=Math.abs(d+w);3*l<2*r?(u%2!=0&&2<r&&(x+=n,p+=o),this.#generate2d(i,t,x,p,e,a),this.#generate2d(i+x,t+p,s-x,h-p,e,a)):(c%2!=0&&2<l&&(d+=g,w+=f),this.#generate2d(i,t,d,w,x,p),this.#generate2d(i+d,t+w,s,h,e-d,a-w),this.#generate2d(i+(s-n)+(d-g),t+(h-o)+(w-f),-d,-w,-(s-x),-(h-p)))}}#initWeights(i){var t=Math.fround(Math.pow(this.#BLOCK_SIZE+1,1/(i-1))),s=1,h=0;this.#weights=new Array(i);for(var e=0;e<i;++e)this.#errorq.push(new A.ErrorBox(0)),h+=this.#weights[i-e-1]=s,s/=t;for(s=0,e=0;e<i;++e)this.#weights[e]=Math.fround(this.#weights[e]/h),s+=this.#weights[e];this.#weights[0]+=Math.fround(1-s)}dither(){return this.#qPixels=new(256<this.#nMaxColors?Uint16Array:Uint8Array)(this.#pixels.length),this.#qPixel32s=new Uint32Array(this.#qPixels.length),this.#sortedByYDiff||this.#initWeights(this.#DITHER_MAX),this.#width>=this.#height?this.#generate2d(0,0,this.#width,0,0,this.#height):this.#generate2d(0,0,0,this.#height,this.#width,0),this.opts.dithering||this.opts.colors<=32?this.#qPixel32s:this.#qPixels}getIndexedPixels(){return this.#qPixels}getResult(){var s=this;return new Promise(function(i,t){s.opts.dithering||s.opts.colors<=32?i({img8:s.dither(),indexedPixels:s.getIndexedPixels(),pal8:s.args.pal8,transparent:s.args.transparent,type:s.args.type}):i({indexedPixels:s.dither(),pal8:s.args.pal8,transparent:s.args.transparent,type:s.args.type})})}}this.GilbertCurve=A,"undefined"!=typeof module&&module.exports&&(module.exports=A)}.call(this);