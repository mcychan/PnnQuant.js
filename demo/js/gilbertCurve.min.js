!function(){"use strict";function t(t){this.opts=t,this.qPixels=[]}function r(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function I(t,e,h,i,n,s){function a(t,e,h){return.2126*r(t)+.7152*r(e)+.0722*r(h)}t=a(t,e,h),e=a(i,n,s);return 100*Math.abs(e-t)}function L(t,e,h,i,n,s){function a(t,e,h){return-.09991*t-.33609*e+.436*h}t=a(t,e,h),e=a(i,n,s);return Math.abs(e-t)}function D(t){var e=255&t,h=t>>>8&255,i=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,h,i,t]}Math.tanh||(Math.tanh=function(t){var e=Math.exp(+t),t=Math.exp(-t);return e==1/0?1:t==1/0?-1:(e-t)/(e+t)});var q,U,_,n,P,A,O,S,T,C,k,F,G,R,j,z,H,J,K=[],Q=[],V=9,s=343;function W(t,e,h,i){var n,s,a,r=t+e*_,o=A[r],p=255&o,l=o>>>8&255,f=o>>>16&255,u=255&h,M=h>>>8&255,g=h>>>16&255,d=h>>>24&255,w=O[k[r]],c=Math.max(2,T-H),x=(T<=4&&.2<S[r]&&S[r]<.25?h=new BlueNoise({weightB:2*i/S[r]}).diffuse(o,w,1/3,t,e):(T<=4||I(p,l,f,u,M,g)<2*c)&&(x=255&(h=L(p,l,f,x=255&(h=T<=128||0<TELL_BLUE_NOISE[4095&r]?new BlueNoise({weightB:.5*i/S[r]}).diffuse(o,w,1/3,t,e):h),v=h>>>8&255,y=h>>>16&255)>H*c?new BlueNoise({weightB:i/S[r]}).diffuse(o,w,1/3,t,e):h),v=h>>>8&255,y=h>>>16&255),255&h),v=h>>>8&255,y=h>>>16&255,B=h>>>24&255,m=(T<3||6<H?4<T&&I(p,l,f,x,v,y)>i*c&&(n=S[r]<.4?.4*i*S[r]:.4*i/S[r],s=d<<24|g<<16|M<<8|u,32<T?n=i*(m=i,m=-Math.pow(m-.5,2)/(2*Math.pow(.1,2)),m=1/(.1*Math.sqrt(2*Math.PI))*Math.exp(m),a=1/(.1*Math.sqrt(2*Math.PI)),Math.fround(Math.max(0,Math.min(2,m/a*2))))*S[r]:(.0015<=P&&S[r]<.6&&(s=o),I(u,M,g,x,v,y)>i*Math.PI*c&&(n=i*(!z&&P<.0025?.55:.5)/S[r])),x=255&(h=new BlueNoise({weightB:n}).diffuse(s,w,1/3,t,e)),v=h>>>8&255,y=h>>>16&255,B=h>>>24&255):4<T&&(I(p,l,f,x,v,y)>i*c||L(p,l,f,x,v,y)>c)&&(x=255&(h=i<.4&&(T<=32||S[r]<i)?new BlueNoise({weightB:.4*i*S[r]}).diffuse(h,w,1/3,t,e):d<<24|g<<16|M<<8|u),v=h>>>8&255,y=h>>>16&255,B=h>>>24&255),V<16&&4<T&&S[r]<.6&&I(p,l,f,x,v,y)>H-1&&(h=d<<24|g<<16|M<<8|u,x=u,v=M,y=g,B=d),1<i&&I(p,l,f,x,v,y)>V&&(h=d<<24|g<<16|M<<8|u,x=u,v=M,y=g,B=d),U(B,x,v,y));return 0==F[m]&&(F[m]=q(O,h,r)+1),F[m]-1}function v(t,e){for(var h=t+e*_,i=A[h],n=new D(i),s=z?Q.length-1:0,a=V-1,r=0;r<K.length;++r){var o=K[r];if(s<0||s>=Q.length)break;for(var p=0;p<o.p.length;++p)n.p[p]+=o.p[p]*Q[s],n.p[p]>a&&(a=n.p[p]);s+=z?-1:1}for(var l,f=0|Math.clamp(n.p[0],0,255),u=0|Math.clamp(n.p[1],0,255),M=0|Math.clamp(n.p[2],0,255),g=0|Math.clamp(n.p[3],0,255),d=255&i,w=i>>>8&255,c=i>>>16&255,x=g<<24|M<<16|u<<8|f,v=(null!=S&&R&&!z&&(!j||(i>>>24&255)<g)?32<T&&.99<S[h]?k[h]=q(O,x,h):k[h]=W(t,e,x,C):T<=32&&240<g?(v=U(g,f,u,M),0==F[v]&&(F[v]=q(O,x,h)+1),k[h]=F[v]-1,v=Math.max(2,T-H),null!=S&&(I(d,w,c,f,u,M)>v||L(d,w,c,f,u,M)>2*v)&&(l=1/3,x=new BlueNoise({weightB:1/S[h]}).diffuse(i,O[k[h]],l,t,e),k[h]=q(O,x,h))):k[h]=q(O,x,h),K.length>=V?K.shift():0<K.length&&X(K.length),255&(x=O[k[h]])),y=x>>>8&255,B=x>>>16&255,m=x>>>24&255,g=(n.p[0]=f-v,n.p[1]=u-y,n.p[2]=M-B,n.p[3]=g-m,2<O.length),P=TELL_BLUE_NOISE[4095&h]>J,b=(n.yDiff=z?I(d,w,c,v,y,B):1,!P&&TELL_BLUE_NOISE[4095&(4096*n.yDiff|0)]>J),E=!1,N=g?n.p.length-1:0,p=0;p<N;++p)Math.abs(n.p[p])>=G&&(z&&null!=S&&(E=!0),P?n.p[p]=Math.fround(Math.tanh(n.p[p]/a*20))*(G-1):b?n.p[p]=Math.fround(n.p[p]/a*n.yDiff)*(G-1):n.p[p]/=Math.fround(1+Math.sqrt(G))),z&&null==S&&Math.abs(n.p[p])>=V&&(E=!0);E&&(null!=S?k[h]=W(t,e,x,1.25):3<I(d,w,c,f,u,M)&&3<L(d,w,c,f,u,M)&&(l=1/3,x=new BlueNoise({weightB:l}).diffuse(i,O[k[h]],l,t,e),k[h]=q(O,x,h))),K.push(n),z&&K.sort(function(t,e){return e.yDiff<t.yDiff?-1:t.yDiff<e.yDiff?1:0})}function y(t,e,h,i,n,s){var a=Math.abs(h+i),r=Math.abs(n+s),o=Math.sign(h),p=Math.sign(i),l=Math.sign(n),f=Math.sign(s);if(1==r)for(var u=0;u<a;++u)v(t,e),t+=o,e+=p;else if(1==a)for(u=0;u<r;++u)v(t,e),t+=l,e+=f;else{var M=h>>1,g=i>>1,d=n>>1,w=s>>1,c=Math.abs(M+g),x=Math.abs(d+w);3*r<2*a?(c%2!=0&&2<a&&(M+=o,g+=p),y(t,e,M,g,n,s),y(t+M,e+g,h-M,i-g,n,s)):(x%2!=0&&2<r&&(d+=l,w+=f),y(t,e,d,w,M,g),y(t+d,e+w,h,i,n-d,s-w),y(t+(h-o)+(d-l),e+(i-p)+(w-f),-d,-w,-(h-M),-(i-g)))}}function X(t){var e=Math.fround(Math.pow(s+1,1/(t-1))),h=1,i=0;Q=new Array(t);for(var n=0;n<t;++n)K.push(new D(0)),i+=Q[t-n-1]=h,h/=e;for(h=0,n=0;n<t;++n)Q[n]=Math.fround(Q[n]/i),h+=Q[n];Q[0]+=Math.fround(1-h)}t.prototype.dither=function(){K=[],j=this.opts.weight<0,this.opts.weight=P=Math.abs(this.opts.weight),H=P<.0025?12:P<.004?8:6,z=128<=this.opts.palette.length&&.02<=P&&(!j||P<.18),V=P<.015?.0025<P?25:16:9;var t=j?1:Math.exp(P)-.25,e=!j&&.002<P?-.25:1,e=(G=j||9<V?Math.pow(Math.sqrt(V)+t*e,2):V*(null!=S?2:Math.E),16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/P&&(.045<P||.01<P&&this.opts.palette.length<64)||P<.03&&this.opts.palette.length/P<e&&16<=this.opts.palette.length&&this.opts.palette.length<256)&&(G=Math.pow(5+t,2)),G|=0,J=9<V?-112:-64,Q=[],F=new Uint16Array(65536),q=this.opts.ditherFn,U=this.opts.getColorIndex,_=this.opts.width,n=this.opts.height,A=this.opts.pixels,O=this.opts.palette,S=this.opts.saliencies,R=this.opts.dithering,T=O.length,C=4<T?.6-.00625*T:1,4<T?(e=.005-625e-7*T,C=Math.fround(e<P?.25:Math.min(1.5,C+T*P)),16<T&&T<=32&&P<.003?C+=.075:(P<.0015||32<T&&T<256)&&(C+=.1),(64<=T&&.012<P&&P<.0125||.025<P&&P<.03)&&(C*=2)):C*=.95,(64<T||4<T&&.02<P)&&(C*=.4),64<T&&P<.02&&(C=.2),k=new(256<T?Uint16Array:Uint8Array)(A.length),z||X(V),n<=_?y(0,0,_,0,0,n):y(0,0,0,n,_,0),this.opts.indexedPixels=this.qPixels=k,this.opts.dithering){for(var h=new Uint32Array(k.length),i=0;i<k.length;++i)h[i]=O[k[i]];return h}return k},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var h=this;return new Promise(function(t,e){h.opts.dithering||h.opts.colors<=32?t({img8:h.dither(),indexedPixels:h.getIndexedPixels()}):t({indexedPixels:h.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);