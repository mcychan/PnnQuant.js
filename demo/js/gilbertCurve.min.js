!function(){function t(t){this.opts=t,this.qPixels=[]}function o(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function L(t,e,i,n,h,s){function a(t,e,i){return.2126*o(t)+.7152*o(e)+.0722*o(i)}t=a(t,e,i),e=a(n,h,s);return 100*Math.abs(e-t)}function D(t,e,i,n,h,s){function a(t,e,i){return-.09991*t-.33609*e+.436*i}t=a(t,e,i),e=a(n,h,s);return Math.abs(e-t)}function I(t){var e=255&t,i=t>>>8&255,n=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,i,n,t]}Math.tanh||(Math.tanh=function(t){var e=Math.exp(+t),t=Math.exp(-t);return e==1/0?1:t==1/0?-1:(e-t)/(e+t)});var U,_,q,s,v,A,O,S,T,C,k,F,G,R,j,z,H,J=[],K=[],Q=9,a=343;function V(t,e,i,n){var h,s,a=t+e*q,o=A[a],r=255&o,p=o>>>8&255,l=o>>>16&255,f=255&i,u=i>>>8&255,g=i>>>16&255,M=i>>>24&255,d=O[k[a]],w=Math.max(2,T-z),c=(T<=4&&.2<S[a]&&S[a]<.25?i=new BlueNoise({weightB:2*n/S[a]}).diffuse(o,d,1/3,t,e):(T<=4||L(r,p,l,f,u,g)<2*w)&&(c=255&(i=T<=128||0<TELL_BLUE_NOISE[4095&a]?new BlueNoise({weightB:.5*n/S[a]}).diffuse(o,d,1/3,t,e):i),x=i>>>8&255,B=i>>>16&255,T<=4&&D(r,p,l,c,x,B)>8*w&&(s=.65<S[a]?o:M<<24|g<<16|u<<8|f,c=255&(i=new BlueNoise({weightB:n*S[a]}).diffuse(s,d,1/3,t,e)),x=i>>>8&255,B=i>>>16&255),c=255&(i=D(r,p,l,c,x,B)>z*w?new BlueNoise({weightB:n/S[a]}).diffuse(o,d,1/3,t,e):i),x=i>>>8&255,B=i>>>16&255),255&i),x=i>>>8&255,B=i>>>16&255,o=(T<3||6<z?(h=.0015<v&&v<.0025?n:Math.PI,4<T&&(L(r,p,l,c,x,B)>h*w||D(r,p,l,c,x,B)>z*w)&&(h=S[a]<.4?.4*n*S[a]:.4*n/S[a],s=S[a]<.6?o:M<<24|g<<16|u<<8|f,c=255&(i=new BlueNoise({weightB:h}).diffuse(s,d,1/3,t,e)),x=i>>>8&255,B=i>>>16&255)):4<T&&(L(r,p,l,c,x,B)>n*w||D(r,p,l,c,x,B)>w)&&(c=255&(i=n<.4&&(T<=32||S[a]<n)?new BlueNoise({weightB:.4*n*S[a]}).diffuse(i,d,1/3,t,e):M<<24|g<<16|u<<8|f),x=i>>>8&255,B=i>>>16&255),Q<16&&4<T&&S[a]<.6&&L(r,p,l,c,x,B)>z-1&&(i=M<<24|g<<16|u<<8|f,c=f,x=u,B=g),1<n&&L(r,p,l,c,x,B)>Q&&(i=M<<24|g<<16|u<<8|f,c=f,x=u,B=g),_(M,c,x,B));return 0==F[o]&&(F[o]=U(O,i,a)+1),F[o]-1}function B(t,e){for(var i=t+e*q,n=A[i],h=new I(n),s=j?K.length-1:0,a=Q-1,o=0;o<J.length;++o){var r=J[o];if(s<0||s>=K.length)break;for(var p=0;p<r.p.length;++p)h.p[p]+=r.p[p]*K[s],h.p[p]>a&&(a=h.p[p]);s+=j?-1:1}for(var l,f=0|Math.clamp(h.p[0],0,255),u=0|Math.clamp(h.p[1],0,255),g=0|Math.clamp(h.p[2],0,255),M=0|Math.clamp(h.p[3],0,255),d=255&n,w=n>>>8&255,c=n>>>16&255,x=M<<24|g<<16|u<<8|f,B=(null!=S&&R&&!j?k[i]=V(t,e,x,C):T<=32&&240<M?(B=_(M,f,u,g),0==F[B]&&(F[B]=U(O,x,i)+1),k[i]=F[B]-1,B=Math.max(2,T-z),null!=S&&(L(d,w,c,f,u,g)>B||D(d,w,c,f,u,g)>2*B)&&(l=1/3,x=new BlueNoise({weightB:1/S[i]}).diffuse(n,O[k[i]],l,t,e),k[i]=U(O,x,i))):k[i]=U(O,x,i),J.length>=Q?J.shift():0<J.length&&W(J.length),255&(x=O[k[i]])),v=x>>>8&255,y=x>>>16&255,m=x>>>24&255,M=(h.p[0]=f-B,h.p[1]=u-v,h.p[2]=g-y,h.p[3]=M-m,2<O.length),b=TELL_BLUE_NOISE[4095&i]>H,N=(h.yDiff=j?L(d,w,c,B,v,y):1,!b&&TELL_BLUE_NOISE[4095&(4096*h.yDiff|0)]>H),E=!1,P=M?h.p.length-1:0,p=0;p<P;++p)Math.abs(h.p[p])>=G&&(j&&null!=S&&(E=!0),b?h.p[p]=Math.fround(Math.tanh(h.p[p]/a*20))*(G-1):N?h.p[p]=Math.fround(h.p[p]/a*h.yDiff)*(G-1):h.p[p]/=Math.fround(1+Math.sqrt(G))),j&&null==S&&Math.abs(h.p[p])>=Q&&(E=!0);E&&(null!=S?k[i]=V(t,e,x,1.25):3<L(d,w,c,f,u,g)&&3<D(d,w,c,f,u,g)&&(l=1/3,x=new BlueNoise({weightB:l}).diffuse(n,O[k[i]],l,t,e),k[i]=U(O,x,i))),J.push(h),j&&J.sort(function(t,e){return e.yDiff<t.yDiff?-1:t.yDiff<e.yDiff?1:0})}function y(t,e,i,n,h,s){var a=Math.abs(i+n),o=Math.abs(h+s),r=Math.sign(i),p=Math.sign(n),l=Math.sign(h),f=Math.sign(s);if(1==o)for(var u=0;u<a;++u)B(t,e),t+=r,e+=p;else if(1==a)for(u=0;u<o;++u)B(t,e),t+=l,e+=f;else{var g=i>>1,M=n>>1,d=h>>1,w=s>>1,c=Math.abs(g+M),x=Math.abs(d+w);3*o<2*a?(c%2!=0&&2<a&&(g+=r,M+=p),y(t,e,g,M,h,s),y(t+g,e+M,i-g,n-M,h,s)):(x%2!=0&&2<o&&(d+=l,w+=f),y(t,e,d,w,g,M),y(t+d,e+w,i,n,h-d,s-w),y(t+(i-r)+(d-l),e+(n-p)+(w-f),-d,-w,-(i-g),-(n-M)))}}function W(t){var e=Math.fround(Math.pow(a+1,1/(t-1))),i=1,n=0;K=new Array(t);for(var h=0;h<t;++h)J.push(new I(0)),n+=K[t-h-1]=i,i/=e;for(i=0,h=0;h<t;++h)K[h]=Math.fround(K[h]/n),i+=K[h];K[0]+=Math.fround(1-i)}t.prototype.dither=function(){J=[];var t=this.opts.weight<0,e=(this.opts.weight=v=Math.abs(this.opts.weight),z=v<.0025?12:v<.004?8:6,j=128<=this.opts.palette.length&&.02<=v&&(!t||v<.18),Q=v<.015?.0025<v?25:16:9,t?1:Math.exp(v)-.25),i=!t&&.002<v?-.25:1,i=(G=t||9<Q?Math.pow(Math.sqrt(Q)+e*i,2):Q*(null!=S?2:Math.E),16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/v&&(.045<v||.01<v&&this.opts.palette.length<64)||v<.03&&this.opts.palette.length/v<i&&16<=this.opts.palette.length&&this.opts.palette.length<256)&&(G=Math.pow(5+e,2)),G|=0,H=9<Q?-112:-64,K=[],F=new Uint32Array(65536),U=this.opts.ditherFn,_=this.opts.getColorIndex,q=this.opts.width,s=this.opts.height,A=this.opts.pixels,O=this.opts.palette,S=t?null:this.opts.saliencies,R=this.opts.dithering,T=O.length,C=4<T?.6-.00625*T:1,4<T?(i=.005-625e-7*T,C=Math.fround(i<v?.25:Math.min(1.5,C+T*v)),32<T&&T<256&&(C+=.1),(64<=T&&.012<v&&v<.0125||.025<v&&v<.03)&&(C*=2)):C*=.95,(64<T||4<T&&.02<v)&&(C*=.4),64<T&&v<.02&&(C=.2),k=new(256<T?Uint16Array:Uint8Array)(A.length),j||W(Q),s<=q?y(0,0,q,0,0,s):y(0,0,0,s,q,0),this.opts.indexedPixels=this.qPixels=k,this.opts.dithering){for(var n=new Uint32Array(k.length),h=0;h<k.length;++h)n[h]=O[k[h]];return n}return k},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var i=this;return new Promise(function(t,e){i.opts.dithering||i.opts.colors<=32?t({img8:i.dither(),indexedPixels:i.getIndexedPixels()}):t({indexedPixels:i.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);
