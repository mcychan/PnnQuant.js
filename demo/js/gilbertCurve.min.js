!function(){function t(t){this.opts=t,this.qPixels=[]}function r(t){t/=255;return t<.04045?t/12.92:Math.pow((.055+t)/1.055,2.4)}function D(t,e,i,n,h,s){function a(t,e,i){return.2126*r(t)+.7152*r(e)+.0722*r(i)}t=a(t,e,i),e=a(n,h,s);return 100*Math.abs(e-t)}function I(t,e,i,n,h,s){function a(t,e,i){return-.09991*t-.33609*e+.436*i}t=a(t,e,i),e=a(n,h,s);return Math.abs(e-t)}function U(t){var e=255&t,i=t>>>8&255,n=t>>>16&255,t=t>>>24&255;this.yDiff=0,this.p=[e,i,n,t]}Math.tanh||(Math.tanh=function(t){var e=Math.exp(+t),t=Math.exp(-t);return e==1/0?1:t==1/0?-1:(e-t)/(e+t)});var _,q,A,s,B,O,S,T,C,k,F,G,R,j,z,H,J,K=[],Q=[],V=9,a=343;function W(t,e,i,n){var h,s,a=t+e*A,r=O[a],o=255&r,p=r>>>8&255,l=r>>>16&255,f=255&i,u=i>>>8&255,g=i>>>16&255,M=i>>>24&255,d=S[F[a]],w=Math.max(2,C-H),c=(C<=4&&.2<T[a]&&T[a]<.25?i=new BlueNoise({weightB:2*n/T[a]}).diffuse(r,d,1/3,t,e):(C<=4||D(o,p,l,f,u,g)<2*w)&&(c=255&(i=I(o,p,l,c=255&(i=C<=128||0<TELL_BLUE_NOISE[4095&a]?new BlueNoise({weightB:.5*n/T[a]}).diffuse(r,d,1/3,t,e):i),x=i>>>8&255,v=i>>>16&255)>H*w?new BlueNoise({weightB:n/T[a]}).diffuse(r,d,1/3,t,e):i),x=i>>>8&255,v=i>>>16&255),255&i),x=i>>>8&255,v=i>>>16&255,y=i>>>24&255;return C<3||6<H?(s=.0015<B&&B<.0025?n:Math.PI,4<C&&D(o,p,l,c,x,v)>s*w&&(s=T[a]<.4?.4*n*T[a]:.4*n/T[a],h=T[a]<.6?r:M<<24|g<<16|u<<8|f,c=255&(i=new BlueNoise({weightB:s}).diffuse(h,d,1/3,t,e)),x=i>>>8&255,v=i>>>16&255,y=i>>>24&255)):4<C&&(D(o,p,l,c,x,v)>n*w||I(o,p,l,c,x,v)>w)&&(c=255&(i=n<.4&&(C<=32||T[a]<n)?new BlueNoise({weightB:.4*n*T[a]}).diffuse(i,d,1/3,t,e):M<<24|g<<16|u<<8|f),x=i>>>8&255,v=i>>>16&255,y=i>>>24&255),V<16&&4<C&&T[a]<.6&&D(o,p,l,c,x,v)>H-1&&(i=M<<24|g<<16|u<<8|f,c=f,x=u,v=g,y=M),1<n&&D(o,p,l,c,x,v)>V&&(i=M<<24|g<<16|u<<8|f,c=f,x=u,v=g,y=M),(r>>>24&255)<=224?_(S,i,a):(s=q(y,c,x,v),0==G[s]&&(G[s]=_(S,i,a)+1),G[s]-1)}function v(t,e){for(var i=t+e*A,n=O[i],h=new U(n),s=z?Q.length-1:0,a=V-1,r=0;r<K.length;++r){var o=K[r];if(s<0||s>=Q.length)break;for(var p=0;p<o.p.length;++p)h.p[p]+=o.p[p]*Q[s],h.p[p]>a&&(a=h.p[p]);s+=z?-1:1}for(var l,f=0|Math.clamp(h.p[0],0,255),u=0|Math.clamp(h.p[1],0,255),g=0|Math.clamp(h.p[2],0,255),M=0|Math.clamp(h.p[3],0,255),d=255&n,w=n>>>8&255,c=n>>>16&255,x=n>>>24&255,v=M<<24|g<<16|u<<8|f,y=(null!=T&&j&&!z&&x<M?F[i]=W(t,e,v,k):C<=32&&240<M?(y=q(M,f,u,g),0==G[y]&&(G[y]=_(S,v,i)+1),F[i]=G[y]-1,y=Math.max(2,C-H),null!=T&&(D(d,w,c,f,u,g)>y||I(d,w,c,f,u,g)>2*y)&&(l=1/3,v=new BlueNoise({weightB:1/T[i]}).diffuse(n,S[F[i]],l,t,e),F[i]=_(S,v,i))):F[i]=_(S,v,i),K.length>=V?K.shift():0<K.length&&X(K.length),255&(v=S[F[i]])),B=v>>>8&255,m=v>>>16&255,b=v>>>24&255,b=(h.p[0]=f-y,h.p[1]=u-B,h.p[2]=g-m,h.p[3]=M-b,2<S.length),E=TELL_BLUE_NOISE[4095&i]>J,N=(h.yDiff=z?D(d,w,c,y,B,m):1,!E&&TELL_BLUE_NOISE[4095&(4096*h.yDiff|0)]>J),P=!1,L=b?h.p.length-1:0,p=0;p<L;++p)Math.abs(h.p[p])>=R&&(z&&null!=T&&(P=x<M),E?h.p[p]=Math.fround(Math.tanh(h.p[p]/a*20))*(R-1):N?h.p[p]=Math.fround(h.p[p]/a*h.yDiff)*(R-1):h.p[p]/=Math.fround(1+Math.sqrt(R))),z&&null==T&&Math.abs(h.p[p])>=V&&(P=x<M);P&&(null!=T?F[i]=W(t,e,v,1.25):3<D(d,w,c,f,u,g)&&3<I(d,w,c,f,u,g)&&(l=1/3,v=new BlueNoise({weightB:l}).diffuse(n,S[F[i]],l,t,e),F[i]=_(S,v,i))),K.push(h),z&&K.sort(function(t,e){return e.yDiff<t.yDiff?-1:t.yDiff<e.yDiff?1:0})}function y(t,e,i,n,h,s){var a=Math.abs(i+n),r=Math.abs(h+s),o=Math.sign(i),p=Math.sign(n),l=Math.sign(h),f=Math.sign(s);if(1==r)for(var u=0;u<a;++u)v(t,e),t+=o,e+=p;else if(1==a)for(u=0;u<r;++u)v(t,e),t+=l,e+=f;else{var g=i>>1,M=n>>1,d=h>>1,w=s>>1,c=Math.abs(g+M),x=Math.abs(d+w);3*r<2*a?(c%2!=0&&2<a&&(g+=o,M+=p),y(t,e,g,M,h,s),y(t+g,e+M,i-g,n-M,h,s)):(x%2!=0&&2<r&&(d+=l,w+=f),y(t,e,d,w,g,M),y(t+d,e+w,i,n,h-d,s-w),y(t+(i-o)+(d-l),e+(n-p)+(w-f),-d,-w,-(i-g),-(n-M)))}}function X(t){var e=Math.fround(Math.pow(a+1,1/(t-1))),i=1,n=0;Q=new Array(t);for(var h=0;h<t;++h)K.push(new U(0)),n+=Q[t-h-1]=i,i/=e;for(i=0,h=0;h<t;++h)Q[h]=Math.fround(Q[h]/n),i+=Q[h];Q[0]+=Math.fround(1-i)}t.prototype.dither=function(){K=[];var t=this.opts.weight<0,e=(this.opts.weight=B=Math.abs(this.opts.weight),H=B<.0025?12:B<.004?8:6,z=128<=this.opts.palette.length&&.02<=B&&(!t||B<.18),V=B<.015?.0025<B?25:16:9,t?1:Math.exp(B)-.25),i=!t&&.002<B?-.25:1,t=(R=t||9<V?Math.pow(Math.sqrt(V)+e*i,2):V*(null!=T?2:Math.E),16<this.opts.palette.length?3200:1500);if((5e3<this.opts.palette.length/B&&(.045<B||.01<B&&this.opts.palette.length<64)||B<.03&&this.opts.palette.length/B<t&&16<=this.opts.palette.length&&this.opts.palette.length<256)&&(R=Math.pow(5+e,2)),R|=0,J=9<V?-112:-64,Q=[],G=new Uint32Array(65536),_=this.opts.ditherFn,q=this.opts.getColorIndex,A=this.opts.width,s=this.opts.height,O=this.opts.pixels,S=this.opts.palette,T=this.opts.saliencies,j=this.opts.dithering,C=S.length,k=4<C?.6-.00625*C:1,4<C?(i=.005-625e-7*C,k=Math.fround(i<B?.25:Math.min(1.5,k+C*B)),16<C&&C<=32&&B<.003?k+=.075:32<C&&C<256&&(k+=.1),(64<=C&&.012<B&&B<.0125||.025<B&&B<.03)&&(k*=2)):k*=.95,(64<C||4<C&&.02<B)&&(k*=.4),64<C&&B<.02&&(k=.2),F=new(256<C?Uint16Array:Uint8Array)(O.length),z||X(V),s<=A?y(0,0,A,0,0,s):y(0,0,0,s,A,0),this.opts.indexedPixels=this.qPixels=F,this.opts.dithering){for(var n=new Uint32Array(F.length),h=0;h<F.length;++h)n[h]=S[F[h]];return n}return F},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getResult=function(){var i=this;return new Promise(function(t,e){i.opts.dithering||i.opts.colors<=32?t({img8:i.dither(),indexedPixels:i.getIndexedPixels()}):t({indexedPixels:i.dither()})})},this.GilbertCurve=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);
