!function(){"use strict";var z,_,D,N,R=15,E=!1,O=!1,Q=!1,V=.299,j=.587,G=.114,H=.3333,J=1,K=new Map,W=new Map,X=[],Y=95.047,Z=100,$=108.883,tt=.008856,at=903.3,et=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function nt(){this.alpha=255,this.A=this.B=this.L=0}function rt(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function ht(t){return t*t}function l(t){return tt<t?Math.fround(Math.cbrt(t)):Math.fround((at*t+16)/116)}function M(t){return Math.fround(t*(Math.PI/180))}function it(t,a){var e=a.L-t.L,t=(t.L+a.L)/2,a=1+.015*ht(t-50)/Math.sqrt(20+ht(t-50));return Math.fround(e/a)}function st(t,a,e,n,r,h){var i=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,i=.5*(1-Math.sqrt(Math.pow(i,7)/(Math.pow(i,7)+6103515625))),i=(e.value=(1+i)*t.A,n.value=(1+i)*a.A,r.value=Math.sqrt(e.value*e.value+t.B*t.B),h.value=Math.sqrt(n.value*n.value+a.B*a.B),h.value-r.value);return Math.fround(i/(1+.045*((r.value+h.value)/2)))}function lt(t,a,e,n,r,h,i,s){var l,o,u,c=M(360),p=M(180),f=r*h,t=(0==t.B&&0==e?l=0:(l=Math.atan2(t.B,e))<0&&(l+=c),0==a.B&&0==n?o=0:(o=Math.atan2(a.B,n))<0&&(o+=c),0==f?u=0:(u=o-l)<-p?u+=c:p<u&&(u-=c),2*Math.sqrt(f)*Math.sin(u/2)),e=l+o,a=(r*h==0?s.value=e:Math.abs(l-o)<=p?s.value=e/2:s.value=e<c?(e+c)/2:(e-c)/2,i.value=(r+h)/2,1-.17*Math.cos(s.value-M(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+M(6))-.2*Math.cos(4*s.value-M(63))),n=1+.015*i.value*a;return Math.fround(t/n)}function ot(t,a,e,n){a=M(30)*Math.exp(-Math.pow((a-M(275))/M(25),2)),t=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625)),a=-Math.sin(2*a)*t;return Math.fround(a*e*n)}function ut(t,a,e,n,r,h){return r?(240&t)<<8|(240&a)<<4|240&e|n>>4:h?(128&t)<<8|(248&a)<<7|(248&e)<<2|n>>3:(248&a)<<8|(252&e)<<3|n>>3}function ct(t,a,e,n){var r,h,i=t<<24|n<<16|e<<8|a,s=W.get(i);return W.has(i)||(t=t,e=e,n=n,e/=255,n/=255,r=l(100*(.4124*(a=(a=(a=a)/255)<.04045?a/12.92:Math.pow((.055+a)/1.055,2.4))+.3576*(e=e<.04045?e/12.92:Math.pow((.055+e)/1.055,2.4))+.1805*(n=n<.04045?n/12.92:Math.pow((.055+n)/1.055,2.4)))/Y),h=l(100*(.2126*a+.7152*e+.0722*n)/Z),a=l(100*(.0193*a+.1192*e+.9505*n)/$),(e=new nt).alpha=t,e.L=Math.max(0,116*h-16),e.A=500*(r-h),e.B=200*(h-a),s=e,W.set(i,s)),s}function pt(t,a,e){var n=0,r=a>>>24&255,h=(r<=R&&(a=z,r=0),255&a),i=a>>>8&255,s=a>>>16&255,a=Q?ut(r,h,i,s,O,E):a,l=X[a];if(0<l)return l-1;2<t.length&&E&&R<r&&(n=1);for(var o=1e100,u=ct(r,h,i,s),c=n;c<t.length;++c){var p=255&t[c],f=t[c]>>>8&255,M=t[c]>>>16&255,v=t[c]>>>24&255,g=O?ht(v-r)/Math.exp(1.5):0;if(!(o<g)){var d=ct(v,p,f,M);if(t.length<=4)g=ht(p-h)+ht(f-i)+ht(M-s),O&&(g+=ht(v-r));else if(O||t.length<16){if(o<(g+=ht(d.L-u.L)))continue;if(o<(g+=ht(d.A-u.A)))continue;g+=ht(d.B-u.B)}else if(32<t.length){if(o<(g+=Math.abs(d.L-u.L)))continue;g+=Math.sqrt(ht(d.A-u.A)+ht(d.B-u.B))}else{if(o<(g+=ht(it(u,d))))continue;var p={},f={},M={},v={},m=st(u,d,p,f,M,v);if(o<(g+=ht(m)))continue;var x={},w={},d=lt(u,d,p.value,f.value,M.value,v.value,x,w);if(o<(g+=ht(d)))continue;g+=ot(x.value,w.value,m,d)}o<g||(o=g,n=c)}}return X[a]=n+1,n}Math.clamp||(Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))});class a{#cnt=0;#values=[];constructor(){this.#values=new Uint16Array(8192),crypto.getRandomValues(this.#values)}nextInt(t){return this.#cnt>=this.#values.length&&(this.#cnt=0),Math.floor(this.#values[this.#cnt++]/65536*(t+1))}}function e(t,a,e){if(j<1&&.15<D&&0<BlueNoise.TELL_BLUE_NOISE[4095&e]){var n=t,r=e,h=0,i=(e=a)>>>24&255,s=(i<=R&&(e=z,i=0),255&e),l=e>>>8&255,o=e>>>16&255,e=Q?ut(i,s,l,o,O,E):e,u=X[e];if(0<u)return u-1;for(var c=1e100,p=ct(i,s,l,o),f=h;f<n.length;++f){var M=255&n[f],v=n[f]>>>8&255,g=n[f]>>>16&255,d=n[f]>>>24&255,m=O?ht(d-i)/Math.exp(1.5):0;if(!(c<m)){d=ct(d,M,v,g);if(Math.abs(d.L-p.L)<n.length||N[r]<.2||.8<N[r]){if(c<(m+=ht(d.L-p.L)))continue;if(c<(m+=ht(d.A-p.A)))continue;m+=ht(d.B-p.B)}else{if(c<(m+=ht(it(p,d))))continue;var M={},v={},g={},x={},w=st(p,d,M,v,g,x);if(c<(m+=ht(w)))continue;var B={},A={},d=lt(p,d,M.value,v.value,g.value,x.value,B,A);if(c<(m+=ht(d)))continue;m+=ot(B.value,A.value,w,d)}c<m||(c=m,h=f)}}return X[e]=h+1,h}var L=a>>>24&255;if(L<=R)return pt(t,a);var I=255&a,y=a>>>8&255,T=a>>>16&255,P=(Q&&ut(L,I,y,T,O,E),K.get(a));if(!K.has(a)){(P=new Int32Array(4))[2]=P[3]=268435455;for(var q=0;q<t.length;++q){var C=255&t[q],b=t[q]>>>8&255,S=t[q]>>>16&255,F=t[q]>>>24&255,k=V*(1-J)*ht(C-I);if(!(k>=P[3])&&!((k+=j*(1-J)*ht(b-y))>=P[3]||(k+=G*(1-J)*ht(S-T))>=P[3])){O&&(k+=H*ht(F-L));for(var U=0;U<et.length&&!((k+=J*ht(et[U][0]*(C-I)))>=P[3])&&!((k+=J*ht(et[U][1]*(b-y)))>=P[3])&&!((k+=J*ht(et[U][2]*(S-T)))>=P[3]);++U);k<P[2]?(P[1]=P[0],P[3]=P[2],P[0]=q,P[2]=0|k):k<P[3]&&(P[1]=q,P[3]=0|k)}}268435455==P[3]&&(P[1]=P[0]),K.set(a,P)}u=1,(0==P[2]||_.nextInt(P[3]+P[2])<=P[3])&&(u=0),s=t.length,l=t[P[u]]>>>24&255;return P[u+2]>=s||0==P[u]||l<L?pt(t,a):P[u]}class t{#hasSemiTransparency=!1;#palette=[];#transparentPixelIndex=-1;#transparentColor=16777215;constructor(t){this.opts=t,_=new a}#find_nn(t,a,e){var n=0,r=1e100,a=t[a],h=a.cnt,i=new nt;i.alpha=a.ac,i.L=a.Lc,i.A=a.Ac,i.B=a.Bc;for(var s=a.fw;0!=s;s=t[s].fw){var l=t[s].cnt,l=h*l/(h+l);if(!(r<=l)){var o=new nt;o.alpha=t[s].ac,o.L=t[s].Lc,o.A=t[s].Ac,o.B=t[s].Bc;var u,c,p,f,M,v=l*(O?ht(o.alpha-i.alpha)/Math.exp(1.5):0);if(!(r<=v)){if(e){if(r<=(v+=(1-J)*l*Math.abs(o.L-i.L)))continue;v+=(1-J)*l*Math.sqrt(ht(o.A-i.A)+ht(o.B-i.B))}else{if(r<=(v+=(1-J)*l*ht(o.L-i.L)))continue;if(r<=(v+=(1-J)*l*ht(o.A-i.A)))continue;v+=(1-J)*l*ht(o.B-i.B)}r<=v||(f=it(i,o),r<=(v+=J*l*ht(f)))||(p=st(i,o,f={},M={},u={},c={}),r<=(v+=J*l*ht(p)))||(M=lt(i,o,f.value,M.value,u.value,c.value,o={},f={}),r<=(v+=J*l*ht(M)))||r<=(v+=J*l*ot(o.value,f.value,p,M))||(r=v,n=s)}}}a.err=Math.fround(r),a.nn=n}#pnnquan(t,a){for(var e=1,n=new Array(65536),r=(N=128<=a?null:new Float32Array(t.length),0);r<t.length;++r){var h=255&t[r],i=t[r]>>>8&255,s=t[r]>>>16&255,l=t[r]>>>24&255,o=(l<=R&&(h=255&this.#transparentColor,i=this.#transparentColor>>>8&255,s=this.#transparentColor>>>16&255,l=this.#transparentColor>>>24&255),ut(l,h,i,s,this.#hasSemiTransparency,0<=this.#transparentPixelIndex)),u=ct(l,h,i,s);null==n[o]&&(n[o]=new rt),(L=n[o]).ac+=l,L.Lc+=u.L,L.Ac+=u.A,L.Bc+=u.B,L.cnt+=1,null!=N&&(N[r]=.1+.9*u.L/100*l/255)}for(var c=0,r=0;r<n.length;++r)null!=n[r]&&(q=1/n[r].cnt,n[r].ac*=q,n[r].Lc*=q,n[r].Ac*=q,n[r].Bc*=q,n[c++]=n[r]);var p,f=ht(a)/c;if((0<=this.#transparentPixelIndex||this.#hasSemiTransparency)&&a<32&&(e=-1),D=Math.min(.9,+a/c),Q=D<=.15,(a<16&&D<.0075||D<.001||.0015<D&&D<.0022)&&(e=2),D<.04&&j<1&&j>=et[0][1]&&64<=a&&(e=0),16<a&&a<64&&Math.abs(a/8e3-D)<.001&&(e=2),W.size<=a)p=new Uint32Array(W.size),z=0,W.forEach(function(t,a){p[z++]=a,1<z&&0==(a>>>24&255)&&(p[z-1]=p[0],p[0]=a)}),this.#palette=p;else{x=a;for(var M=0<(m=e)?1<m?function(t){return Math.fround(Math.pow(t,.75))}:x<64?function(t){return 0|Math.sqrt(t)}:function(t){return Math.fround(Math.sqrt(t))}:function(t){return t},v=0;v<c-1;++v)n[v].fw=v+1,n[v+1].bk=v,n[v].cnt=M(n[v].cnt);n[v].cnt=M(n[v].cnt);for(var g,d,m,x,_=.0225<f&&!this.#hasSemiTransparency,w=(J=this.#hasSemiTransparency?.5:0!=e&&a<64?.018<f&&f<.022?Math.min(1,f+D*Math.exp(3.13)):.1<f?Math.min(1,1-D):.04<f?Math.min(1,D*Math.exp(1.56)):.025<f&&(D<.002||.0022<D)?Math.min(1,f+D*Math.exp(3.66)):Math.min(1,f+D*Math.exp(1.718)):256<a?Math.min(1,1-1/f):Math.min(1,1-.7*D),!this.#hasSemiTransparency&&e<0&&(J=Math.min(1,D*Math.exp(3.13))),new Uint32Array(n.length+1)),r=0;r<c;++r){this.#find_nn(n,r,_);for(var B=n[r].err,A=++w[0];1<A&&!(n[g=w[d=A>>1]].err<=B);A=d)w[A]=g;w[A]=r}0<e&&a<64&&.035<f&&f<.1&&(x=(0<(m=.04<f?1:-1)?.002:.0025)<D&&D<.003?1.872:1.632,J=Math.min(1,f+m*D*Math.exp(x)));for(var L,E=c-a,r=0;r<E;){for(;;){var I=w[1];if((L=n[I]).tm>=L.mtm&&n[L.nn].mtm<=L.tm)break;65535==L.mtm?I=w[1]=w[w[0]--]:(this.#find_nn(n,I,_),L.tm=r);B=n[I].err;for(A=1;(d=A+A)<=w[0]&&(d<w[0]&&n[w[d]].err>n[w[d+1]].err&&++d,!(B<=n[g=w[d]].err));A=d)w[A]=g;w[A]=I}var y=n[L.nn],T=L.cnt,P=y.cnt,q=1/(T+P);L.ac=Math.fround(q*(T*L.ac+P*y.ac)),L.Lc=Math.fround(q*(T*L.Lc+P*y.Lc)),L.Ac=Math.fround(q*(T*L.Ac+P*y.Ac)),L.Bc=Math.fround(q*(T*L.Bc+P*y.Bc)),L.cnt+=P,L.mtm=++r,n[y.bk].fw=y.fw,n[y.fw].bk=y.bk,y.mtm=65535}E<0&&(this.#palette=new Uint32Array(c));for(var C,b,S,F,k,U,z=0,r=0;z<this.#palette.length;++z)(u=new nt).alpha=this.#hasSemiTransparency||0<=this.#transparentPixelIndex?0|Math.clamp(Math.round(n[r].ac),0,255):255,u.L=n[r].Lc,u.A=n[r].Ac,u.B=n[r].Bc,this.#palette[z]=(F=U=b=S=U=b=k=F=S=b=void 0,b=(F=((C=u).L+16)/116)-C.B/200,S=(tt<(k=(S=C.A/500+F)*S*S)?k:(116*S-16)/at)*Y,F=(at*tt<C.L?F*F*F:C.L/at)*Z,k=(tt<(k=b*b*b)?k:(116*b-16)/at)*$,b=(-.9689*S+1.8758*F+.0415*k)/100,U=(.0557*S+-.204*F+1.057*k)/100,S=.0031308<(S=(3.2406*S+-1.5372*F+-.4986*k)/100)?1.055*Math.pow(S,1/2.4)-.055:12.92*S,b=.0031308<b?1.055*Math.pow(b,1/2.4)-.055:12.92*b,U=.0031308<U?1.055*Math.pow(U,1/2.4)-.055:12.92*U,F=0|Math.clamp(Math.round(C.alpha),0,255),S=0|Math.clamp(Math.round(255*S),0,255),b=0|Math.clamp(Math.round(255*b),0,255),F<<24|(0|Math.clamp(Math.round(255*U),0,255))<<16|b<<8|S),r=n[r].fw}}quantizeImage(){for(var t,a=this.opts.pixels,e=(this.opts.width,this.opts.height,this.opts.colors),n=(this.opts.dithering,this.opts.alphaThreshold&&(R=this.opts.alphaThreshold),this.clear(),E=!1,0),r=0;r<a.length;++r){var h=a[r]>>>24&255;-1<this.#transparentPixelIndex&&0==h&&(a[r]=this.#transparentColor),h<224&&(0==h?(this.#transparentPixelIndex=r,E=!0,2<e?this.#transparentColor=a[r]:a[r]=this.#transparentColor):R<h&&++n)}if(this.#hasSemiTransparency=O=0<n,e<=32?V=j=G=H=1:(V=et[0][0],j=et[0][1],G=et[0][2]),z=this.#transparentColor,this.#palette=new Uint32Array(e),2<e?this.#pnnquan(a,e):(D=1,0<=this.#transparentPixelIndex?(this.#palette[0]=this.#transparentColor,this.#palette[1]=255<<24):(this.#palette[0]=255<<24,this.#palette[1]=4294967295)),O&&(D*=-1),this.opts.dithering&&null==N&&(e<=256||.99<D)){N=new Float32Array(a.length);for(r=0;r<a.length;++r){var i=255&a[r],s=a[r]>>>8&255,l=a[r]>>>16&255,i=ct(h=a[r]>>>24&255,i,s,l);N[r]=.1+.9*i.L/100*h/255}}return 0<=this.#transparentPixelIndex&&2<this.#palette.length&&(t=pt(this.#palette,a[this.#transparentPixelIndex],this.#transparentPixelIndex),this.#palette[t]=this.#transparentColor),this.opts.dithering?{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),saliencies:N,transparent:this.getTransparentIndex(),type:this.getImgType(),weight:D,weightB:1}:(t=.023<(t=ht(e)/W.size)?1:Math.fround(37.013*t+.906),{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),saliencies:N,transparent:this.getTransparentIndex(),type:this.getImgType(),weight:D,weightB:t})}getPalette(){return this.#palette.buffer}getImgType(){return 256<this.opts.colors||this.#hasSemiTransparency?"image/png":"image/gif"}getTransparentIndex(){return-1<this.#transparentPixelIndex?0:-1}getDitherFn(){return this.#palette.length<4?pt:e}getColorIndex(t,a,e,n){return ut(t,a,e,n,O,E)}getResult(){var e=this;return new Promise(function(t,a){t(e.quantizeImage())})}clear(){K=new Map,W=new Map,X=[]}}this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);