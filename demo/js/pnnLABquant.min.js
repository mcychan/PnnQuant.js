!function(){"use strict";var A,N,O=15,B=!1,L=!1,m=.299,Q=.587,g=.114,w=.3333,x=new t,R=1,I=new Array(65536),j=new Map,y=new Uint16Array(65536),G=95.047,H=100,J=108.883,K=.008856,V=903.3,W=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function X(){this.alpha=255,this.A=this.B=this.L=0}function Y(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function t(){this.nextInt=function(t){return Math.floor(Math.random()*(t+1))}}function Z(t){return t*t}function l(t){return K<t?Math.fround(Math.cbrt(t)):Math.fround((V*t+16)/116)}function M(t){return Math.fround(t*(Math.PI/180))}function T(t,a){var n=a.L-t.L,t=(t.L+a.L)/2,a=1+.015*Z(t-50)/Math.sqrt(20+Z(t-50));return Math.fround(n/a)}function P(t,a,n,e,r,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,h=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625))),h=(n.value=(1+h)*t.A,e.value=(1+h)*a.A,r.value=Math.sqrt(n.value*n.value+t.B*t.B),i.value=Math.sqrt(e.value*e.value+a.B*a.B),i.value-r.value);return Math.fround(h/(1+.045*((r.value+i.value)/2)))}function q(t,a,n,e,r,i,h,s){var l,o,u,c=M(360),p=M(180),f=r*i,t=(0==t.B&&0==n?l=0:(l=Math.atan2(t.B,n))<0&&(l+=c),0==a.B&&0==e?o=0:(o=Math.atan2(a.B,e))<0&&(o+=c),0==f?u=0:(u=o-l)<-p?u+=c:p<u&&(u-=c),2*Math.sqrt(f)*Math.sin(u/2)),n=l+o,a=(r*i==0?s.value=n:Math.abs(l-o)<=p?s.value=n/2:s.value=n<c?(n+c)/2:(n-c)/2,h.value=(r+i)/2,1-.17*Math.cos(s.value-M(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+M(6))-.2*Math.cos(4*s.value-M(63))),e=1+.015*h.value*a;return Math.fround(t/e)}function C(t,a,n,e){a=M(30)*Math.exp(-Math.pow((a-M(275))/M(25),2)),t=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625)),a=-Math.sin(2*a)*t;return Math.fround(a*n*e)}function $(t,a,n,e,r,i){return r?(240&t)<<8|(240&a)<<4|240&n|e>>4:i?(128&t)<<8|(248&a)<<7|(248&n)<<2|e>>3:(248&a)<<8|(252&n)<<3|e>>3}function tt(t,a,n,e){var r,i,h=t<<24|e<<16|n<<8|a,s=j.get(h);return j.has(h)||(t=t,n=n,e=e,n/=255,e/=255,r=l(100*(.4124*(a=(a=(a=a)/255)<.04045?a/12.92:Math.pow((.055+a)/1.055,2.4))+.3576*(n=n<.04045?n/12.92:Math.pow((.055+n)/1.055,2.4))+.1805*(e=e<.04045?e/12.92:Math.pow((.055+e)/1.055,2.4)))/G),i=l(100*(.2126*a+.7152*n+.0722*e)/H),a=l(100*(.0193*a+.1192*n+.9505*e)/J),(n=new X).alpha=t,n.L=Math.max(0,116*i-16),n.A=500*(r-i),n.B=200*(i-a),s=n,j.set(h,s)),s}function b(t,a,n){var e=0,r=a>>>24&255,i=(r<=O&&(a=A,r=0),255&a),h=a>>>8&255,s=a>>>16&255,a=$(r,i,h,s,L,B),l=y[a];if(0<l)return l-1;2<t.length&&B&&O<r&&(e=1);for(var o=1e100,u=tt(r,i,h,s),c=e;c<t.length;++c){var p=255&t[c],f=t[c]>>>8&255,M=t[c]>>>16&255,v=t[c]>>>24&255,d=L?Z(v-r)/Math.exp(1.5):0;if(!(o<d)){var m=tt(v,p,f,M);if(t.length<=4)d=Z(p-i)+Z(f-h)+Z(M-s),L&&(d+=Z(v-r));else if(L||t.length<16){if(o<(d+=Z(m.L-u.L)))continue;if(o<(d+=Z(m.A-u.A)))continue;d+=Z(m.B-u.B)}else if(32<t.length){if(o<(d+=Math.abs(m.L-u.L)))continue;d+=Math.sqrt(Z(m.A-u.A)+Z(m.B-u.B))}else{if(o<(d+=Z(T(u,m))))continue;var p={},f={},M={},v={},g=P(u,m,p,f,M,v);if(o<(d+=Z(g)))continue;var w={},x={},m=q(u,m,p.value,f.value,M.value,v.value,w,x);if(o<(d+=Z(m)))continue;d+=C(w.value,x.value,g,m)}o<d||(o=d,e=c)}}return y[a]=e+1,e}function a(t,a,n){if(Q<W[0][1]&&-88<BlueNoise.TELL_BLUE_NOISE[4095&n])return b(t,a);var e=a>>>24&255;if(e<=O)return b(t,a);var r=255&a,i=a>>>8&255,h=a>>>16&255,n=$(e,r,i,h,L,B),s=I[n];if(null==I){(s=new Uint32Array(4))[2]=s[3]=4294967295;for(var l=0;l<t.length;++l){var o=255&t[l],u=t[l]>>>8&255,c=t[l]>>>16&255,p=t[l]>>>24&255,f=m*(1-R)*Z(o-r);if(!(f>=s[3])&&!((f+=Q*(1-R)*Z(u-i))>=s[3]||(f+=g*(1-R)*Z(c-h))>=s[3])){L&&(f+=w*Z(p-e));for(var M=0;M<W.length&&!((f+=R*Z(W[M][0]*(o-r)))>=s[3])&&!((f+=R*Z(W[M][1]*(u-i)))>=s[3])&&!((f+=R*Z(W[M][2]*(c-h)))>=s[3]);++M);f<s[2]?(s[1]=s[0],s[3]=s[2],s[0]=l,s[2]=0|f):f<s[3]&&(s[1]=l,s[3]=0|f)}}4294967295==s[3]&&(s[1]=s[0]),I[n]=s}var n=1,v=((0==s[2]||x.nextInt(s[3]+s[2])<=s[3])&&(n=0),t.length),d=t[s[n]]>>>24&255;return s[n+2]>=v||0==s[n]||d<e?b(t,a):s[n]}Math.clamp||(Math.clamp=function(t,a,n){return this.max(a,this.min(n,t))});class n{#hasSemiTransparency=!1;#palette=[];#saliencies=null;#transparentPixelIndex=-1;#transparentColor=16777215;constructor(t){this.opts=t}#find_nn(t,a,n){var e=0,r=1e100,a=t[a],i=a.cnt,h=new X;h.alpha=a.ac,h.L=a.Lc,h.A=a.Ac,h.B=a.Bc;for(var s=a.fw;0!=s;s=t[s].fw){var l=t[s].cnt,l=i*l/(i+l);if(!(r<=l)){var o=new X;o.alpha=t[s].ac,o.L=t[s].Lc,o.A=t[s].Ac,o.B=t[s].Bc;var u,c,p,f,M,v=l*(L?Z(o.alpha-h.alpha)/Math.exp(1.5):0);if(!(r<=v)){if(n){if(r<=(v+=(1-R)*l*Math.abs(o.L-h.L)))continue;v+=(1-R)*l*Math.sqrt(Z(o.A-h.A)+Z(o.B-h.B))}else{if(r<=(v+=(1-R)*l*Z(o.L-h.L)))continue;if(r<=(v+=(1-R)*l*Z(o.A-h.A)))continue;v+=(1-R)*l*Z(o.B-h.B)}r<=v||(f=T(h,o),r<=(v+=R*l*Z(f)))||(p=P(h,o,f={},M={},u={},c={}),r<=(v+=R*l*Z(p)))||(M=q(h,o,f.value,M.value,u.value,c.value,o={},f={}),r<=(v+=R*l*Z(M)))||r<=(v+=R*l*C(o.value,f.value,p,M))||(r=v,e=s)}}}a.err=Math.fround(r),a.nn=e}#pnnquan(t,a){for(var n=1,e=new Array(65536),r=128<=a?null:new Float32Array(t.length),i=0;i<t.length;++i){var h=255&t[i],s=t[i]>>>8&255,l=t[i]>>>16&255,o=t[i]>>>24&255,u=(o<=O&&(h=255&this.#transparentColor,s=this.#transparentColor>>>8&255,l=this.#transparentColor>>>16&255,o=this.#transparentColor>>>24&255),$(o,h,s,l,this.#hasSemiTransparency,0<=this.#transparentPixelIndex)),c=tt(o,h,s,l);null==e[u]&&(e[u]=new Y),(L=e[u]).ac+=o,L.Lc+=c.L,L.Ac+=c.A,L.Bc+=c.B,L.cnt+=1,null!=r&&(r[i]=.1+.9*c.L/100*o/255)}this.#saliencies=r;for(var p=0,i=0;i<e.length;++i)null!=e[i]&&(q=1/e[i].cnt,e[i].ac*=q,e[i].Lc*=q,e[i].Ac*=q,e[i].Bc*=q,e[p++]=e[i]);var f,M=Z(a)/p;if((0<=this.#transparentPixelIndex||this.#hasSemiTransparency)&&a<32&&(n=-1),N=Math.min(.9,+a/p),(a<16&&N<.0075||N<.001||.0015<N&&N<.0022)&&(n=2),N<.04&&Q<1&&Q>=W[0][1]&&64<=a&&(n=0),16<a&&a<64&&Math.abs(a/8e3-N)<.001&&(n=2),j.size<=a)f=new Uint32Array(j.size),z=0,j.forEach(function(t,a){f[z++]=a,1<z&&0==(a>>>24&255)&&(f[z-1]=f[0],f[0]=a)}),this.#palette=f;else{w=a;for(var _=0<(g=n)?1<g?function(t){return Math.fround(Math.pow(t,.75))}:w<64?function(t){return 0|Math.sqrt(t)}:function(t){return Math.fround(Math.sqrt(t))}:function(t){return t},v=0;v<p-1;++v)e[v].fw=v+1,e[v+1].bk=v,e[v].cnt=_(e[v].cnt);e[v].cnt=_(e[v].cnt);for(var d,m,g,w,E=.0225<M&&!this.#hasSemiTransparency,x=(R=this.#hasSemiTransparency?.5:0!=n&&a<64?.018<M&&M<.022?Math.min(1,M+N*Math.exp(3.13)):.1<M?Math.min(1,1-N):.04<M?Math.min(1,N*Math.exp(1.56)):.025<M&&(N<.002||.0022<N)?Math.min(1,M+N*Math.exp(3.66)):Math.min(1,M+N*Math.exp(1.718)):256<a?Math.min(1,1-1/M):Math.min(1,1-.7*N),!this.#hasSemiTransparency&&n<0&&(R=Math.min(1,N*Math.exp(3.13))),new Uint32Array(e.length+1)),i=0;i<p;++i){this.#find_nn(e,i,E);for(var A=e[i].err,B=++x[0];1<B&&!(e[d=x[m=B>>1]].err<=A);B=m)x[B]=d;x[B]=i}0<n&&a<64&&.035<M&&M<.1&&(w=(0<(g=.04<M?1:-1)?.002:.0025)<N&&N<.003?1.872:1.632,R=Math.min(1,M+g*N*Math.exp(w)));for(var L,D=p-a,i=0;i<D;){for(;;){var I=x[1];if((L=e[I]).tm>=L.mtm&&e[L.nn].mtm<=L.tm)break;65535==L.mtm?I=x[1]=x[x[0]--]:(this.#find_nn(e,I,E),L.tm=i);A=e[I].err;for(B=1;(m=B+B)<=x[0]&&(m<x[0]&&e[x[m]].err>e[x[m+1]].err&&++m,!(A<=e[d=x[m]].err));B=m)x[B]=d;x[B]=I}var y=e[L.nn],T=L.cnt,P=y.cnt,q=1/(T+P);L.ac=Math.fround(q*(T*L.ac+P*y.ac)),L.Lc=Math.fround(q*(T*L.Lc+P*y.Lc)),L.Ac=Math.fround(q*(T*L.Ac+P*y.Ac)),L.Bc=Math.fround(q*(T*L.Bc+P*y.Bc)),L.cnt+=P,L.mtm=++i,e[y.bk].fw=y.fw,e[y.fw].bk=y.bk,y.mtm=65535}D<0&&(this.#palette=new Uint32Array(p));for(var C,b,S,U,F,k,z=0,i=0;z<this.#palette.length;++z)(c=new X).alpha=this.#hasSemiTransparency||0<=this.#transparentPixelIndex?0|Math.clamp(Math.round(e[i].ac),0,255):255,c.L=e[i].Lc,c.A=e[i].Ac,c.B=e[i].Bc,this.#palette[z]=(U=k=b=S=k=b=F=U=S=b=void 0,b=(U=((C=c).L+16)/116)-C.B/200,S=(K<(F=(S=C.A/500+U)*S*S)?F:(116*S-16)/V)*G,U=(V*K<C.L?U*U*U:C.L/V)*H,F=(K<(F=b*b*b)?F:(116*b-16)/V)*J,b=(-.9689*S+1.8758*U+.0415*F)/100,k=(.0557*S+-.204*U+1.057*F)/100,S=.0031308<(S=(3.2406*S+-1.5372*U+-.4986*F)/100)?1.055*Math.pow(S,1/2.4)-.055:12.92*S,b=.0031308<b?1.055*Math.pow(b,1/2.4)-.055:12.92*b,k=.0031308<k?1.055*Math.pow(k,1/2.4)-.055:12.92*k,U=0|Math.clamp(Math.round(C.alpha),0,255),S=0|Math.clamp(Math.round(255*S),0,255),b=0|Math.clamp(Math.round(255*b),0,255),U<<24|(0|Math.clamp(Math.round(255*k),0,255))<<16|b<<8|S),i=e[i].fw}}quantizeImage(){for(var t,a=this.opts.pixels,n=(this.opts.width,this.opts.height,this.opts.colors),e=(this.opts.dithering,this.opts.alphaThreshold&&(O=this.opts.alphaThreshold),this.clear(),B=!1,0),r=0;r<a.length;++r){var i=a[r]>>>24&255;-1<this.#transparentPixelIndex&&0==i&&(a[r]=this.#transparentColor),i<224&&(0==i?(this.#transparentPixelIndex=r,B=!0,2<n?this.#transparentColor=a[r]:a[r]=this.#transparentColor):O<i&&++e)}if(this.#hasSemiTransparency=L=0<e,n<=32?m=Q=g=w=1:(m=W[0][0],Q=W[0][1],g=W[0][2]),A=this.#transparentColor,this.#palette=new Uint32Array(n),2<n?this.#pnnquan(a,n):(N=1,0<=this.#transparentPixelIndex?(this.#palette[0]=this.#transparentColor,this.#palette[1]=255<<24):(this.#palette[0]=255<<24,this.#palette[1]=4294967295)),L&&(N*=-1),this.opts.dithering&&null==this.#saliencies&&(n<=256||.99<N)){for(var h=new Float32Array(a.length),r=0;r<a.length;++r){var s=255&a[r],l=a[r]>>>8&255,o=a[r]>>>16&255,s=tt(i=a[r]>>>24&255,s,l,o);h[r]=.1+.9*s.L/100*i/255}this.#saliencies=h}return 0<=this.#transparentPixelIndex&&2<this.#palette.length&&(t=b(this.#palette,a[this.#transparentPixelIndex],this.#transparentPixelIndex),this.#palette[t]=this.#transparentColor),this.opts.dithering?{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),saliencies:this.#saliencies,transparent:this.getTransparentIndex(),type:this.getImgType(),weight:N,weightB:1}:(t=.023<(t=Z(n)/j.size)?1:Math.fround(37.013*t+.906),{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),saliencies:this.#saliencies,transparent:this.getTransparentIndex(),type:this.getImgType(),weight:N,weightB:t})}getPalette(){return this.#palette.buffer}getImgType(){return 256<this.opts.colors||this.#hasSemiTransparency?"image/png":"image/gif"}getTransparentIndex(){return-1<this.#transparentPixelIndex?0:-1}getDitherFn(){return this.#palette.length<4?b:a}getColorIndex(t,a,n,e){return $(t,a,n,e,L,B)}getResult(){var n=this;return new Promise(function(t,a){t(n.quantizeImage())})}clear(){I=new Array(65536),j=new Map,y=new Uint16Array(65536),x=new t}}this.PnnLABQuant=n,"undefined"!=typeof module&&module.exports&&(module.exports=n)}.call(this);