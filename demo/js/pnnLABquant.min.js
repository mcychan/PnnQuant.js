!function(){function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,a){return this.max(e,this.min(a,t))});var A,d,N,y,Q=15,B=!(Math.randomInt=function(t){return Math.floor(Math.random()*(t+1))}),I=!1,g=.299,R=.587,x=.114,w=.3333,j=1,G=95.047,H=100,J=108.883,K=.008856,V=903.3;function W(){this.alpha=255,this.A=this.B=this.L=0}var X=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function Y(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function o(t){return K<t?Math.fround(Math.cbrt(t)):Math.fround((V*t+16)/116)}function M(t){return Math.fround(t*(Math.PI/180))}function L(t,e){var a=e.L-t.L,t=(t.L+e.L)/2,e=1+.015*$(t-50)/Math.sqrt(20+$(t-50));return Math.fround(a/e)}function P(t,e,a,n,r,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(e.A*e.A+e.B*e.B))/2,h=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625))),h=(a.value=(1+h)*t.A,n.value=(1+h)*e.A,r.value=Math.sqrt(a.value*a.value+t.B*t.B),i.value=Math.sqrt(n.value*n.value+e.B*e.B),i.value-r.value);return Math.fround(h/(1+.045*((r.value+i.value)/2)))}function _(t,e,a,n,r,i,h,s){var o,l,p,u=M(360),c=M(180),f=r*i,t=(0==t.B&&0==a?o=0:(o=Math.atan2(t.B,a))<0&&(o+=u),0==e.B&&0==n?l=0:(l=Math.atan2(e.B,n))<0&&(l+=u),0==f?p=0:(p=l-o)<-c?p+=u:c<p&&(p-=u),2*Math.sqrt(f)*Math.sin(p/2)),a=o+l,e=(r*i==0?s.value=a:Math.abs(o-l)<=c?s.value=a/2:s.value=a<u?(a+u)/2:(a-u)/2,h.value=(r+i)/2,1-.17*Math.cos(s.value-M(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+M(6))-.2*Math.cos(4*s.value-M(63))),n=1+.015*h.value*e;return Math.fround(t/n)}function q(t,e,a,n){e=M(30)*Math.exp(-Math.pow((e-M(275))/M(25),2)),t=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625)),e=-Math.sin(2*e)*t;return Math.fround(e*a*n)}function Z(t,e,a,n,r,i){return r?(240&t)<<8|(240&e)<<4|240&a|n>>4:i?(128&t)<<8|(248&e)<<7|(248&a)<<2|n>>3:(248&e)<<8|(252&a)<<3|n>>3}function $(t){return t*t}function tt(t,e,a,n){var r,i,h=t<<24|n<<16|a<<8|e,s=N.get(h);return N.has(h)||(t=t,a=a,n=n,a/=255,n/=255,r=o(100*(.4124*(e=(e=(e=e)/255)<.04045?e/12.92:Math.pow((.055+e)/1.055,2.4))+.3576*(a=a<.04045?a/12.92:Math.pow((.055+a)/1.055,2.4))+.1805*(n=n<.04045?n/12.92:Math.pow((.055+n)/1.055,2.4)))/G),i=o(100*(.2126*e+.7152*a+.0722*n)/H),e=o(100*(.0193*e+.1192*a+.9505*n)/J),(a=new W).alpha=t,a.L=Math.max(0,116*i-16),a.A=500*(r-i),a.B=200*(i-e),s=a,N.set(h,s)),s}function et(t,e,a){var n=0,r=1e100,e=t[e],i=e.cnt,h=new W;h.alpha=e.ac,h.L=e.Lc,h.A=e.Ac,h.B=e.Bc;for(var s=e.fw;0!=s;s=t[s].fw){var o=t[s].cnt,o=i*o/(i+o);if(!(r<=o)){var l=new W;l.alpha=t[s].ac,l.L=t[s].Lc,l.A=t[s].Ac,l.B=t[s].Bc;var p,u,c,f,M,m=o*(I?$(l.alpha-h.alpha)/Math.exp(1.5):0);if(!(r<=m)){if(a){if(r<=(m+=(1-j)*o*Math.abs(l.L-h.L)))continue;m+=(1-j)*o*Math.sqrt($(l.A-h.A)+$(l.B-h.B))}else{if(r<=(m+=(1-j)*o*$(l.L-h.L)))continue;if(r<=(m+=(1-j)*o*$(l.A-h.A)))continue;m+=(1-j)*o*$(l.B-h.B)}r<=m||(f=L(h,l),r<=(m+=j*o*$(f)))||(c=P(h,l,f={},M={},p={},u={}),r<=(m+=j*o*$(c)))||(M=_(h,l,f.value,M.value,p.value,u.value,l={},f={}),r<=(m+=j*o*$(M)))||r<=(m+=j*o*q(l.value,f.value,c,M))||(r=m,n=s)}}}e.err=Math.fround(r),e.nn=n}function C(t,e,a){var n=y.get(e);if(y.has(e))return n;for(var r=0,i=e>>>24&255,h=(i<=Q&&(e=A,i=0),2<t.length&&B&&Q<i&&(r=1),255&e),s=e>>>8&255,o=e>>>16&255,l=1e100,p=tt(i,h,s,o),u=r;u<t.length;++u){var c=255&t[u],f=t[u]>>>8&255,M=t[u]>>>16&255,m=t[u]>>>24&255,v=I?$(m-i)/Math.exp(1.5):0;if(!(l<v)){var d=tt(m,c,f,M);if(t.length<=4)v=$(c-h)+$(f-s)+$(M-o),I&&(v+=$(m-i));else if(I||t.length<16){if(l<(v+=$(d.L-p.L)))continue;if(l<(v+=$(d.A-p.A)))continue;v+=$(d.B-p.B)}else if(32<t.length){if(l<(v+=Math.abs(d.L-p.L)))continue;v+=Math.sqrt($(d.A-p.A)+$(d.B-p.B))}else{if(l<(v+=$(L(p,d))))continue;var c={},f={},M={},m={},g=P(p,d,c,f,M,m);if(l<(v+=$(g)))continue;var x={},w={},d=_(p,d,c.value,f.value,M.value,m.value,x,w);if(l<(v+=$(d)))continue;v+=q(x.value,w.value,g,d)}l<v||(l=v,r=u)}}return y.set(e,r),r}function b(t,e,a){if(R<X[0][1]&&-88<TELL_BLUE_NOISE[4095&a])return C(t,e);var n=e>>>24&255;if(n<=Q)return C(t,e);var r=d.get(e);if(!d.has(e)){(r=new Uint32Array(4))[2]=r[3]=4294967295;for(var i=255&e,h=e>>>8&255,s=e>>>16&255,o=0;o<t.length;++o){var l=255&t[o],p=t[o]>>>8&255,u=t[o]>>>16&255,c=t[o]>>>24&255,f=g*(1-j)*$(l-i);if(!(f>=r[3])&&!((f+=R*(1-j)*$(p-h))>=r[3]||(f+=x*(1-j)*$(u-s))>=r[3])){I&&(f+=w*$(c-n));for(var M=0;M<X.length&&!((f+=j*$(X[M][0]*(l-i)))>=r[3])&&!((f+=j*$(X[M][1]*(p-h)))>=r[3])&&!((f+=j*$(X[M][2]*(u-s)))>=r[3]);++M);f<r[2]?(r[1]=r[0],r[3]=r[2],r[0]=o,r[2]=0|f):f<r[3]&&(r[1]=o,r[3]=0|f)}}4294967295==r[3]&&(r[1]=r[0]),d.set(e,r)}var a=1,m=((0==r[2]||Math.randomInt(r[3]+r[2])<=r[3])&&(a=0),t.length);return r[a+2]>=m||B&&0==r[a]?C(t,e):r[a]}t.prototype.pnnquan=function(t,e){for(var a=1,n=new Array(65536),r=128<=e?null:new Float32Array(t.length),i=0;i<t.length;++i){var h=255&t[i],s=t[i]>>>8&255,o=t[i]>>>16&255,l=t[i]>>>24&255,p=(l<=Q&&(h=255&this.m_transparentColor,s=this.m_transparentColor>>>8&255,o=this.m_transparentColor>>>16&255,l=this.m_transparentColor>>>24&255,t[i]=this.m_transparentColor),Z(l,h,s,o,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)),u=tt(l,h,s,o);null==n[p]&&(n[p]=new Y),(B=n[p]).ac+=l,B.Lc+=u.L,B.Ac+=u.A,B.Bc+=u.B,B.cnt+=1,null!=r&&(r[i]=(.1+.9*u.L/100)*l/255)}this.opts.saliencies=r;for(var c=0,i=0;i<n.length;++i)null!=n[i]&&(q=1/n[i].cnt,n[i].ac*=q,n[i].Lc*=q,n[i].Ac*=q,n[i].Bc*=q,n[c++]=n[i]);var f,M=$(e)/c,m=((0<=this.m_transparentPixelIndex||this.hasSemiTransparency)&&e<32&&(a=-1),this.opts.weight=Math.min(.9,+e/c));if((e<16&&m<.0075||m<.001||.0015<m&&m<.0022)&&(a=2),m<.04&&R<1&&R>=X[0][1]&&64<=e&&(a=0),16<e&&e<64&&Math.abs(e/8e3-m)<.001&&(a=2),N.size<=e)f=new Uint32Array(N.size),k=0,N.forEach(function(t,e){f[k++]=e,1<k&&0==(e>>>24&255)&&(f[k-1]=f[0],f[0]=e)}),this.palette=f;else{F=e;for(var F,E=0<(x=a)?1<x?function(t){return Math.fround(Math.pow(t,.75))}:F<64?function(t){return 0|Math.sqrt(t)}:function(t){return Math.fround(Math.sqrt(t))}:function(t){return t},v=0;v<c-1;++v)n[v].fw=v+1,n[v+1].bk=v,n[v].cnt=E(n[v].cnt);n[v].cnt=E(n[v].cnt);for(var d,g,x,D=.0275<M,w=(j=this.hasSemiTransparency?.5:0!=a&&e<64?.018<M&&M<.022?Math.min(1,M+m*Math.exp(3.13)):.1<M?Math.min(1,1-m):.04<M?Math.min(1,m*Math.exp(1.56)):.025<M&&(m<.002||.0022<m)?Math.min(1,M+m*Math.exp(3.66)):Math.min(1,M+m*Math.exp(1.718)):256<e?Math.min(1,1-1/M):Math.min(1,1-.7*m),!this.hasSemiTransparency&&a<0&&(j=Math.min(1,m*Math.exp(3.13))),new Uint32Array(n.length+1)),i=0;i<c;++i){et(n,i,D);for(var A=n[i].err,y=++w[0];1<y&&!(n[d=w[g=y>>1]].err<=A);y=g)w[y]=d;w[y]=i}0<a&&e<64&&.035<M&&M<.1&&(x=.04<M?1:-1,j=Math.min(1,M+x*m*Math.exp((0<x?.002:.0025)<m&&m<.003?1.872:1.632)));for(var B,O=c-e,i=0;i<O;){for(;;){var I=w[1];if((B=n[I]).tm>=B.mtm&&n[B.nn].mtm<=B.tm)break;65535==B.mtm?I=w[1]=w[w[0]--]:(et(n,I,D&&M<1),B.tm=i);A=n[I].err;for(y=1;(g=y+y)<=w[0]&&(g<w[0]&&n[w[g]].err>n[w[g+1]].err&&++g,!(A<=n[d=w[g]].err));y=g)w[y]=d;w[y]=I}var L=n[B.nn],P=B.cnt,_=L.cnt,q=1/(P+_);B.ac=Math.fround(q*(P*B.ac+_*L.ac)),B.Lc=Math.fround(q*(P*B.Lc+_*L.Lc)),B.Ac=Math.fround(q*(P*B.Ac+_*L.Ac)),B.Bc=Math.fround(q*(P*B.Bc+_*L.Bc)),B.cnt+=_,B.mtm=++i,n[L.bk].fw=L.fw,n[L.fw].bk=L.bk,L.mtm=65535}O<0&&(this.palette=new Uint32Array(c));for(var T,C,b,S,U,z,k=0,i=0;k<this.palette.length;++k)(u=new W).alpha=this.hasSemiTransparency||0<=this.m_transparentPixelIndex?0|Math.clamp(Math.round(n[i].ac),0,255):255,u.L=n[i].Lc,u.A=n[i].Ac,u.B=n[i].Bc,this.palette[k]=(S=z=C=b=z=C=U=S=b=C=void 0,C=(S=((T=u).L+16)/116)-T.B/200,b=(K<(U=(b=T.A/500+S)*b*b)?U:(116*b-16)/V)*G,S=(V*K<T.L?S*S*S:T.L/V)*H,U=(K<(U=C*C*C)?U:(116*C-16)/V)*J,C=(-.9689*b+1.8758*S+.0415*U)/100,z=(.0557*b+-.204*S+1.057*U)/100,b=.0031308<(b=(3.2406*b+-1.5372*S+-.4986*U)/100)?1.055*Math.pow(b,1/2.4)-.055:12.92*b,C=.0031308<C?1.055*Math.pow(C,1/2.4)-.055:12.92*C,z=.0031308<z?1.055*Math.pow(z,1/2.4)-.055:12.92*z,S=0|Math.clamp(Math.round(T.alpha),0,255),b=0|Math.clamp(Math.round(255*b),0,255),C=0|Math.clamp(Math.round(255*C),0,255),S<<24|(0|Math.clamp(Math.round(255*z),0,255))<<16|C<<8|b),i=n[i].fw}},t.prototype.quantize_image=function(t,e,a,n,r){var i=new(256<e?Uint16Array:Uint8Array)(t.length),h=0;if(r){for(var s=256,r=4*(a+2),o=new Int32Array(1024),l=new Int32Array(512),p=0;p<s;++p)o[p]=0,o[p+s]=p,o[p+512]=255,o[p+768]=255,l[p]=-16,l[p+s]=16;for(p=-16;p<=16;++p)l[p+s]=p,16<e&&p%4==3&&(l[p+s]=0);for(var u=this.hasSemiTransparency||e<64,c=1,f=new Int32Array(r),M=new Int32Array(r),m=new Int32Array(65536),p=0;p<n;++p){c<0&&(h+=a-1);for(var v=4,d=4*a,g=M[d]=M[d+1]=M[d+2]=M[d+3]=0;g<a;++g){var x=255&t[h],w=t[h]>>>24&255,A=(B=w,x=x,P=t[h]>>>8&255,T=t[h]>>>16&255,L=o,I=f,y=v,A=u,_=void 0,_=new Int32Array(4),A?(_[0]=L[(I[y]+4104>>4)+x],_[1]=L[(I[y+1]+4104>>4)+P],_[2]=L[(I[y+2]+4104>>4)+T],_[3]=L[(I[y+3]+4104>>4)+B]):(_[0]=L[(I[y]+8208>>5)+x],_[1]=L[(I[y+1]+4104>>4)+P],_[2]=L[(I[y+2]+8208>>5)+T],_[3]=B),_),y=(x=A[3])<<24|(P=A[2])<<16|(L=A[1])<<8|(I=A[0]),B=(u?(0==m[T=Z(x,I,L,P,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)]&&(m[T]=0==w?1:C(this.palette,y)+1),i[h]=m[T]-1):i[h]=0==w?0:b(this.palette,y,p+g),this.palette[i[h]]),I=l[I-(255&B)+s],L=l[L-(B>>>8&255)+s],P=l[P-(B>>>16&255)+s],x=l[x-(B>>>24&255)+s],_=2*I;M[d-4]=I,M[d+4]+=I+=_,M[d]+=I+=_,f[v+4]+=I+_,_=2*L,M[d+1-4]=L,M[d+1+4]+=L+=_,M[d+1]+=L+=_,f[v+1+4]+=L+_,_=2*P,M[d+2-4]=P,M[d+2+4]+=P+=_,M[d+2]+=P+=_,f[v+2+4]+=P+_,_=2*x,M[d+3-4]=x,M[d+3+4]+=x+=_,M[d+3]+=x+=_,f[v+3+4]+=x+_,v+=4,d-=4,h+=c}p%2==1&&(h+=a+1),c*=-1;var q=f,f=M,M=q}}else for(var B,P,T,L,I,y,A,_,p=0;p<i.length;++p)i[p]=this.getDitherFn()(this.palette,t[p],p);return this.qPixels=i,this.qPixels},t.prototype.quantizeImage=function(){for(var t,e=this.opts.pixels,a=this.opts.width,n=this.opts.height,r=this.opts.colors,i=this.opts.dithering,h=(this.opts.alphaThreshold&&(Q=this.opts.alphaThreshold),N=new Map,d=new Map,y=new Map,B=!1,0),s=0;s<e.length;++s)(l=e[s]>>>24&255)<224&&(0==l?(this.m_transparentPixelIndex=s,B=!0,2<r?this.m_transparentColor=e[s]:e[s]=this.m_transparentColor):Q<l&&++h);if(this.hasSemiTransparency=I=0<h,r<=32?g=R=x=w=1:(g=X[0][0],R=X[0][1],x=X[0][2]),A=this.m_transparentColor,this.palette=new Uint32Array(r),2<r?this.pnnquan(e,r):(this.opts.weight=1,0<=this.m_transparentPixelIndex?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295)),this.opts.dithering||(t=$(r)/N.size,this.opts.weightB=.023<t?1:Math.fround(37.013*t+.906)),I&&(this.opts.weight*=-1),this.opts.dithering&&null==this.opts.saliencies&&(r<=256||.99<this.opts.weight)){for(var o=new Float32Array(e.length),s=0;s<e.length;++s){var l,p=255&e[s],u=e[s]>>>8&255,c=e[s]>>>16&255,p=tt(l=e[s]>>>24&255,p,u,c);o[s]=(.1+.9*p.L/100)*l/255}this.opts.saliencies=o}if(0<=this.m_transparentPixelIndex&&2<this.palette.length&&(t=C(this.palette,e[this.m_transparentPixelIndex],this.m_transparentPixelIndex),this.palette[t]=this.m_transparentColor),this.opts.paletteOnly)return this.opts.ditherFn=this.getDitherFn(),this.opts.getColorIndex=this.getColorIndex,this.opts.palette=this.palette,this.palette;this.quantize_image(e,r,a,n,i);for(var f=this.palette,M=this.qPixels,m=new Uint32Array(M.length),v=0;v<M.length;++v)m[v]=f[M[v]];return m},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return 256<this.opts.colors||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return-1<this.m_transparentPixelIndex?0:-1},t.prototype.getDitherFn=function(){return-1<this.m_transparentPixelIndex||this.opts.colors<4?C:b},t.prototype.getColorIndex=function(t,e,a,n){return Z(t,e,a,n,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)},t.prototype.getResult=function(){var n=this;return new Promise(function(t,e){var a=n.quantizeImage();n.opts.paletteOnly?t({pal8:a,indexedPixels:n.getIndexedPixels(),transparent:n.getTransparentIndex(),type:n.getImgType()}):t({img8:a,pal8:n.getPalette(),indexedPixels:n.getIndexedPixels(),transparent:n.getTransparentIndex(),type:n.getImgType()})})},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);
