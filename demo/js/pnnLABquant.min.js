!function(){"use strict";function t(){this.nextInt=function(t){return Math.floor(Math.random()*(t+1))}}function N(t){return t*t}function a(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.saliencies=null}Math.clamp||(Math.clamp=function(t,a,e){return this.max(a,this.min(e,t))});var B,O,Q=15,A=!1,L=!1,v=.299,R=.587,g=.114,d=.3333,x=new t,j=1,w=new Map,G=new Map,y=new Map,H=95.047,J=100,K=108.883,V=.008856,W=903.3;function X(){this.alpha=255,this.A=this.B=this.L=0}var Y=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function Z(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function o(t){return V<t?Math.fround(Math.cbrt(t)):Math.fround((W*t+16)/116)}function M(t){return Math.fround(t*(Math.PI/180))}function I(t,a){var e=a.L-t.L,t=(t.L+a.L)/2,a=1+.015*N(t-50)/Math.sqrt(20+N(t-50));return Math.fround(e/a)}function _(t,a,e,n,r,i){var h=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,h=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+6103515625))),h=(e.value=(1+h)*t.A,n.value=(1+h)*a.A,r.value=Math.sqrt(e.value*e.value+t.B*t.B),i.value=Math.sqrt(n.value*n.value+a.B*a.B),i.value-r.value);return Math.fround(h/(1+.045*((r.value+i.value)/2)))}function P(t,a,e,n,r,i,h,s){var o,l,u,p=M(360),c=M(180),f=r*i,t=(0==t.B&&0==e?o=0:(o=Math.atan2(t.B,e))<0&&(o+=p),0==a.B&&0==n?l=0:(l=Math.atan2(a.B,n))<0&&(l+=p),0==f?u=0:(u=l-o)<-c?u+=p:c<u&&(u-=p),2*Math.sqrt(f)*Math.sin(u/2)),e=o+l,a=(r*i==0?s.value=e:Math.abs(o-l)<=c?s.value=e/2:s.value=e<p?(e+p)/2:(e-p)/2,h.value=(r+i)/2,1-.17*Math.cos(s.value-M(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+M(6))-.2*Math.cos(4*s.value-M(63))),n=1+.015*h.value*a;return Math.fround(t/n)}function T(t,a,e,n){a=M(30)*Math.exp(-Math.pow((a-M(275))/M(25),2)),t=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625)),a=-Math.sin(2*a)*t;return Math.fround(a*e*n)}function $(t,a,e,n,r,i){return r?(240&t)<<8|(240&a)<<4|240&e|n>>4:i?(128&t)<<8|(248&a)<<7|(248&e)<<2|n>>3:(248&a)<<8|(252&e)<<3|n>>3}function tt(t,a,e,n){var r,i,h=t<<24|n<<16|e<<8|a,s=G.get(h);return G.has(h)||(t=t,e=e,n=n,e/=255,n/=255,r=o(100*(.4124*(a=(a=(a=a)/255)<.04045?a/12.92:Math.pow((.055+a)/1.055,2.4))+.3576*(e=e<.04045?e/12.92:Math.pow((.055+e)/1.055,2.4))+.1805*(n=n<.04045?n/12.92:Math.pow((.055+n)/1.055,2.4)))/H),i=o(100*(.2126*a+.7152*e+.0722*n)/J),a=o(100*(.0193*a+.1192*e+.9505*n)/K),(e=new X).alpha=t,e.L=Math.max(0,116*i-16),e.A=500*(r-i),e.B=200*(i-a),s=e,G.set(h,s)),s}function at(t,a,e){var n=0,r=1e100,a=t[a],i=a.cnt,h=new X;h.alpha=a.ac,h.L=a.Lc,h.A=a.Ac,h.B=a.Bc;for(var s=a.fw;0!=s;s=t[s].fw){var o=t[s].cnt,o=i*o/(i+o);if(!(r<=o)){var l=new X;l.alpha=t[s].ac,l.L=t[s].Lc,l.A=t[s].Ac,l.B=t[s].Bc;var u,p,c,f,M,m=o*(L?N(l.alpha-h.alpha)/Math.exp(1.5):0);if(!(r<=m)){if(e){if(r<=(m+=(1-j)*o*Math.abs(l.L-h.L)))continue;m+=(1-j)*o*Math.sqrt(N(l.A-h.A)+N(l.B-h.B))}else{if(r<=(m+=(1-j)*o*N(l.L-h.L)))continue;if(r<=(m+=(1-j)*o*N(l.A-h.A)))continue;m+=(1-j)*o*N(l.B-h.B)}r<=m||(f=I(h,l),r<=(m+=j*o*N(f)))||(c=_(h,l,f={},M={},u={},p={}),r<=(m+=j*o*N(c)))||(M=P(h,l,f.value,M.value,u.value,p.value,l={},f={}),r<=(m+=j*o*N(M)))||r<=(m+=j*o*T(l.value,f.value,c,M))||(r=m,n=s)}}}a.err=Math.fround(r),a.nn=n}function q(t,a,e){var n=y.get(a);if(y.has(a))return n;for(var r=0,i=a>>>24&255,h=(i<=Q&&(a=B,i=0),2<t.length&&A&&Q<i&&(r=1),255&a),s=a>>>8&255,o=a>>>16&255,l=1e100,u=tt(i,h,s,o),p=r;p<t.length;++p){var c=255&t[p],f=t[p]>>>8&255,M=t[p]>>>16&255,m=t[p]>>>24&255,v=L?N(m-i)/Math.exp(1.5):0;if(!(l<v)){var g=tt(m,c,f,M);if(t.length<=4)v=N(c-h)+N(f-s)+N(M-o),L&&(v+=N(m-i));else if(L||t.length<16){if(l<(v+=N(g.L-u.L)))continue;if(l<(v+=N(g.A-u.A)))continue;v+=N(g.B-u.B)}else if(32<t.length){if(l<(v+=Math.abs(g.L-u.L)))continue;v+=Math.sqrt(N(g.A-u.A)+N(g.B-u.B))}else{if(l<(v+=N(I(u,g))))continue;var c={},f={},M={},m={},d=_(u,g,c,f,M,m);if(l<(v+=N(d)))continue;var x={},w={},g=P(u,g,c.value,f.value,M.value,m.value,x,w);if(l<(v+=N(g)))continue;v+=T(x.value,w.value,d,g)}l<v||(l=v,r=p)}}return y.set(a,r),r}function e(t,a,e){if(R<Y[0][1]&&-88<TELL_BLUE_NOISE[4095&e])return q(t,a);var n=a>>>24&255;if(n<=Q)return q(t,a);var r=w.get(a);if(!w.has(a)){(r=new Uint32Array(4))[2]=r[3]=4294967295;for(var i=255&a,h=a>>>8&255,s=a>>>16&255,o=0;o<t.length;++o){var l=255&t[o],u=t[o]>>>8&255,p=t[o]>>>16&255,c=t[o]>>>24&255,f=v*(1-j)*N(l-i);if(!(f>=r[3])&&!((f+=R*(1-j)*N(u-h))>=r[3]||(f+=g*(1-j)*N(p-s))>=r[3])){L&&(f+=d*N(c-n));for(var M=0;M<Y.length&&!((f+=j*N(Y[M][0]*(l-i)))>=r[3])&&!((f+=j*N(Y[M][1]*(u-h)))>=r[3])&&!((f+=j*N(Y[M][2]*(p-s)))>=r[3]);++M);f<r[2]?(r[1]=r[0],r[3]=r[2],r[0]=o,r[2]=0|f):f<r[3]&&(r[1]=o,r[3]=0|f)}}4294967295==r[3]&&(r[1]=r[0]),w.set(a,r)}var e=1,m=((0==r[2]||x.nextInt(r[3]+r[2])<=r[3])&&(e=0),t.length);return r[e+2]>=m||A&&0==r[e]?q(t,a):r[e]}a.prototype.pnnquan=function(t,a){for(var e=1,n=new Array(65536),r=128<=a?null:new Float32Array(t.length),i=0;i<t.length;++i){var h=255&t[i],s=t[i]>>>8&255,o=t[i]>>>16&255,l=t[i]>>>24&255,u=(l<=Q&&(h=255&this.m_transparentColor,s=this.m_transparentColor>>>8&255,o=this.m_transparentColor>>>16&255,l=this.m_transparentColor>>>24&255),$(l,h,s,o,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)),p=tt(l,h,s,o);null==n[u]&&(n[u]=new Z),(L=n[u]).ac+=l,L.Lc+=p.L,L.Ac+=p.A,L.Bc+=p.B,L.cnt+=1,null!=r&&(r[i]=.1+.9*p.L/100*l/255)}this.saliencies=r;for(var c=0,i=0;i<n.length;++i)null!=n[i]&&(T=1/n[i].cnt,n[i].ac*=T,n[i].Lc*=T,n[i].Ac*=T,n[i].Bc*=T,n[c++]=n[i]);var f,M=N(a)/c;if((0<=this.m_transparentPixelIndex||this.hasSemiTransparency)&&a<32&&(e=-1),O=Math.min(.9,+a/c),(a<16&&O<.0075||O<.001||.0015<O&&O<.0022)&&(e=2),O<.04&&R<1&&R>=Y[0][1]&&64<=a&&(e=0),16<a&&a<64&&Math.abs(a/8e3-O)<.001&&(e=2),G.size<=a)f=new Uint32Array(G.size),U=0,G.forEach(function(t,a){f[U++]=a,1<U&&0==(a>>>24&255)&&(f[U-1]=f[0],f[0]=a)}),this.palette=f;else{x=a;for(var z=0<(d=e)?1<d?function(t){return Math.fround(Math.pow(t,.75))}:x<64?function(t){return 0|Math.sqrt(t)}:function(t){return Math.fround(Math.sqrt(t))}:function(t){return t},m=0;m<c-1;++m)n[m].fw=m+1,n[m+1].bk=m,n[m].cnt=z(n[m].cnt);n[m].cnt=z(n[m].cnt);for(var v,g,d,x,E=.0225<M&&!this.hasSemiTransparency,w=(j=this.hasSemiTransparency?.5:0!=e&&a<64?.018<M&&M<.022?Math.min(1,M+O*Math.exp(3.13)):.1<M?Math.min(1,1-O):.04<M?Math.min(1,O*Math.exp(1.56)):.025<M&&(O<.002||.0022<O)?Math.min(1,M+O*Math.exp(3.66)):Math.min(1,M+O*Math.exp(1.718)):256<a?Math.min(1,1-1/M):Math.min(1,1-.7*O),!this.hasSemiTransparency&&e<0&&(j=Math.min(1,O*Math.exp(3.13))),new Uint32Array(n.length+1)),i=0;i<c;++i){at(n,i,E);for(var B=n[i].err,A=++w[0];1<A&&!(n[v=w[g=A>>1]].err<=B);A=g)w[A]=v;w[A]=i}0<e&&a<64&&.035<M&&M<.1&&(x=(0<(d=.04<M?1:-1)?.002:.0025)<O&&O<.003?1.872:1.632,j=Math.min(1,M+d*O*Math.exp(x)));for(var L,D=c-a,i=0;i<D;){for(;;){var y=w[1];if((L=n[y]).tm>=L.mtm&&n[L.nn].mtm<=L.tm)break;65535==L.mtm?y=w[1]=w[w[0]--]:(at(n,y,E),L.tm=i);B=n[y].err;for(A=1;(g=A+A)<=w[0]&&(g<w[0]&&n[w[g]].err>n[w[g+1]].err&&++g,!(B<=n[v=w[g]].err));A=g)w[A]=v;w[A]=y}var I=n[L.nn],_=L.cnt,P=I.cnt,T=1/(_+P);L.ac=Math.fround(T*(_*L.ac+P*I.ac)),L.Lc=Math.fround(T*(_*L.Lc+P*I.Lc)),L.Ac=Math.fround(T*(_*L.Ac+P*I.Ac)),L.Bc=Math.fround(T*(_*L.Bc+P*I.Bc)),L.cnt+=P,L.mtm=++i,n[I.bk].fw=I.fw,n[I.fw].bk=I.bk,I.mtm=65535}D<0&&(this.palette=new Uint32Array(c));for(var q,C,b,S,F,k,U=0,i=0;U<this.palette.length;++U)(p=new X).alpha=this.hasSemiTransparency||0<=this.m_transparentPixelIndex?0|Math.clamp(Math.round(n[i].ac),0,255):255,p.L=n[i].Lc,p.A=n[i].Ac,p.B=n[i].Bc,this.palette[U]=(S=k=C=b=k=C=F=S=b=C=void 0,C=(S=((q=p).L+16)/116)-q.B/200,b=(V<(F=(b=q.A/500+S)*b*b)?F:(116*b-16)/W)*H,S=(W*V<q.L?S*S*S:q.L/W)*J,F=(V<(F=C*C*C)?F:(116*C-16)/W)*K,C=(-.9689*b+1.8758*S+.0415*F)/100,k=(.0557*b+-.204*S+1.057*F)/100,b=.0031308<(b=(3.2406*b+-1.5372*S+-.4986*F)/100)?1.055*Math.pow(b,1/2.4)-.055:12.92*b,C=.0031308<C?1.055*Math.pow(C,1/2.4)-.055:12.92*C,k=.0031308<k?1.055*Math.pow(k,1/2.4)-.055:12.92*k,S=0|Math.clamp(Math.round(q.alpha),0,255),b=0|Math.clamp(Math.round(255*b),0,255),C=0|Math.clamp(Math.round(255*C),0,255),S<<24|(0|Math.clamp(Math.round(255*k),0,255))<<16|C<<8|b),i=n[i].fw}},a.prototype.quantizeImage=function(){for(var t,a=this.opts.pixels,e=(this.opts.width,this.opts.height,this.opts.colors),n=(this.opts.dithering,this.opts.alphaThreshold&&(Q=this.opts.alphaThreshold),this.clear(),A=!1,0),r=0;r<a.length;++r){var i=a[r]>>>24&255;-1<this.m_transparentPixelIndex&&0==i&&(a[r]=this.m_transparentColor),i<224&&(0==i?(this.m_transparentPixelIndex=r,A=!0,2<e?this.m_transparentColor=a[r]:a[r]=this.m_transparentColor):Q<i&&++n)}if(this.hasSemiTransparency=L=0<n,e<=32?v=R=g=d=1:(v=Y[0][0],R=Y[0][1],g=Y[0][2]),B=this.m_transparentColor,this.palette=new Uint32Array(e),2<e?this.pnnquan(a,e):(O=1,0<=this.m_transparentPixelIndex?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295)),L&&(O*=-1),this.opts.dithering&&null==this.saliencies&&(e<=256||.99<O)){for(var h=new Float32Array(a.length),r=0;r<a.length;++r){var s=255&a[r],o=a[r]>>>8&255,l=a[r]>>>16&255,s=tt(i=a[r]>>>24&255,s,o,l);h[r]=.1+.9*s.L/100*i/255}this.saliencies=h}return 0<=this.m_transparentPixelIndex&&2<this.palette.length&&(t=q(this.palette,a[this.m_transparentPixelIndex],this.m_transparentPixelIndex),this.palette[t]=this.m_transparentColor),this.opts.dithering?{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),saliencies:this.saliencies,transparent:this.getTransparentIndex(),type:this.getImgType(),weight:O,weightB:1}:(t=.023<(t=N(e)/G.size)?1:Math.fround(37.013*t+.906),{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),saliencies:this.saliencies,transparent:this.getTransparentIndex(),type:this.getImgType(),weight:O,weightB:t})},a.prototype.getPalette=function(){return this.palette.buffer},a.prototype.getImgType=function(){return 256<this.opts.colors||this.hasSemiTransparency?"image/png":"image/gif"},a.prototype.getTransparentIndex=function(){return-1<this.m_transparentPixelIndex?0:-1},a.prototype.getDitherFn=function(){return-1<this.m_transparentPixelIndex||this.palette.length<4?q:e},a.prototype.getColorIndex=function(t,a,e,n){return $(t,a,e,n,L,A)},a.prototype.getResult=function(){var e=this;return new Promise(function(t,a){t(e.quantizeImage())})},a.prototype.clear=function(){w=new Map,G=new Map,y=new Map,x=new t},this.PnnLABQuant=a,"undefined"!=typeof module&&module.exports&&(module.exports=a)}.call(this);