!function(){function O(t){return t*t}function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,a,n){return this.max(a,this.min(n,t))});var A,Q=15,B=!(Math.randomInt=function(t){return Math.floor(Math.random()*(t+1))}),L=!1,v=.299,R=.587,d=.114,x=.3333,j=1,g=new Map,G=new Map,y=new Map,H=95.047,J=100,K=108.883,V=.008856,W=903.3;function X(){this.alpha=255,this.A=this.B=this.L=0}var Y=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function Z(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function o(t){return V<t?Math.fround(Math.cbrt(t)):Math.fround((W*t+16)/116)}function M(t){return Math.fround(t*(Math.PI/180))}function I(t,a){var n=a.L-t.L,t=(t.L+a.L)/2,a=1+.015*O(t-50)/Math.sqrt(20+O(t-50));return Math.fround(n/a)}function _(t,a,n,e,r,h){var i=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(a.A*a.A+a.B*a.B))/2,i=.5*(1-Math.sqrt(Math.pow(i,7)/(Math.pow(i,7)+6103515625))),i=(n.value=(1+i)*t.A,e.value=(1+i)*a.A,r.value=Math.sqrt(n.value*n.value+t.B*t.B),h.value=Math.sqrt(e.value*e.value+a.B*a.B),h.value-r.value);return Math.fround(i/(1+.045*((r.value+h.value)/2)))}function P(t,a,n,e,r,h,i,s){var o,l,p,u=M(360),c=M(180),f=r*h,t=(0==t.B&&0==n?o=0:(o=Math.atan2(t.B,n))<0&&(o+=u),0==a.B&&0==e?l=0:(l=Math.atan2(a.B,e))<0&&(l+=u),0==f?p=0:(p=l-o)<-c?p+=u:c<p&&(p-=u),2*Math.sqrt(f)*Math.sin(p/2)),n=o+l,a=(r*h==0?s.value=n:Math.abs(o-l)<=c?s.value=n/2:s.value=n<u?(n+u)/2:(n-u)/2,i.value=(r+h)/2,1-.17*Math.cos(s.value-M(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+M(6))-.2*Math.cos(4*s.value-M(63))),e=1+.015*i.value*a;return Math.fround(t/e)}function q(t,a,n,e){a=M(30)*Math.exp(-Math.pow((a-M(275))/M(25),2)),t=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625)),a=-Math.sin(2*a)*t;return Math.fround(a*n*e)}function $(t,a,n,e,r,h){return r?(240&t)<<8|(240&a)<<4|240&n|e>>4:h?(128&t)<<8|(248&a)<<7|(248&n)<<2|e>>3:(248&a)<<8|(252&n)<<3|e>>3}function tt(t,a,n,e){var r,h,i=t<<24|e<<16|n<<8|a,s=G.get(i);return G.has(i)||(t=t,n=n,e=e,n/=255,e/=255,r=o(100*(.4124*(a=(a=(a=a)/255)<.04045?a/12.92:Math.pow((.055+a)/1.055,2.4))+.3576*(n=n<.04045?n/12.92:Math.pow((.055+n)/1.055,2.4))+.1805*(e=e<.04045?e/12.92:Math.pow((.055+e)/1.055,2.4)))/H),h=o(100*(.2126*a+.7152*n+.0722*e)/J),a=o(100*(.0193*a+.1192*n+.9505*e)/K),(n=new X).alpha=t,n.L=Math.max(0,116*h-16),n.A=500*(r-h),n.B=200*(h-a),s=n,G.set(i,s)),s}function at(t,a,n){var e=0,r=1e100,a=t[a],h=a.cnt,i=new X;i.alpha=a.ac,i.L=a.Lc,i.A=a.Ac,i.B=a.Bc;for(var s=a.fw;0!=s;s=t[s].fw){var o=t[s].cnt,o=h*o/(h+o);if(!(r<=o)){var l=new X;l.alpha=t[s].ac,l.L=t[s].Lc,l.A=t[s].Ac,l.B=t[s].Bc;var p,u,c,f,M,m=o*(L?O(l.alpha-i.alpha)/Math.exp(1.5):0);if(!(r<=m)){if(n){if(r<=(m+=(1-j)*o*Math.abs(l.L-i.L)))continue;m+=(1-j)*o*Math.sqrt(O(l.A-i.A)+O(l.B-i.B))}else{if(r<=(m+=(1-j)*o*O(l.L-i.L)))continue;if(r<=(m+=(1-j)*o*O(l.A-i.A)))continue;m+=(1-j)*o*O(l.B-i.B)}r<=m||(f=I(i,l),r<=(m+=j*o*O(f)))||(c=_(i,l,f={},M={},p={},u={}),r<=(m+=j*o*O(c)))||(M=P(i,l,f.value,M.value,p.value,u.value,l={},f={}),r<=(m+=j*o*O(M)))||r<=(m+=j*o*q(l.value,f.value,c,M))||(r=m,e=s)}}}a.err=Math.fround(r),a.nn=e}function w(t,a,n){var e=y.get(a);if(y.has(a))return e;for(var r=0,h=a>>>24&255,i=(h<=Q&&(a=A,h=0),2<t.length&&B&&Q<h&&(r=1),255&a),s=a>>>8&255,o=a>>>16&255,l=1e100,p=tt(h,i,s,o),u=r;u<t.length;++u){var c=255&t[u],f=t[u]>>>8&255,M=t[u]>>>16&255,m=t[u]>>>24&255,v=L?O(m-h)/Math.exp(1.5):0;if(!(l<v)){var d=tt(m,c,f,M);if(t.length<=4)v=O(c-i)+O(f-s)+O(M-o),L&&(v+=O(m-h));else if(L||t.length<16){if(l<(v+=O(d.L-p.L)))continue;if(l<(v+=O(d.A-p.A)))continue;v+=O(d.B-p.B)}else if(32<t.length){if(l<(v+=Math.abs(d.L-p.L)))continue;v+=Math.sqrt(O(d.A-p.A)+O(d.B-p.B))}else{if(l<(v+=O(I(p,d))))continue;var c={},f={},M={},m={},x=_(p,d,c,f,M,m);if(l<(v+=O(x)))continue;var g={},w={},d=P(p,d,c.value,f.value,M.value,m.value,g,w);if(l<(v+=O(d)))continue;v+=q(g.value,w.value,x,d)}l<v||(l=v,r=u)}}return y.set(a,r),r}function a(t,a,n){if(R<Y[0][1]&&-88<TELL_BLUE_NOISE[4095&n])return w(t,a);var e=a>>>24&255;if(e<=Q)return w(t,a);var r=g.get(a);if(!g.has(a)){(r=new Uint32Array(4))[2]=r[3]=4294967295;for(var h=255&a,i=a>>>8&255,s=a>>>16&255,o=0;o<t.length;++o){var l=255&t[o],p=t[o]>>>8&255,u=t[o]>>>16&255,c=t[o]>>>24&255,f=v*(1-j)*O(l-h);if(!(f>=r[3])&&!((f+=R*(1-j)*O(p-i))>=r[3]||(f+=d*(1-j)*O(u-s))>=r[3])){L&&(f+=x*O(c-e));for(var M=0;M<Y.length&&!((f+=j*O(Y[M][0]*(l-h)))>=r[3])&&!((f+=j*O(Y[M][1]*(p-i)))>=r[3])&&!((f+=j*O(Y[M][2]*(u-s)))>=r[3]);++M);f<r[2]?(r[1]=r[0],r[3]=r[2],r[0]=o,r[2]=0|f):f<r[3]&&(r[1]=o,r[3]=0|f)}}4294967295==r[3]&&(r[1]=r[0]),g.set(a,r)}var n=1,m=((0==r[2]||Math.randomInt(r[3]+r[2])<=r[3])&&(n=0),t.length);return r[n+2]>=m||B&&0==r[n]?w(t,a):r[n]}t.prototype.pnnquan=function(t,a){for(var n=1,e=new Array(65536),r=128<=a?null:new Float32Array(t.length),h=0;h<t.length;++h){var i=255&t[h],s=t[h]>>>8&255,o=t[h]>>>16&255,l=t[h]>>>24&255,p=(l<=Q&&(i=255&this.m_transparentColor,s=this.m_transparentColor>>>8&255,o=this.m_transparentColor>>>16&255,l=this.m_transparentColor>>>24&255),$(l,i,s,o,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)),u=tt(l,i,s,o);null==e[p]&&(e[p]=new Z),(L=e[p]).ac+=l,L.Lc+=u.L,L.Ac+=u.A,L.Bc+=u.B,L.cnt+=1,null!=r&&(r[h]=.1+.9*u.L/100*l/255)}this.opts.saliencies=r;for(var c=0,h=0;h<e.length;++h)null!=e[h]&&(q=1/e[h].cnt,e[h].ac*=q,e[h].Lc*=q,e[h].Ac*=q,e[h].Bc*=q,e[c++]=e[h]);var f,M=O(a)/c,m=((0<=this.m_transparentPixelIndex||this.hasSemiTransparency)&&a<32&&(n=-1),this.opts.weight=Math.min(.9,+a/c));if((a<16&&m<.0075||m<.001||.0015<m&&m<.0022)&&(n=2),m<.04&&R<1&&R>=Y[0][1]&&64<=a&&(n=0),16<a&&a<64&&Math.abs(a/8e3-m)<.001&&(n=2),G.size<=a)f=new Uint32Array(G.size),z=0,G.forEach(function(t,a){f[z++]=a,1<z&&0==(a>>>24&255)&&(f[z-1]=f[0],f[0]=a)}),this.palette=f;else{F=a;for(var F,E=0<(g=n)?1<g?function(t){return Math.fround(Math.pow(t,.75))}:F<64?function(t){return 0|Math.sqrt(t)}:function(t){return Math.fround(Math.sqrt(t))}:function(t){return t},v=0;v<c-1;++v)e[v].fw=v+1,e[v+1].bk=v,e[v].cnt=E(e[v].cnt);e[v].cnt=E(e[v].cnt);for(var d,x,g,D=.0275<M,w=(j=this.hasSemiTransparency?.5:0!=n&&a<64?.018<M&&M<.022?Math.min(1,M+m*Math.exp(3.13)):.1<M?Math.min(1,1-m):.04<M?Math.min(1,m*Math.exp(1.56)):.025<M&&(m<.002||.0022<m)?Math.min(1,M+m*Math.exp(3.66)):Math.min(1,M+m*Math.exp(1.718)):256<a?Math.min(1,1-1/M):Math.min(1,1-.7*m),!this.hasSemiTransparency&&n<0&&(j=Math.min(1,m*Math.exp(3.13))),new Uint32Array(e.length+1)),h=0;h<c;++h){at(e,h,D);for(var A=e[h].err,B=++w[0];1<B&&!(e[d=w[x=B>>1]].err<=A);B=x)w[B]=d;w[B]=h}0<n&&a<64&&.035<M&&M<.1&&(g=.04<M?1:-1,j=Math.min(1,M+g*m*Math.exp((0<g?.002:.0025)<m&&m<.003?1.872:1.632)));for(var L,N=c-a,h=0;h<N;){for(;;){var y=w[1];if((L=e[y]).tm>=L.mtm&&e[L.nn].mtm<=L.tm)break;65535==L.mtm?y=w[1]=w[w[0]--]:(at(e,y,D&&M<1),L.tm=h);A=e[y].err;for(B=1;(x=B+B)<=w[0]&&(x<w[0]&&e[w[x]].err>e[w[x+1]].err&&++x,!(A<=e[d=w[x]].err));B=x)w[B]=d;w[B]=y}var I=e[L.nn],_=L.cnt,P=I.cnt,q=1/(_+P);L.ac=Math.fround(q*(_*L.ac+P*I.ac)),L.Lc=Math.fround(q*(_*L.Lc+P*I.Lc)),L.Ac=Math.fround(q*(_*L.Ac+P*I.Ac)),L.Bc=Math.fround(q*(_*L.Bc+P*I.Bc)),L.cnt+=P,L.mtm=++h,e[I.bk].fw=I.fw,e[I.fw].bk=I.bk,I.mtm=65535}N<0&&(this.palette=new Uint32Array(c));for(var T,C,b,S,k,U,z=0,h=0;z<this.palette.length;++z)(u=new X).alpha=this.hasSemiTransparency||0<=this.m_transparentPixelIndex?0|Math.clamp(Math.round(e[h].ac),0,255):255,u.L=e[h].Lc,u.A=e[h].Ac,u.B=e[h].Bc,this.palette[z]=(S=U=C=b=U=C=k=S=b=C=void 0,C=(S=((T=u).L+16)/116)-T.B/200,b=(V<(k=(b=T.A/500+S)*b*b)?k:(116*b-16)/W)*H,S=(W*V<T.L?S*S*S:T.L/W)*J,k=(V<(k=C*C*C)?k:(116*C-16)/W)*K,C=(-.9689*b+1.8758*S+.0415*k)/100,U=(.0557*b+-.204*S+1.057*k)/100,b=.0031308<(b=(3.2406*b+-1.5372*S+-.4986*k)/100)?1.055*Math.pow(b,1/2.4)-.055:12.92*b,C=.0031308<C?1.055*Math.pow(C,1/2.4)-.055:12.92*C,U=.0031308<U?1.055*Math.pow(U,1/2.4)-.055:12.92*U,S=0|Math.clamp(Math.round(T.alpha),0,255),b=0|Math.clamp(Math.round(255*b),0,255),C=0|Math.clamp(Math.round(255*C),0,255),S<<24|(0|Math.clamp(Math.round(255*U),0,255))<<16|C<<8|b),h=e[h].fw}},t.prototype.quantizeImage=function(){for(var t,a=this.opts.pixels,n=(this.opts.width,this.opts.height,this.opts.colors),e=(this.opts.dithering,this.opts._alphaThreshold&&(Q=this.opts._alphaThreshold),this.clear(),B=!1,0),r=0;r<a.length;++r){var h=a[r]>>>24&255;-1<this.m_transparentPixelIndex&&0==h&&(a[r]=this.m_transparentColor),h<224&&(0==h?(this.m_transparentPixelIndex=r,B=!0,2<n?this.m_transparentColor=a[r]:a[r]=this.m_transparentColor):Q<h&&++e)}if(this.hasSemiTransparency=L=0<e,n<=32?v=R=d=x=1:(v=Y[0][0],R=Y[0][1],d=Y[0][2]),A=this.m_transparentColor,this.palette=new Uint32Array(n),2<n?this.pnnquan(a,n):(this.opts.weight=1,0<=this.m_transparentPixelIndex?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295)),this.opts.dithering||(t=O(n)/G.size,this.opts.weightB=.023<t?1:Math.fround(37.013*t+.906)),L&&(this.opts.weight*=-1),this.opts.dithering&&null==this.opts.saliencies&&(n<=256||.99<this.opts.weight)){for(var i=new Float32Array(a.length),r=0;r<a.length;++r){var s=255&a[r],o=a[r]>>>8&255,l=a[r]>>>16&255,s=tt(h=a[r]>>>24&255,s,o,l);i[r]=.1+.9*s.L/100*h/255}this.opts.saliencies=i}return 0<=this.m_transparentPixelIndex&&2<this.palette.length&&(t=w(this.palette,a[this.m_transparentPixelIndex],this.m_transparentPixelIndex),this.palette[t]=this.m_transparentColor),this.opts.ditherFn=this.getDitherFn(),this.opts.getColorIndex=this.getColorIndex,this.opts.palette=this.palette,this.palette},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return 256<this.opts.colors||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return-1<this.m_transparentPixelIndex?0:-1},t.prototype.getDitherFn=function(){return-1<this.m_transparentPixelIndex||this.opts.colors<4?w:a},t.prototype.getColorIndex=function(t,a,n,e){return $(t,a,n,e,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)},t.prototype.getResult=function(){var n=this;return new Promise(function(t,a){t({pal8:n.quantizeImage(),indexedPixels:n.getIndexedPixels(),transparent:n.getTransparentIndex(),type:n.getImgType()})})},t.prototype.clear=function(){g=new Map,G=new Map,y=new Map},this.PnnLABQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);