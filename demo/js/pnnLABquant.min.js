!function(){"use strict";var B,N,O=15,A=!1,I=!1,m=.299,Q=.587,g=.114,x=.3333,w=new t,R=1,L=new Map,j=new Map,C=new Map,G=95.047,H=100,J=108.883,K=.008856,V=903.3,W=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function X(){this.alpha=255,this.A=this.B=this.L=0}function Y(){this.ac=this.Lc=this.Ac=this.Bc=0,this.cnt=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0,this.err=0}function t(){this.nextInt=function(t){return Math.floor(Math.random()*(t+1))}}function Z(t){return t*t}function l(t){return K<t?Math.fround(Math.cbrt(t)):Math.fround((V*t+16)/116)}function M(t){return Math.fround(t*(Math.PI/180))}function y(t,e){var a=e.L-t.L,t=(t.L+e.L)/2,e=1+.015*Z(t-50)/Math.sqrt(20+Z(t-50));return Math.fround(a/e)}function P(t,e,a,n,r,h){var i=(Math.sqrt(t.A*t.A+t.B*t.B)+Math.sqrt(e.A*e.A+e.B*e.B))/2,i=.5*(1-Math.sqrt(Math.pow(i,7)/(Math.pow(i,7)+6103515625))),i=(a.value=(1+i)*t.A,n.value=(1+i)*e.A,r.value=Math.sqrt(a.value*a.value+t.B*t.B),h.value=Math.sqrt(n.value*n.value+e.B*e.B),h.value-r.value);return Math.fround(i/(1+.045*((r.value+h.value)/2)))}function T(t,e,a,n,r,h,i,s){var l,o,u,p=M(360),c=M(180),f=r*h,t=(0==t.B&&0==a?l=0:(l=Math.atan2(t.B,a))<0&&(l+=p),0==e.B&&0==n?o=0:(o=Math.atan2(e.B,n))<0&&(o+=p),0==f?u=0:(u=o-l)<-c?u+=p:c<u&&(u-=p),2*Math.sqrt(f)*Math.sin(u/2)),a=l+o,e=(r*h==0?s.value=a:Math.abs(l-o)<=c?s.value=a/2:s.value=a<p?(a+p)/2:(a-p)/2,i.value=(r+h)/2,1-.17*Math.cos(s.value-M(30))+.24*Math.cos(2*s.value)+.32*Math.cos(3*s.value+M(6))-.2*Math.cos(4*s.value-M(63))),n=1+.015*i.value*e;return Math.fround(t/n)}function q(t,e,a,n){e=M(30)*Math.exp(-Math.pow((e-M(275))/M(25),2)),t=2*Math.sqrt(Math.pow(t,7)/(Math.pow(t,7)+6103515625)),e=-Math.sin(2*e)*t;return Math.fround(e*a*n)}function $(t,e,a,n,r,h){return r?(240&t)<<8|(240&e)<<4|240&a|n>>4:h?(128&t)<<8|(248&e)<<7|(248&a)<<2|n>>3:(248&e)<<8|(252&a)<<3|n>>3}function tt(t,e,a,n){var r,h,i=t<<24|n<<16|a<<8|e,s=j.get(i);return j.has(i)||(t=t,a=a,n=n,a/=255,n/=255,r=l(100*(.4124*(e=(e=(e=e)/255)<.04045?e/12.92:Math.pow((.055+e)/1.055,2.4))+.3576*(a=a<.04045?a/12.92:Math.pow((.055+a)/1.055,2.4))+.1805*(n=n<.04045?n/12.92:Math.pow((.055+n)/1.055,2.4)))/G),h=l(100*(.2126*e+.7152*a+.0722*n)/H),e=l(100*(.0193*e+.1192*a+.9505*n)/J),(a=new X).alpha=t,a.L=Math.max(0,116*h-16),a.A=500*(r-h),a.B=200*(h-e),s=a,j.set(i,s)),s}Math.clamp||(Math.clamp=function(t,e,a){return this.max(e,this.min(a,t))});class e{#hasSemiTransparency=!1;#palette=[];#saliencies=null;#transparentPixelIndex=-1;#transparentColor=16777215;constructor(t){this.opts=t}#find_nn(t,e,a){var n=0,r=1e100,e=t[e],h=e.cnt,i=new X;i.alpha=e.ac,i.L=e.Lc,i.A=e.Ac,i.B=e.Bc;for(var s=e.fw;0!=s;s=t[s].fw){var l=t[s].cnt,l=h*l/(h+l);if(!(r<=l)){var o=new X;o.alpha=t[s].ac,o.L=t[s].Lc,o.A=t[s].Ac,o.B=t[s].Bc;var u,p,c,f,M,v=l*(I?Z(o.alpha-i.alpha)/Math.exp(1.5):0);if(!(r<=v)){if(a){if(r<=(v+=(1-R)*l*Math.abs(o.L-i.L)))continue;v+=(1-R)*l*Math.sqrt(Z(o.A-i.A)+Z(o.B-i.B))}else{if(r<=(v+=(1-R)*l*Z(o.L-i.L)))continue;if(r<=(v+=(1-R)*l*Z(o.A-i.A)))continue;v+=(1-R)*l*Z(o.B-i.B)}r<=v||(f=y(i,o),r<=(v+=R*l*Z(f)))||(c=P(i,o,f={},M={},u={},p={}),r<=(v+=R*l*Z(c)))||(M=T(i,o,f.value,M.value,u.value,p.value,o={},f={}),r<=(v+=R*l*Z(M)))||r<=(v+=R*l*q(o.value,f.value,c,M))||(r=v,n=s)}}}e.err=Math.fround(r),e.nn=n}#pnnquan(t,e){for(var a=1,n=new Array(65536),r=128<=e?null:new Float32Array(t.length),h=0;h<t.length;++h){var i=255&t[h],s=t[h]>>>8&255,l=t[h]>>>16&255,o=t[h]>>>24&255,u=(o<=O&&(i=255&this.#transparentColor,s=this.#transparentColor>>>8&255,l=this.#transparentColor>>>16&255,o=this.#transparentColor>>>24&255),$(o,i,s,l,this.#hasSemiTransparency,0<=this.#transparentPixelIndex)),p=tt(o,i,s,l);null==n[u]&&(n[u]=new Y),(I=n[u]).ac+=o,I.Lc+=p.L,I.Ac+=p.A,I.Bc+=p.B,I.cnt+=1,null!=r&&(r[h]=.1+.9*p.L/100*o/255)}this.#saliencies=r;for(var c=0,h=0;h<n.length;++h)null!=n[h]&&(T=1/n[h].cnt,n[h].ac*=T,n[h].Lc*=T,n[h].Ac*=T,n[h].Bc*=T,n[c++]=n[h]);var f,M=Z(e)/c;if((0<=this.#transparentPixelIndex||this.#hasSemiTransparency)&&e<32&&(a=-1),N=Math.min(.9,+e/c),(e<16&&N<.0075||N<.001||.0015<N&&N<.0022)&&(a=2),N<.04&&Q<1&&Q>=W[0][1]&&64<=e&&(a=0),16<e&&e<64&&Math.abs(e/8e3-N)<.001&&(a=2),j.size<=e)f=new Uint32Array(j.size),z=0,j.forEach(function(t,e){f[z++]=e,1<z&&0==(e>>>24&255)&&(f[z-1]=f[0],f[0]=e)}),this.#palette=f;else{x=e;for(var _=0<(g=a)?1<g?function(t){return Math.fround(Math.pow(t,.75))}:x<64?function(t){return 0|Math.sqrt(t)}:function(t){return Math.fround(Math.sqrt(t))}:function(t){return t},v=0;v<c-1;++v)n[v].fw=v+1,n[v+1].bk=v,n[v].cnt=_(n[v].cnt);n[v].cnt=_(n[v].cnt);for(var d,m,g,x,E=.0225<M&&!this.#hasSemiTransparency,w=(R=this.#hasSemiTransparency?.5:0!=a&&e<64?.018<M&&M<.022?Math.min(1,M+N*Math.exp(3.13)):.1<M?Math.min(1,1-N):.04<M?Math.min(1,N*Math.exp(1.56)):.025<M&&(N<.002||.0022<N)?Math.min(1,M+N*Math.exp(3.66)):Math.min(1,M+N*Math.exp(1.718)):256<e?Math.min(1,1-1/M):Math.min(1,1-.7*N),!this.#hasSemiTransparency&&a<0&&(R=Math.min(1,N*Math.exp(3.13))),new Uint32Array(n.length+1)),h=0;h<c;++h){this.#find_nn(n,h,E);for(var B=n[h].err,A=++w[0];1<A&&!(n[d=w[m=A>>1]].err<=B);A=m)w[A]=d;w[A]=h}0<a&&e<64&&.035<M&&M<.1&&(x=(0<(g=.04<M?1:-1)?.002:.0025)<N&&N<.003?1.872:1.632,R=Math.min(1,M+g*N*Math.exp(x)));for(var I,D=c-e,h=0;h<D;){for(;;){var L=w[1];if((I=n[L]).tm>=I.mtm&&n[I.nn].mtm<=I.tm)break;65535==I.mtm?L=w[1]=w[w[0]--]:(this.#find_nn(n,L,E),I.tm=h);B=n[L].err;for(A=1;(m=A+A)<=w[0]&&(m<w[0]&&n[w[m]].err>n[w[m+1]].err&&++m,!(B<=n[d=w[m]].err));A=m)w[A]=d;w[A]=L}var C=n[I.nn],y=I.cnt,P=C.cnt,T=1/(y+P);I.ac=Math.fround(T*(y*I.ac+P*C.ac)),I.Lc=Math.fround(T*(y*I.Lc+P*C.Lc)),I.Ac=Math.fround(T*(y*I.Ac+P*C.Ac)),I.Bc=Math.fround(T*(y*I.Bc+P*C.Bc)),I.cnt+=P,I.mtm=++h,n[C.bk].fw=C.fw,n[C.fw].bk=C.bk,C.mtm=65535}D<0&&(this.#palette=new Uint32Array(c));for(var q,b,S,F,k,U,z=0,h=0;z<this.#palette.length;++z)(p=new X).alpha=this.#hasSemiTransparency||0<=this.#transparentPixelIndex?0|Math.clamp(Math.round(n[h].ac),0,255):255,p.L=n[h].Lc,p.A=n[h].Ac,p.B=n[h].Bc,this.#palette[z]=(F=U=b=S=U=b=k=F=S=b=void 0,b=(F=((q=p).L+16)/116)-q.B/200,S=(K<(k=(S=q.A/500+F)*S*S)?k:(116*S-16)/V)*G,F=(V*K<q.L?F*F*F:q.L/V)*H,k=(K<(k=b*b*b)?k:(116*b-16)/V)*J,b=(-.9689*S+1.8758*F+.0415*k)/100,U=(.0557*S+-.204*F+1.057*k)/100,S=.0031308<(S=(3.2406*S+-1.5372*F+-.4986*k)/100)?1.055*Math.pow(S,1/2.4)-.055:12.92*S,b=.0031308<b?1.055*Math.pow(b,1/2.4)-.055:12.92*b,U=.0031308<U?1.055*Math.pow(U,1/2.4)-.055:12.92*U,F=0|Math.clamp(Math.round(q.alpha),0,255),S=0|Math.clamp(Math.round(255*S),0,255),b=0|Math.clamp(Math.round(255*b),0,255),F<<24|(0|Math.clamp(Math.round(255*U),0,255))<<16|b<<8|S),h=n[h].fw}}quantizeImage(){for(var t,e=this.opts.pixels,a=(this.opts.width,this.opts.height,this.opts.colors),n=(this.opts.dithering,this.opts.alphaThreshold&&(O=this.opts.alphaThreshold),this.clear(),A=!1,0),r=0;r<e.length;++r){var h=e[r]>>>24&255;-1<this.#transparentPixelIndex&&0==h&&(e[r]=this.#transparentColor),h<224&&(0==h?(this.#transparentPixelIndex=r,A=!0,2<a?this.#transparentColor=e[r]:e[r]=this.#transparentColor):O<h&&++n)}if(this.#hasSemiTransparency=I=0<n,a<=32?m=Q=g=x=1:(m=W[0][0],Q=W[0][1],g=W[0][2]),B=this.#transparentColor,this.#palette=new Uint32Array(a),2<a?this.#pnnquan(e,a):(N=1,0<=this.#transparentPixelIndex?(this.#palette[0]=this.#transparentColor,this.#palette[1]=255<<24):(this.#palette[0]=255<<24,this.#palette[1]=4294967295)),I&&(N*=-1),this.opts.dithering&&null==this.#saliencies&&(a<=256||.99<N)){for(var i=new Float32Array(e.length),r=0;r<e.length;++r){var s=255&e[r],l=e[r]>>>8&255,o=e[r]>>>16&255,s=tt(h=e[r]>>>24&255,s,l,o);i[r]=.1+.9*s.L/100*h/255}this.#saliencies=i}return 0<=this.#transparentPixelIndex&&2<this.#palette.length&&(t=this.#nearestColorIndex(this.#palette,e[this.#transparentPixelIndex],this.#transparentPixelIndex),this.#palette[t]=this.#transparentColor),this.opts.dithering?{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),saliencies:this.#saliencies,transparent:this.getTransparentIndex(),type:this.getImgType(),weight:N,weightB:1}:(t=.023<(t=Z(a)/j.size)?1:Math.fround(37.013*t+.906),{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),saliencies:this.#saliencies,transparent:this.getTransparentIndex(),type:this.getImgType(),weight:N,weightB:t})}#nearestColorIndex(t,e,a){var n=C.get(e);if(C.has(e))return n;for(var r=0,h=e>>>24&255,i=(h<=O&&(e=B,h=0),2<t.length&&A&&O<h&&(r=1),255&e),s=e>>>8&255,l=e>>>16&255,o=1e100,u=tt(h,i,s,l),p=r;p<t.length;++p){var c=255&t[p],f=t[p]>>>8&255,M=t[p]>>>16&255,v=t[p]>>>24&255,d=I?Z(v-h)/Math.exp(1.5):0;if(!(o<d)){var m=tt(v,c,f,M);if(t.length<=4)d=Z(c-i)+Z(f-s)+Z(M-l),I&&(d+=Z(v-h));else if(I||t.length<16){if(o<(d+=Z(m.L-u.L)))continue;if(o<(d+=Z(m.A-u.A)))continue;d+=Z(m.B-u.B)}else if(32<t.length){if(o<(d+=Math.abs(m.L-u.L)))continue;d+=Math.sqrt(Z(m.A-u.A)+Z(m.B-u.B))}else{if(o<(d+=Z(y(u,m))))continue;var c={},f={},M={},v={},g=P(u,m,c,f,M,v);if(o<(d+=Z(g)))continue;var x={},w={},m=T(u,m,c.value,f.value,M.value,v.value,x,w);if(o<(d+=Z(m)))continue;d+=q(x.value,w.value,g,m)}o<d||(o=d,r=p)}}return C.set(e,r),r}#closestColorIndex(t,e,a){if(Q<W[0][1]&&-88<BlueNoise.TELL_BLUE_NOISE[4095&a])return this.#nearestColorIndex(t,e,a);var n=e>>>24&255;if(n<=O)return this.#nearestColorIndex(t,e,a);var r=L.get(e);if(!L.has(e)){(r=new Uint32Array(4))[2]=r[3]=4294967295;for(var h=255&e,i=e>>>8&255,s=e>>>16&255,l=0;l<t.length;++l){var o=255&t[l],u=t[l]>>>8&255,p=t[l]>>>16&255,c=t[l]>>>24&255,f=m*(1-R)*Z(o-h);if(!(f>=r[3])&&!((f+=Q*(1-R)*Z(u-i))>=r[3]||(f+=g*(1-R)*Z(p-s))>=r[3])){I&&(f+=x*Z(c-n));for(var M=0;M<W.length&&!((f+=R*Z(W[M][0]*(o-h)))>=r[3])&&!((f+=R*Z(W[M][1]*(u-i)))>=r[3])&&!((f+=R*Z(W[M][2]*(p-s)))>=r[3]);++M);f<r[2]?(r[1]=r[0],r[3]=r[2],r[0]=l,r[2]=0|f):f<r[3]&&(r[1]=l,r[3]=0|f)}}4294967295==r[3]&&(r[1]=r[0]),L.set(e,r)}var v=1,d=((0==r[2]||w.nextInt(r[3]+r[2])<=r[3])&&(v=0),t.length);return r[v+2]>=d||A&&0==r[v]?this.#nearestColorIndex(t,e,a):r[v]}getPalette(){return this.#palette.buffer}getImgType(){return 256<this.opts.colors||this.#hasSemiTransparency?"image/png":"image/gif"}getTransparentIndex(){return-1<this.#transparentPixelIndex?0:-1}getDitherFn(){return-1<this.#transparentPixelIndex||this.#palette.length<4?this.#nearestColorIndex:this.#closestColorIndex}getColorIndex(t,e,a,n){return $(t,e,a,n,I,A)}getResult(){var a=this;return new Promise(function(t,e){t(a.quantizeImage())})}clear(){L=new Map,j=new Map,C=new Map,w=new t}}this.PnnLABQuant=e,"undefined"!=typeof module&&module.exports&&(module.exports=e)}.call(this);