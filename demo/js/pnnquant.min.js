!function(){var m,B,E=15,d=!1,v=!1,L=.299,S=.587,U=.114,k=.3333,x=.5,w=new Map,I=new Map,q=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function M(t){return t*t}function N(t,r,e,n,a,s){return a?(240&t)<<8|(240&r)<<4|240&e|n>>4:s?(128&t)<<8|(248&r)<<7|(248&e)<<2|n>>3:(248&r)<<8|(252&e)<<3|n>>3}function _(t,r){var e=0,n=1e100,a=t[r],s=a.cnt,i=a.ac,h=a.rc,o=a.gc,c=a.bc,l=0;0<BlueNoise.TELL_BLUE_NOISE[4095&r]&&(l=S<q[0][1]?q.length:1);for(var p=a.fw;0!=p;p=t[p].fw){var u=t[p].cnt,g=s*u/(s+u);if(!(n<=g)){var f=0;if(!(v&&n<=(f+=g*k*M(t[p].ac-i))||n<=(f+=g*(1-x)*L*M(t[p].rc-h))||n<=(f+=g*(1-x)*S*M(t[p].gc-o))||n<=(f+=g*(1-x)*U*M(t[p].bc-c)))){for(var m=l;m<q.length&&!(n<=(f+=g*x*M(q[m][0]*(t[p].rc-h))))&&!(n<=(f+=g*x*M(q[m][1]*(t[p].gc-o))))&&!(n<=(f+=g*x*M(q[m][2]*(t[p].bc-c))));++m);n=f,e=p}}}a.err=Math.fround(n),a.nn=e}function A(t,r){return 0<r?t<64?function(t){return Math.fround(Math.sqrt(t))}:function(t){return 0|Math.sqrt(t)}:r<0?function(t){return 0|Math.cbrt(t)}:function(t){return t}}function b(t,r,e){var n=0,a=r>>>24&255,s=(a<=E&&(a=(r=m)>>>24&255),I.get(r));if(I.has(r))return s;2<t.length&&d&&E<a&&(n=1);for(var i=255&r,h=r>>>8&255,o=r>>>16&255,c=L,l=S,p=U,u=(2<t.length&&-88<BlueNoise.TELL_BLUE_NOISE[4095&e]&&(c=q[0][0],l=q[0][1],p=q[0][2]),1e100),g=n;g<t.length;g++){var f=k*M((t[g]>>>24&255)-a);u<f||u<(f+=c*M((255&t[g])-i))||u<(f+=l*M((t[g]>>>8&255)-h))||u<(f+=p*M((t[g]>>>16&255)-o))||(u=f,n=g)}return I.set(r,n),n}function t(t,r,e){var n=r>>>24&255;if(n<=E)return b(t,r,e);var a=255&r,s=r>>>8&255,i=r>>>16&255,h=w.get(r);if(!w.has(r)){(h=new Uint32Array(4))[2]=h[3]=65535;var o=L,c=S,l=U;-88<BlueNoise.TELL_BLUE_NOISE[4095&e]&&(o=q[0][0],c=q[0][1],l=q[0][2]);for(var p=0;p<t.length;++p){var u=o*M((255&t[p])-a);u>=h[3]||(u+=c*M((t[p]>>>8&255)-s))>=h[3]||(u+=l*M((t[p]>>>16&255)-i))>=h[3]||(v&&(u+=k*M((t[p]>>>24&255)-n)),u<h[2]?(h[1]=h[0],h[3]=h[2],h[0]=p,h[2]=0|u):u<h[3]&&(h[1]=p,h[3]=0|u))}65535==h[3]&&(h[1]=h[0]),w.set(r,h)}var g=t.length<<2,f=(e+1)%2;return.67*h[3]<h[3]-h[2]?f=0:h[0]>h[1]&&(f=e%2),h[f+2]>=g||d&&0==h[f+2]?b(t,r,e):h[f]}Math.clamp||(Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))});class F{#hasSemiTransparency=!1;#palette=[];#transparentPixelIndex=-1;#transparentColor=16777215;constructor(t){this.opts=t}static PnnBin=class{constructor(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=this.err=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0}};#pnnquan(t,r){for(var e=1,n=new Array(65536),a=0;a<t.length;++a){var s=255&t[a],i=t[a]>>>8&255,h=t[a]>>>16&255,o=((T=t[a]>>>24&255)<=E&&(s=255&this.#transparentColor,i=this.#transparentColor>>>8&255,h=this.#transparentColor>>>16&255,T=this.#transparentColor>>>24&255),N(T,s,i,h,this.#hasSemiTransparency,r<64||0<=this.#transparentPixelIndex));null==n[o]&&(n[o]=new F.PnnBin),(v=n[o]).ac+=T,v.rc+=s,v.gc+=i,v.bc+=h,v.cnt+=1}for(var c=0,a=0;a<n.length;++a)null!=n[a]&&(P=1/n[a].cnt,n[a].ac*=P,n[a].rc*=P,n[a].gc*=P,n[a].bc*=P,n[c++]=n[a]);r<16&&(e=-1),.003<(B=Math.min(.9,+r/c))&&B<.005&&(e=0);for(var l,p,u=A(r,e=B<.04&&S>=q[0][1]&&(L=S=U=k=1,64<=r)?0:e),g=0;g<c-1;++g)n[g].fw=g+1,n[g+1].bk=g,n[g].cnt=u(n[g].cnt);n[g].cnt=u(n[g].cnt);for(var f=new Uint32Array(n.length+1),a=0;a<c;++a){_(n,a);for(var m=n[a].err,d=++f[0];1<d&&!(n[l=f[p=d>>1]].err<=m);d=p)f[d]=l;f[d]=a}for(var v,x=c-r,a=0;a<x;){for(;;){var w=f[1];if((v=n[w]).tm>=v.mtm&&n[v.nn].mtm<=v.tm)break;65535==v.mtm?w=f[1]=f[f[0]--]:(_(n,w),v.tm=a);m=n[w].err;for(d=1;(p=d+d)<=f[0]&&(p<f[0]&&n[f[p]].err>n[f[p+1]].err&&++p,!(m<=n[l=f[p]].err));d=p)f[d]=l;f[d]=w}var I=n[v.nn],M=v.cnt,b=I.cnt,P=Math.fround(1/(M+b));v.ac=P*Math.round(M*v.ac+b*I.ac),v.rc=P*Math.round(M*v.rc+b*I.rc),v.gc=P*Math.round(M*v.gc+b*I.gc),v.bc=P*Math.round(M*v.bc+b*I.bc),v.cnt+=b,v.mtm=++a,n[I.bk].fw=I.fw,n[I.fw].bk=I.bk,I.mtm=65535}this.#palette=new Uint32Array(0<x?r:c);for(var C=0,a=0;C<this.#palette.length;++C){var y,T=0|Math.clamp(n[a].ac,0,255),s=0|Math.clamp(n[a].rc,0,255),i=0|Math.clamp(n[a].gc,0,255),h=0|Math.clamp(n[a].bc,0,255);this.#palette[C]=T<<24|h<<16|i<<8|s,0<=this.#transparentPixelIndex&&0==T&&(y=this.#palette[0],this.#palette[0]=this.#transparentColor,this.#palette[C]=y),a=n[a].fw}}quantizeImage(){for(var t,r=this.opts.pixels,e=(this.opts.width,this.opts.height,this.opts.colors),n=(this.opts.dithering,this.opts.alphaThreshold&&(E=this.opts.alphaThreshold),this.clear(),d=!1,0),a=0;a<r.length;++a){var s=r[a]>>>24&255;s<224&&(0==s?(this.#transparentPixelIndex=a,d=!0,2<e?this.#transparentColor=r[a]:r[a]=this.#transparentColor):E<s&&++n)}return this.#hasSemiTransparency=v=0<n,e<=32?L=S=U=k=1:(L=q[0][0],S=q[0][1],U=q[0][2]),m=this.#transparentColor,this.#palette=new Uint32Array(e),2<e?this.#pnnquan(r,e):0<=this.#transparentPixelIndex?(this.#palette[0]=this.#transparentColor,this.#palette[1]=255<<24):(this.#palette[0]=255<<24,this.#palette[1]=4294967295),v&&(B*=-1),0<=this.#transparentPixelIndex&&2<this.#palette.length&&(t=this.getDitherFn()(this.#palette,r[this.#transparentPixelIndex],this.#transparentPixelIndex),this.#palette[t]=this.#transparentColor),{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),transparent:this.getTransparentIndex(),type:this.getImgType(),weight:B,weightB:1}}getPalette(){return this.#palette.buffer}getImgType(){return 256<this.opts.colors||this.#hasSemiTransparency?"image/png":"image/gif"}getTransparentIndex(){return-1<this.#transparentPixelIndex?0:-1}getDitherFn(){return this.opts.dithering?b:t}getColorIndex(t,r,e,n){return N(t,r,e,n,v,d)}getResult(){var e=this;return new Promise(function(t,r){t(e.quantizeImage())})}clear(){w=new Map,I=new Map}}this.PnnQuant=F,"undefined"!=typeof module&&module.exports&&(module.exports=F)}.call(this);