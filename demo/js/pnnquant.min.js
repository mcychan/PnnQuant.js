!function(){var m,A,B=15,d=!1,v=!1,E=.299,L=.587,U=.114,_=.3333,x=.5,w=new Array(65536),I=new Uint16Array(65536),S=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function b(t){return t*t}function k(t,r,n,e,a,i){return a?(240&t)<<8|(240&r)<<4|240&n|e>>4:i?(128&t)<<8|(248&r)<<7|(248&n)<<2|e>>3:(248&r)<<8|(252&n)<<3|e>>3}function q(t,r){return 0<r?t<64?function(t){return Math.fround(Math.sqrt(t))}:function(t){return 0|Math.sqrt(t)}:r<0?function(t){return 0|Math.cbrt(t)}:function(t){return t}}function y(t,r,n){var e=0,a=r>>>24&255,i=(a<=B&&(a=(r=m)>>>24&255),255&r),s=r>>>8&255,h=r>>>16&255,r=k(a,i,s,h,v,d),o=I[r];if(0<o)return o-1;2<t.length&&d&&B<a&&(e=1);for(var l=E,c=L,p=U,u=(2<t.length&&-88<BlueNoise.TELL_BLUE_NOISE[4095&n]&&(l=S[0][0],c=S[0][1],p=S[0][2]),1e100),f=e;f<t.length;f++){var g=_*b((t[f]>>>24&255)-a);u<g||u<(g+=l*b((255&t[f])-i))||u<(g+=c*b((t[f]>>>8&255)-s))||u<(g+=p*b((t[f]>>>16&255)-h))||(u=g,e=f)}return I[r]=e+1,e}function t(t,r,n){var e=r>>>24&255;if(e<=B)return y(t,r,n);var a=255&r,i=r>>>8&255,s=r>>>16&255,h=k(e,a,i,s,v,d),o=w[h];if(null==w){(o=new Uint32Array(4))[2]=o[3]=65535;var l=E,c=L,p=U;-88<BlueNoise.TELL_BLUE_NOISE[4095&n]&&(l=S[0][0],c=S[0][1],p=S[0][2]);for(var u=0;u<t.length;++u){var f=l*b((255&t[u])-a);f>=o[3]||(f+=c*b((t[u]>>>8&255)-i))>=o[3]||(f+=p*b((t[u]>>>16&255)-s))>=o[3]||(v&&(f+=_*b((t[u]>>>24&255)-e)),f<o[2]?(o[1]=o[0],o[3]=o[2],o[0]=u,o[2]=0|f):f<o[3]&&(o[1]=u,o[3]=0|f))}65535==o[3]&&(o[1]=o[0]),w[h]=o}var h=t.length<<2,g=(n+1)%2;return.67*o[3]<o[3]-o[2]?g=0:o[0]>o[1]&&(g=n%2),o[g+2]>=h||d&&0==o[g+2]?y(t,r,n):o[g]}Math.clamp||(Math.clamp=function(t,r,n){return this.max(r,this.min(n,t))});class N{#hasSemiTransparency=!1;#palette=[];#transparentPixelIndex=-1;#transparentColor=16777215;constructor(t){this.opts=t}static PnnBin=class{constructor(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=this.err=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0}};#find_nn(t,r){var n=0,e=1e100,a=t[r],i=a.cnt,s=a.ac,h=a.rc,o=a.gc,l=a.bc,c=0;0<BlueNoise.TELL_BLUE_NOISE[4095&r]&&(c=L<S[0][1]?S.length:1);for(var p=a.fw;0!=p;p=t[p].fw){var u=t[p].cnt,f=i*u/(i+u);if(!(e<=f)){var g=0;if(!(v&&e<=(g+=f*_*b(t[p].ac-s))||e<=(g+=.5*f*E*b(t[p].rc-h))||e<=(g+=.5*f*L*b(t[p].gc-o))||e<=(g+=.5*f*U*b(t[p].bc-l)))){for(var m=c;m<S.length&&!(e<=(g+=f*x*b(S[m][0]*(t[p].rc-h))))&&!(e<=(g+=f*x*b(S[m][1]*(t[p].gc-o))))&&!(e<=(g+=f*x*b(S[m][2]*(t[p].bc-l))));++m);e=g,n=p}}}a.err=Math.fround(e),a.nn=n}#pnnquan(t,r){for(var n=1,e=new Array(65536),a=0;a<t.length;++a){var i=255&t[a],s=t[a]>>>8&255,h=t[a]>>>16&255,o=((T=t[a]>>>24&255)<=B&&(i=255&this.#transparentColor,s=this.#transparentColor>>>8&255,h=this.#transparentColor>>>16&255,T=this.#transparentColor>>>24&255),k(T,i,s,h,this.#hasSemiTransparency,r<64||0<=this.#transparentPixelIndex));null==e[o]&&(e[o]=new N.PnnBin),(v=e[o]).ac+=T,v.rc+=i,v.gc+=s,v.bc+=h,v.cnt+=1}for(var l=0,a=0;a<e.length;++a)null!=e[a]&&(M=1/e[a].cnt,e[a].ac*=M,e[a].rc*=M,e[a].gc*=M,e[a].bc*=M,e[l++]=e[a]);r<16&&(n=-1),.003<(A=Math.min(.9,+r/l))&&A<.005&&(n=0);for(var c,p,u=q(r,n=A<.04&&L>=S[0][1]&&(E=L=U=_=1,64<=r)?0:n),f=0;f<l-1;++f)e[f].fw=f+1,e[f+1].bk=f,e[f].cnt=u(e[f].cnt);e[f].cnt=u(e[f].cnt);for(var g=new Uint32Array(e.length+1),a=0;a<l;++a){this.#find_nn(e,a);for(var m=e[a].err,d=++g[0];1<d&&!(e[c=g[p=d>>1]].err<=m);d=p)g[d]=c;g[d]=a}for(var v,x=l-r,a=0;a<x;){for(;;){var w=g[1];if((v=e[w]).tm>=v.mtm&&e[v.nn].mtm<=v.tm)break;65535==v.mtm?w=g[1]=g[g[0]--]:(this.#find_nn(e,w),v.tm=a);m=e[w].err;for(d=1;(p=d+d)<=g[0]&&(p<g[0]&&e[g[p]].err>e[g[p+1]].err&&++p,!(m<=e[c=g[p]].err));d=p)g[d]=c;g[d]=w}var I=e[v.nn],b=v.cnt,y=I.cnt,M=Math.fround(1/(b+y));v.ac=M*Math.round(b*v.ac+y*I.ac),v.rc=M*Math.round(b*v.rc+y*I.rc),v.gc=M*Math.round(b*v.gc+y*I.gc),v.bc=M*Math.round(b*v.bc+y*I.bc),v.cnt+=y,v.mtm=++a,e[I.bk].fw=I.fw,e[I.fw].bk=I.bk,I.mtm=65535}this.#palette=new Uint32Array(0<x?r:l);for(var P=0,a=0;P<this.#palette.length;++P){var C,T=0|Math.clamp(e[a].ac,0,255),i=0|Math.clamp(e[a].rc,0,255),s=0|Math.clamp(e[a].gc,0,255),h=0|Math.clamp(e[a].bc,0,255);this.#palette[P]=T<<24|h<<16|s<<8|i,0<=this.#transparentPixelIndex&&0==T&&(C=this.#palette[0],this.#palette[0]=this.#transparentColor,this.#palette[P]=C),a=e[a].fw}}quantizeImage(){for(var t,r=this.opts.pixels,n=(this.opts.width,this.opts.height,this.opts.colors),e=(this.opts.dithering,this.opts.alphaThreshold&&(B=this.opts.alphaThreshold),this.clear(),d=!1,0),a=0;a<r.length;++a){var i=r[a]>>>24&255;i<224&&(0==i?(this.#transparentPixelIndex=a,d=!0,2<n?this.#transparentColor=r[a]:r[a]=this.#transparentColor):B<i&&++e)}return this.#hasSemiTransparency=v=0<e,n<=32?E=L=U=_=1:(E=S[0][0],L=S[0][1],U=S[0][2]),m=this.#transparentColor,this.#palette=new Uint32Array(n),2<n?this.#pnnquan(r,n):0<=this.#transparentPixelIndex?(this.#palette[0]=this.#transparentColor,this.#palette[1]=255<<24):(this.#palette[0]=255<<24,this.#palette[1]=4294967295),v&&(A*=-1),0<=this.#transparentPixelIndex&&2<this.#palette.length&&(t=this.getDitherFn()(this.#palette,r[this.#transparentPixelIndex],this.#transparentPixelIndex),this.#palette[t]=this.#transparentColor),{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),transparent:this.getTransparentIndex(),type:this.getImgType(),weight:A,weightB:1}}getPalette(){return this.#palette.buffer}getImgType(){return 256<this.opts.colors||this.#hasSemiTransparency?"image/png":"image/gif"}getTransparentIndex(){return-1<this.#transparentPixelIndex?0:-1}getDitherFn(){return this.opts.dithering?y:t}getColorIndex(t,r,n,e){return k(t,r,n,e,v,d)}getResult(){var n=this;return new Promise(function(t,r){t(n.quantizeImage())})}clear(){w=new Array(65536),I=new Uint16Array(65536)}}this.PnnQuant=N,"undefined"!=typeof module&&module.exports&&(module.exports=N)}.call(this);