!function(){"use strict";var d,E=15,m=!1,x=!1,L=.299,_=.587,S=.114,U=.3333,v=.5,w=new Map,I=new Map,k=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function M(t){return t*t}function q(t,r,e,n,a,s){return a?(240&t)<<8|(240&r)<<4|240&e|n>>4:s?(128&t)<<8|(248&r)<<7|(248&e)<<2|n>>3:(248&r)<<8|(252&e)<<3|n>>3}Math.clamp||(Math.clamp=function(t,r,e){return this.max(r,this.min(e,t))});class N{#hasSemiTransparency=!1;#palette=[];#weight;#transparentPixelIndex=-1;#transparentColor=16777215;constructor(t){this.opts=t}static PnnBin=class{constructor(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=this.err=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0}};#find_nn(t,r){var e=0,n=1e100,a=t[r],s=a.cnt,i=a.ac,h=a.rc,o=a.gc,l=a.bc,c=0;0<BlueNoise.TELL_BLUE_NOISE[4095&r]&&(c=_<k[0][1]?k.length:1);for(var p=a.fw;0!=p;p=t[p].fw){var g=t[p].cnt,u=s*g/(s+g);if(!(n<=u)){var f=0;if(!(x&&n<=(f+=u*U*M(t[p].ac-i))||n<=(f+=.5*u*L*M(t[p].rc-h))||n<=(f+=.5*u*_*M(t[p].gc-o))||n<=(f+=.5*u*S*M(t[p].bc-l)))){for(var d=c;d<k.length&&!(n<=(f+=u*v*M(k[d][0]*(t[p].rc-h))))&&!(n<=(f+=u*v*M(k[d][1]*(t[p].gc-o))))&&!(n<=(f+=u*v*M(k[d][2]*(t[p].bc-l))));++d);n=f,e=p}}}a.err=Math.fround(n),a.nn=e}#pnnquan(t,r){for(var e=1,n=new Array(65536),a=0;a<t.length;++a){var s=255&t[a],i=t[a]>>>8&255,h=t[a]>>>16&255,o=((B=t[a]>>>24&255)<=E&&(s=255&this.#transparentColor,i=this.#transparentColor>>>8&255,h=this.#transparentColor>>>16&255,B=this.#transparentColor>>>24&255),q(B,s,i,h,this.#hasSemiTransparency,r<64||0<=this.#transparentPixelIndex));null==n[o]&&(n[o]=new N.PnnBin),(v=n[o]).ac+=B,v.rc+=s,v.gc+=i,v.bc+=h,v.cnt+=1}for(var l=0,a=0;a<n.length;++a)null!=n[a]&&(P=1/n[a].cnt,n[a].ac*=P,n[a].rc*=P,n[a].gc*=P,n[a].bc*=P,n[l++]=n[a]);r<16&&(e=-1),this.#weight=Math.min(.9,+r/l),.003<this.#weight&&this.#weight<.005&&(e=0),this.#weight<.04&&_>=k[0][1]&&(L=_=S=U=1,64<=r)&&(e=0);c=r;for(var c,p,g,u=0<(e=e)?c<64?function(t){return Math.fround(Math.sqrt(t))}:function(t){return 0|Math.sqrt(t)}:e<0?function(t){return 0|Math.cbrt(t)}:function(t){return t},f=0;f<l-1;++f)n[f].fw=f+1,n[f+1].bk=f,n[f].cnt=u(n[f].cnt);n[f].cnt=u(n[f].cnt);for(var d=new Uint32Array(n.length+1),a=0;a<l;++a){this.#find_nn(n,a);for(var m=n[a].err,x=++d[0];1<x&&!(n[p=d[g=x>>1]].err<=m);x=g)d[x]=p;d[x]=a}for(var v,w=l-r,a=0;a<w;){for(;;){var I=d[1];if((v=n[I]).tm>=v.mtm&&n[v.nn].mtm<=v.tm)break;65535==v.mtm?I=d[1]=d[d[0]--]:(this.#find_nn(n,I),v.tm=a);m=n[I].err;for(x=1;(g=x+x)<=d[0]&&(g<d[0]&&n[d[g]].err>n[d[g+1]].err&&++g,!(m<=n[p=d[g]].err));x=g)d[x]=p;d[x]=I}var M=n[v.nn],C=v.cnt,b=M.cnt,P=Math.fround(1/(C+b));v.ac=P*Math.round(C*v.ac+b*M.ac),v.rc=P*Math.round(C*v.rc+b*M.rc),v.gc=P*Math.round(C*v.gc+b*M.gc),v.bc=P*Math.round(C*v.bc+b*M.bc),v.cnt+=b,v.mtm=++a,n[M.bk].fw=M.fw,n[M.fw].bk=M.bk,M.mtm=65535}this.#palette=new Uint32Array(0<w?r:l);for(var y=0,a=0;y<this.#palette.length;++y){var T,B=0|Math.clamp(n[a].ac,0,255),s=0|Math.clamp(n[a].rc,0,255),i=0|Math.clamp(n[a].gc,0,255),h=0|Math.clamp(n[a].bc,0,255);this.#palette[y]=B<<24|h<<16|i<<8|s,0<=this.#transparentPixelIndex&&0==B&&(T=this.#palette[0],this.#palette[0]=this.#transparentColor,this.#palette[y]=T),a=n[a].fw}}quantizeImage(){for(var t,r=this.opts.pixels,e=(this.opts.width,this.opts.height,this.opts.colors),n=(this.opts.dithering,this.opts.alphaThreshold&&(E=this.opts.alphaThreshold),this.clear(),m=!1,0),a=0;a<r.length;++a){var s=r[a]>>>24&255;s<224&&(0==s?(this.#transparentPixelIndex=a,m=!0,2<e?this.#transparentColor=r[a]:r[a]=this.#transparentColor):E<s&&++n)}return this.#hasSemiTransparency=x=0<n,e<=32?L=_=S=U=1:(L=k[0][0],_=k[0][1],S=k[0][2]),d=this.#transparentColor,this.#palette=new Uint32Array(e),2<e?this.#pnnquan(r,e):0<=this.#transparentPixelIndex?(this.#palette[0]=this.#transparentColor,this.#palette[1]=255<<24):(this.#palette[0]=255<<24,this.#palette[1]=4294967295),x&&(this.#weight*=-1),0<=this.#transparentPixelIndex&&2<this.#palette.length&&(t=this.getDitherFn()(this.#palette,r[this.#transparentPixelIndex],this.#transparentPixelIndex),this.#palette[t]=this.#transparentColor),{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),transparent:this.getTransparentIndex(),type:this.getImgType(),weight:this.#weight,weightB:1}}#nearestColorIndex(t,r,e){var n=0,a=r>>>24&255,s=(a<=E&&(a=(r=d)>>>24&255),I.get(r));if(I.has(r))return s;2<t.length&&m&&E<a&&(n=1);for(var i=255&r,h=r>>>8&255,o=r>>>16&255,l=L,c=_,p=S,g=(2<t.length&&-88<BlueNoise.TELL_BLUE_NOISE[4095&e]&&(l=k[0][0],c=k[0][1],p=k[0][2]),1e100),u=n;u<t.length;u++){var f=U*M((t[u]>>>24&255)-a);g<f||g<(f+=l*M((255&t[u])-i))||g<(f+=c*M((t[u]>>>8&255)-h))||g<(f+=p*M((t[u]>>>16&255)-o))||(g=f,n=u)}return I.set(r,n),n}#closestColorIndex(t,r,e){var n=r>>>24&255;if(n<=E)return this.#nearestColorIndex(t,r,e);var a=255&r,s=r>>>8&255,i=r>>>16&255,h=w.get(r);if(!w.has(r)){(h=new Uint32Array(4))[2]=h[3]=65535;var o=L,l=_,c=S;-88<BlueNoise.TELL_BLUE_NOISE[4095&e]&&(o=k[0][0],l=k[0][1],c=k[0][2]);for(var p=0;p<t.length;++p){var g=o*M((255&t[p])-a);g>=h[3]||(g+=l*M((t[p]>>>8&255)-s))>=h[3]||(g+=c*M((t[p]>>>16&255)-i))>=h[3]||(x&&(g+=U*M((t[p]>>>24&255)-n)),g<h[2]?(h[1]=h[0],h[3]=h[2],h[0]=p,h[2]=0|g):g<h[3]&&(h[1]=p,h[3]=0|g))}65535==h[3]&&(h[1]=h[0]),w.set(r,h)}var u=t.length<<2,f=(e+1)%2;return.67*h[3]<h[3]-h[2]?f=0:h[0]>h[1]&&(f=e%2),h[f+2]>=u||m&&0==h[f+2]?this.#nearestColorIndex(t,r,e):h[f]}getPalette(){return this.#palette.buffer}getImgType(){return 256<this.opts.colors||this.#hasSemiTransparency?"image/png":"image/gif"}getTransparentIndex(){return-1<this.#transparentPixelIndex?0:-1}getDitherFn(){return this.opts.dithering?this.#nearestColorIndex:this.#closestColorIndex}getColorIndex(t,r,e,n){return q(t,r,e,n,x,m)}getResult(){var e=this;return new Promise(function(t,r){t(e.quantizeImage())})}clear(){w=new Map,I=new Map}}this.PnnQuant=N,"undefined"!=typeof module&&module.exports&&(module.exports=N)}.call(this);