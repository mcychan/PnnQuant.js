!function(){function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[],this.qPixels=[]}Math.clamp||(Math.clamp=function(t,e,r){return this.max(e,this.min(r,t))});var g,E=15,d=!1,x=!1,L=.299,q=.587,S=.114,U=.3333,v=.5,y=new Map,I=new Map,k=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function A(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=this.err=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0}function B(t,e,r,n,a,i){return a?(240&t)<<8|(240&e)<<4|240&r|n>>4:i?(128&t)<<8|(248&e)<<7|(248&r)<<2|n>>3:(248&e)<<8|(252&r)<<3|n>>3}function _(t){return t*t}function F(t,e){var r=0,n=1e100,a=t[e],i=a.cnt,s=a.ac,h=a.rc,o=a.gc,p=a.bc,l=0;0<TELL_BLUE_NOISE[4095&e]&&(l=q<k[0][1]?k.length:1);for(var c=a.fw;0!=c;c=t[c].fw){var m=t[c].cnt,u=i*m/(i+m);if(!(n<=u)){var f=0;if(!(x&&n<=(f+=u*U*_(t[c].ac-s))||n<=(f+=u*(1-v)*L*_(t[c].rc-h))||n<=(f+=u*(1-v)*q*_(t[c].gc-o))||n<=(f+=u*(1-v)*S*_(t[c].bc-p)))){for(var g=l;g<k.length&&!(n<=(f+=u*v*_(k[g][0]*(t[c].rc-h))))&&!(n<=(f+=u*v*_(k[g][1]*(t[c].gc-o))))&&!(n<=(f+=u*v*_(k[g][2]*(t[c].bc-p))));++g);n=f,r=c}}}a.err=Math.fround(n),a.nn=r}function w(t,e,r){var n=0,a=e>>>24&255,i=(a<=E&&(a=(e=g)>>>24&255),I.get(e));if(I.has(e))return i;2<t.length&&d&&E<a&&(n=1);for(var s=255&e,h=e>>>8&255,o=e>>>16&255,p=L,l=q,c=S,m=(2<t.length&&-88<TELL_BLUE_NOISE[4095&r]&&(p=k[0][0],l=k[0][1],c=k[0][2]),1e100),u=n;u<t.length;u++){var f=U*_((t[u]>>>24&255)-a);m<f||m<(f+=p*_((255&t[u])-s))||m<(f+=l*_((t[u]>>>8&255)-h))||m<(f+=c*_((t[u]>>>16&255)-o))||(m=f,n=u)}return I.set(e,n),n}function e(t,e,r){var n=e>>>24&255;if(n<=E)return w(t,e,r);var a=255&e,i=e>>>8&255,s=e>>>16&255,h=y.get(e);if(!y.has(e)){(h=new Uint32Array(4))[2]=h[3]=65535;var o=L,p=q,l=S;-88<TELL_BLUE_NOISE[4095&r]&&(o=k[0][0],p=k[0][1],l=k[0][2]);for(var c=0;c<t.length;++c){var m=o*_((255&t[c])-a);m>=h[3]||(m+=p*_((t[c]>>>8&255)-i))>=h[3]||(m+=l*_((t[c]>>>16&255)-s))>=h[3]||(x&&(m+=U*_((t[c]>>>24&255)-n)),m<h[2]?(h[1]=h[0],h[3]=h[2],h[0]=c,h[2]=0|m):m<h[3]&&(h[1]=c,h[3]=0|m))}65535==h[3]&&(h[1]=h[0]),y.set(e,h)}var u=t.length<<2,f=(r+1)%2;return.67*h[3]<h[3]-h[2]?f=0:h[0]>h[1]&&(f=r%2),h[f+2]>=u||d&&0==h[f+2]?w(t,e,r):h[f]}t.prototype.pnnquan=function(t,e){this.clear();for(var r=1,n=new Array(65536),a=0;a<t.length;++a){var i=255&t[a],s=t[a]>>>8&255,h=t[a]>>>16&255,o=((C=t[a]>>>24&255)<=E&&(i=255&this.m_transparentColor,s=this.m_transparentColor>>>8&255,h=this.m_transparentColor>>>16&255,C=this.m_transparentColor>>>24&255),B(C,i,s,h,this.hasSemiTransparency,e<64||0<=this.m_transparentPixelIndex));null==n[o]&&(n[o]=new A),(v=n[o]).ac+=C,v.rc+=i,v.gc+=s,v.bc+=h,v.cnt+=1}for(var p=0,a=0;a<n.length;++a)null!=n[a]&&(M=1/n[a].cnt,n[a].ac*=M,n[a].rc*=M,n[a].gc*=M,n[a].bc*=M,n[p++]=n[a]);e<16&&(r=-1);for(var l,c,m=this.opts.weight=Math.min(.9,+e/p),u=(.003<m&&m<.005&&(r=0),m<.04&&q>=k[0][1]&&(L=q=S=U=1,64<=e)&&(r=0),m=e,0<(r=r)?m<64?function(t){return Math.fround(Math.sqrt(t))}:function(t){return 0|Math.sqrt(t)}:r<0?function(t){return 0|Math.cbrt(t)}:function(t){return t}),f=0;f<p-1;++f)n[f].fw=f+1,n[f+1].bk=f,n[f].cnt=u(n[f].cnt);n[f].cnt=u(n[f].cnt);for(var g=new Uint32Array(n.length+1),a=0;a<p;++a){F(n,a);for(var d=n[a].err,x=++g[0];1<x&&!(n[l=g[c=x>>1]].err<=d);x=c)g[x]=l;g[x]=a}for(var v,y=p-e,a=0;a<y;){for(;;){var I=g[1];if((v=n[I]).tm>=v.mtm&&n[v.nn].mtm<=v.tm)break;65535==v.mtm?I=g[1]=g[g[0]--]:(F(n,I),v.tm=a);d=n[I].err;for(x=1;(c=x+x)<=g[0]&&(c<g[0]&&n[g[c]].err>n[g[c+1]].err&&++c,!(d<=n[l=g[c]].err));x=c)g[x]=l;g[x]=I}var _=n[v.nn],w=v.cnt,P=_.cnt,M=Math.fround(1/(w+P));v.ac=M*Math.round(w*v.ac+P*_.ac),v.rc=M*Math.round(w*v.rc+P*_.rc),v.gc=M*Math.round(w*v.gc+P*_.gc),v.bc=M*Math.round(w*v.bc+P*_.bc),v.cnt+=P,v.mtm=++a,n[_.bk].fw=_.fw,n[_.fw].bk=_.bk,_.mtm=65535}this.palette=new Uint32Array(0<y?e:p);for(var b=0,a=0;b<this.palette.length;++b){var T,C=0|Math.clamp(n[a].ac,0,255),i=0|Math.clamp(n[a].rc,0,255),s=0|Math.clamp(n[a].gc,0,255),h=0|Math.clamp(n[a].bc,0,255);this.palette[b]=C<<24|h<<16|s<<8|i,0<=this.m_transparentPixelIndex&&0==C&&(T=this.palette[0],this.palette[0]=this.m_transparentColor,this.palette[b]=T),a=n[a].fw}},t.prototype.quantizeImage=function(){for(var t,e=this.opts.pixels,r=(this.opts.width,this.opts.height,this.opts.colors),n=(this.opts.dithering,this.opts.alphaThreshold&&(E=this.opts.alphaThreshold),y.clear(),I.clear(),d=!1,0),a=0;a<e.length;++a){var i=e[a]>>>24&255;i<224&&(0==i?(this.m_transparentPixelIndex=a,d=!0,2<r?this.m_transparentColor=e[a]:e[a]=this.m_transparentColor):E<i&&++n)}return this.hasSemiTransparency=x=0<n,r<=32?L=q=S=U=1:(L=k[0][0],q=k[0][1],S=k[0][2]),g=this.m_transparentColor,this.palette=new Uint32Array(r),2<r?this.pnnquan(e,r):0<=this.m_transparentPixelIndex?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),this.opts.dithering||(this.opts.weightB=1),x&&(this.opts.weight*=-1),0<=this.m_transparentPixelIndex&&2<this.palette.length&&(t=this.getDitherFn()(this.palette,e[this.m_transparentPixelIndex],this.m_transparentPixelIndex),this.palette[t]=this.m_transparentColor),this.opts.ditherFn=this.getDitherFn(),this.opts.getColorIndex=this.getColorIndex,this.opts.palette=this.palette,this.palette},t.prototype.getIndexedPixels=function(){return this.qPixels},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return 256<this.opts.colors||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return-1<this.m_transparentPixelIndex?0:-1},t.prototype.getDitherFn=function(){return this.opts.dithering?w:e},t.prototype.getColorIndex=function(t,e,r,n){return B(t,e,r,n,this.hasSemiTransparency,0<=this.m_transparentPixelIndex)},t.prototype.getResult=function(){var n=this;return new Promise(function(t,e){var r=n.quantizeImage();n.opts.paletteOnly?t({pal8:r,indexedPixels:n.getIndexedPixels(),transparent:n.getTransparentIndex(),type:n.getImgType()}):t({img8:r,pal8:n.getPalette(),indexedPixels:n.getIndexedPixels(),transparent:n.getTransparentIndex(),type:n.getImgType()})})},t.prototype.clear=function(){y&&y.clear(),I&&I.clear()},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);