!function(){"use strict";function t(t){this.opts=t,this.hasSemiTransparency=!1,this.m_transparentPixelIndex=-1,this.m_transparentColor=16777215,this.palette=[]}Math.clamp||(Math.clamp=function(t,r,n){return this.max(r,this.min(n,t))});var g,E,L=15,d=!1,v=!1,S=.299,U=.587,k=.114,q=.3333,x=.5,_=new Map,w=new Map,A=[[.299,.587,.114],[-.14713,-.28886,.436],[.615,-.51499,-.10001]];function B(){this.ac=this.rc=this.gc=this.bc=0,this.cnt=this.err=0,this.nn=this.fw=this.bk=this.tm=this.mtm=0}function F(t,r,n,e,a,i){return a?(240&t)<<8|(240&r)<<4|240&n|e>>4:i?(128&t)<<8|(248&r)<<7|(248&n)<<2|e>>3:(248&r)<<8|(252&n)<<3|e>>3}function y(t){return t*t}function D(t,r){var n=0,e=1e100,a=t[r],i=a.cnt,s=a.ac,h=a.rc,o=a.gc,p=a.bc,c=0;0<TELL_BLUE_NOISE[4095&r]&&(c=U<A[0][1]?A.length:1);for(var l=a.fw;0!=l;l=t[l].fw){var u=t[l].cnt,f=i*u/(i+u);if(!(e<=f)){var m=0;if(!(v&&e<=(m+=f*q*y(t[l].ac-s))||e<=(m+=f*(1-x)*S*y(t[l].rc-h))||e<=(m+=f*(1-x)*U*y(t[l].gc-o))||e<=(m+=f*(1-x)*k*y(t[l].bc-p)))){for(var g=c;g<A.length&&!(e<=(m+=f*x*y(A[g][0]*(t[l].rc-h))))&&!(e<=(m+=f*x*y(A[g][1]*(t[l].gc-o))))&&!(e<=(m+=f*x*y(A[g][2]*(t[l].bc-p))));++g);e=m,n=l}}}a.err=Math.fround(e),a.nn=n}function I(t,r,n){var e=0,a=r>>>24&255,i=(a<=L&&(a=(r=g)>>>24&255),w.get(r));if(w.has(r))return i;2<t.length&&d&&L<a&&(e=1);for(var s=255&r,h=r>>>8&255,o=r>>>16&255,p=S,c=U,l=k,u=(2<t.length&&-88<TELL_BLUE_NOISE[4095&n]&&(p=A[0][0],c=A[0][1],l=A[0][2]),1e100),f=e;f<t.length;f++){var m=q*y((t[f]>>>24&255)-a);u<m||u<(m+=p*y((255&t[f])-s))||u<(m+=c*y((t[f]>>>8&255)-h))||u<(m+=l*y((t[f]>>>16&255)-o))||(u=m,e=f)}return w.set(r,e),e}function r(t,r,n){var e=r>>>24&255;if(e<=L)return I(t,r,n);var a=255&r,i=r>>>8&255,s=r>>>16&255,h=_.get(r);if(!_.has(r)){(h=new Uint32Array(4))[2]=h[3]=65535;var o=S,p=U,c=k;-88<TELL_BLUE_NOISE[4095&n]&&(o=A[0][0],p=A[0][1],c=A[0][2]);for(var l=0;l<t.length;++l){var u=o*y((255&t[l])-a);u>=h[3]||(u+=p*y((t[l]>>>8&255)-i))>=h[3]||(u+=c*y((t[l]>>>16&255)-s))>=h[3]||(v&&(u+=q*y((t[l]>>>24&255)-e)),u<h[2]?(h[1]=h[0],h[3]=h[2],h[0]=l,h[2]=0|u):u<h[3]&&(h[1]=l,h[3]=0|u))}65535==h[3]&&(h[1]=h[0]),_.set(r,h)}var f=t.length<<2,m=(n+1)%2;return.67*h[3]<h[3]-h[2]?m=0:h[0]>h[1]&&(m=n%2),h[m+2]>=f||d&&0==h[m+2]?I(t,r,n):h[m]}t.prototype.pnnquan=function(t,r){for(var n=1,e=new Array(65536),a=0;a<t.length;++a){var i=255&t[a],s=t[a]>>>8&255,h=t[a]>>>16&255,o=((T=t[a]>>>24&255)<=L&&(i=255&this.m_transparentColor,s=this.m_transparentColor>>>8&255,h=this.m_transparentColor>>>16&255,T=this.m_transparentColor>>>24&255),F(T,i,s,h,this.hasSemiTransparency,r<64||0<=this.m_transparentPixelIndex));null==e[o]&&(e[o]=new B),(x=e[o]).ac+=T,x.rc+=i,x.gc+=s,x.bc+=h,x.cnt+=1}for(var p=0,a=0;a<e.length;++a)null!=e[a]&&(b=1/e[a].cnt,e[a].ac*=b,e[a].rc*=b,e[a].gc*=b,e[a].bc*=b,e[p++]=e[a]);r<16&&(n=-1),.003<(E=Math.min(.9,+r/p))&&E<.005&&(n=0),E<.04&&U>=A[0][1]&&(S=U=k=q=1,64<=r)&&(n=0);c=r;for(var c,l,u,f=0<(n=n)?c<64?function(t){return Math.fround(Math.sqrt(t))}:function(t){return 0|Math.sqrt(t)}:n<0?function(t){return 0|Math.cbrt(t)}:function(t){return t},m=0;m<p-1;++m)e[m].fw=m+1,e[m+1].bk=m,e[m].cnt=f(e[m].cnt);e[m].cnt=f(e[m].cnt);for(var g=new Uint32Array(e.length+1),a=0;a<p;++a){D(e,a);for(var d=e[a].err,v=++g[0];1<v&&!(e[l=g[u=v>>1]].err<=d);v=u)g[v]=l;g[v]=a}for(var x,_=p-r,a=0;a<_;){for(;;){var w=g[1];if((x=e[w]).tm>=x.mtm&&e[x.nn].mtm<=x.tm)break;65535==x.mtm?w=g[1]=g[g[0]--]:(D(e,w),x.tm=a);d=e[w].err;for(v=1;(u=v+v)<=g[0]&&(u<g[0]&&e[g[u]].err>e[g[u+1]].err&&++u,!(d<=e[l=g[u]].err));v=u)g[v]=l;g[v]=w}var y=e[x.nn],I=x.cnt,M=y.cnt,b=Math.fround(1/(I+M));x.ac=b*Math.round(I*x.ac+M*y.ac),x.rc=b*Math.round(I*x.rc+M*y.rc),x.gc=b*Math.round(I*x.gc+M*y.gc),x.bc=b*Math.round(I*x.bc+M*y.bc),x.cnt+=M,x.mtm=++a,e[y.bk].fw=y.fw,e[y.fw].bk=y.bk,y.mtm=65535}this.palette=new Uint32Array(0<_?r:p);for(var C=0,a=0;C<this.palette.length;++C){var P,T=0|Math.clamp(e[a].ac,0,255),i=0|Math.clamp(e[a].rc,0,255),s=0|Math.clamp(e[a].gc,0,255),h=0|Math.clamp(e[a].bc,0,255);this.palette[C]=T<<24|h<<16|s<<8|i,0<=this.m_transparentPixelIndex&&0==T&&(P=this.palette[0],this.palette[0]=this.m_transparentColor,this.palette[C]=P),a=e[a].fw}},t.prototype.quantizeImage=function(){for(var t,r=this.opts.pixels,n=(this.opts.width,this.opts.height,this.opts.colors),e=(this.opts.dithering,this.opts.alphaThreshold&&(L=this.opts.alphaThreshold),this.clear(),d=!1,0),a=0;a<r.length;++a){var i=r[a]>>>24&255;i<224&&(0==i?(this.m_transparentPixelIndex=a,d=!0,2<n?this.m_transparentColor=r[a]:r[a]=this.m_transparentColor):L<i&&++e)}return this.hasSemiTransparency=v=0<e,n<=32?S=U=k=q=1:(S=A[0][0],U=A[0][1],k=A[0][2]),g=this.m_transparentColor,this.palette=new Uint32Array(n),2<n?this.pnnquan(r,n):0<=this.m_transparentPixelIndex?(this.palette[0]=this.m_transparentColor,this.palette[1]=255<<24):(this.palette[0]=255<<24,this.palette[1]=4294967295),v&&(E*=-1),0<=this.m_transparentPixelIndex&&2<this.palette.length&&(t=this.getDitherFn()(this.palette,r[this.m_transparentPixelIndex],this.m_transparentPixelIndex),this.palette[t]=this.m_transparentColor),{getColorIndex:this.getColorIndex,ditherFn:this.getDitherFn(),pal8:this.getPalette(),transparent:this.getTransparentIndex(),type:this.getImgType(),weight:E,weightB:1}},t.prototype.getPalette=function(){return this.palette.buffer},t.prototype.getImgType=function(){return 256<this.opts.colors||this.hasSemiTransparency?"image/png":"image/gif"},t.prototype.getTransparentIndex=function(){return-1<this.m_transparentPixelIndex?0:-1},t.prototype.getDitherFn=function(){return this.opts.dithering?I:r},t.prototype.getColorIndex=function(t,r,n,e){return F(t,r,n,e,v,d)},t.prototype.getResult=function(){var n=this;return new Promise(function(t,r){t(n.quantizeImage())})},t.prototype.clear=function(){_=new Map,w=new Map},this.PnnQuant=t,"undefined"!=typeof module&&module.exports&&(module.exports=t)}.call(this);